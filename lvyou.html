<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title id="page-title">行程规划</title>
  <!-- Font Awesome CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- 天气emoji容器样式 -->
  <style>
    /* 天气emoji容器透明度设置 */
    .weather-emoji-container {
      opacity: 0.2; /* PC端透明度 */
      z-index: 1; /* 较低层级，作为背景 */
    }
    
    /* 移动端媒体查询 */
    @media (max-width: 768px) {
      .weather-emoji-container {
        opacity: 0.4; /* 移动端透明度更高 */
      }
    }
    
    /* 确保内容元素显示在上层 */
    .weather-gradient-container .flex.flex-wrap.items-center.gap-x-2.justify-center,
    .weather-gradient-container .text-base.font-medium.text-white.editable.text-center.mb-2,
    .weather-gradient-container h3.text-xl.font-bold.editable.text-center {
      position: relative;
      z-index: 10; /* 更高层级，确保显示在emoji容器上层 */
    }
  </style>
  
  <!-- 行程信息配置区 - 在页面顶部统一配置 -->
  <script>
    // 功能控制开关 - true表示显示所有路线方案，false表示应用隐藏逻辑
    const showAllRoutePlans = false;
    
    // 高德地图API调用控制开关 - 测试期间请设置为false以节省API额度
    window.AMAP_API_CONFIG = {
      // 是否启用POI搜索API调用
      enablePOISearch: false, // 测试期间禁用POI搜索API
      // 是否启用天气API调用
      enableWeatherAPI: false, // 测试期间禁用天气API
      // 是否启用路线查询API调用
      enableRouteAPI: false, // 测试期间禁用路线查询API
      // 是否启用地图加载
      enableMapLoading: true, // 测试期间禁用地图加载
      // 是否启用地理编码API调用
      enableGeocodeAPI: true // 测试期间禁用地理编码API
    };
    
    // 创建标记点映射，用于快速查找（全局变量）
    const markerMap = new Map();
    
    // 显示地点信息函数（全局函数）
    function showLocationInfo(locationName, position) {
      // 简化选择器，确保能正确找到p标签
      const infoParagraph = document.getElementById('map-info-paragraph');
      if (!infoParagraph) {
        console.error('未能找到显示信息的p标签');
        return;
      }
      
      // 查找对应的emoji
      let emoji = '📍'; // 默认emoji
      
      // 从accommodations中查找对应的地点获取emoji
      for (let accommodationGroup of tripConfig.accommodations) {
        for (let item of accommodationGroup.items) {
          if (item.location === locationName && item.emoji) {
            emoji = item.emoji;
            break;
          }
        }
      }
      
      // 从tripConfig中查找对应的地点信息
      let foundLocation = null;
      let locationInfo = {
        scenicLevel: '',
        address: '',
        phoneNumbers: ''
      };
      
      // 先在第一天行程中查找
      const day1Array = Array.isArray(tripConfig.itineraryDetailsDay1) ? tripConfig.itineraryDetailsDay1 : [];
      for (let item of day1Array) {
        if (item.location === locationName) {
          foundLocation = item;
          break;
        }
      }
      
      // 如果第一天没找到，在第二天行程中查找
      if (!foundLocation) {
        const day2Array = Array.isArray(tripConfig.itineraryDetailsDay2) ? tripConfig.itineraryDetailsDay2 : [];
        for (let item of day2Array) {
          if (item.location === locationName) {
            foundLocation = item;
            break;
          }
        }
      }
      
      // 如果在行程中没找到，再从accommodations中查找详情
      if (!foundLocation) {
        for (let accommodationGroup of tripConfig.accommodations) {
          for (let item of accommodationGroup.items) {
            if (item.location === locationName) {
              foundLocation = item;
              break;
            }
          }
        }
      }
      
      // 如果找到对应的地点信息，更新locationInfo
      if (foundLocation) {
        if (foundLocation.scenicLevel) {
          locationInfo.scenicLevel = foundLocation.scenicLevel;
        }
        if (foundLocation.address) {
          locationInfo.address = foundLocation.address;
        }
        if (foundLocation.phoneNumbers) {
          locationInfo.phoneNumbers = foundLocation.phoneNumbers;
        }
      }
      
      // 构建景点信息内容，包含响应式换行样式
      let infoContent = `<div class="location-info-line"><span class="mr-1 text-blue-500">${emoji}</span><strong>${locationName}</strong></div>`;
      
      // 显示地址信息
      infoContent += `<div class="location-info-line"><span class="mr-1 text-blue-500">🗺️</span>地址：${locationInfo.address}</div>`;
      
      // 更新p标签内容
      infoParagraph.innerHTML = infoContent;
    }
    
    // 行程基本信息配置
    const tripConfig = {
  "city": "福州",
  "days": "一日游",
  "daysNumber": 1,
  "personCount": "1",
  "departure": {
    "city": "未提供",
    "weather": "晴",
    "temperature": "12°C~23°C",
    "transport": "飞机",
    "date": "2025年12月7日",
    "summary": "亲爱的旅行者，2025年12月7日 厦门出发体感良好～ 晴为主，气温 12°C~23°C，建议轻便外套、舒适鞋，备折叠伞与充电宝。"
  },
  "day1": {
    "date": "2025年12月7日",
    "weather": "晴",
    "temperature": "12°C~23°C",
    "windDirection": "东北风",
    "windForce": "软风",
    "tourTips": "上午晴朗适合拍照，下午多云带把遮阳伞，傍晚可观赏夕阳，晚上温度适宜夜游。",
    "adviceCard": {
      "title":
        "🏝️旅游天气建议",
      "summary": "亲爱的旅行者，2025年12月7日 福州超适合出游～ 晴为主，气温 12°C~23°C，东北风软风，逛吃赏景体感舒适～",
      "sections": [
        {
          "title": "👔 穿衣",
          "items": [
            "洋葱式穿法：长袖打底 + 薄针织衫 + 轻便防风外套，热脱冷穿适配温差",
            "舒适平底鞋 / 运动鞋，方便全天出行"
          ]
        },
        {
          "title": "🧳 必备",
          "items": [
            "便携折叠伞（应对小雨 + 遮阳）、温水、纸巾 + 湿巾、充电宝 + 数据线、轻薄防晒",
            "可选薄围巾（傍晚保暖）"
          ]
        },
        {
          "title": "📝 小提醒",
          "items": [
            "遇小雨可往三坊七巷文创店、茶馆避雨，灵活调整行程",
            "傍晚登烟台山记得穿外套，山顶风稍大"
          ]
        }
      ]
    }
  },
  "accommodations": [
    {
      "title": "三坊七巷周边",
      "id": "accommodation1",
      "items": [
        {
          "location": "福州悦华酒店",
          "locationCoords": {
            "lng": 119.290898,
            "lat": 26.098409
          },
          "scenicLevel": "五星级",
          "address": "福州市鼓楼区华林路11号",
          "phoneNumbers": "",
          "description": "交通便利，设施齐全",
          "emoji": "🏨"
        },
        {
          "location": "福建外贸中心悦华酒店(三坊七巷店)",
          "locationCoords": {
            "lng": 119.30472,
            "lat": 26.08849
          },
          "scenicLevel": "高档酒店",
          "address": "福州市五四路73号",
          "phoneNumbers": "",
          "description": "设施齐全",
          "emoji": "🏢"
        }
      ]
    }
  ],
  "nearbyAttractions": [
    {
      "title": "福州市区周边",
      "id": "nearby1",
      "items": [
        {
          "location": "福州国家森林公园",
          "locationCoords": {
            "lng": 119.28625,
            "lat": 26.161579
          },
          "scenicLevel": "AAAA",
          "address": "福州市晋安区新店上赤桥",
          "phoneNumbers": "",
          "description": "城市绿肺，环境优美，适合休闲散步",
          "emoji": "🌲"
        },
        {
          "location": "西湖公园",
          "locationCoords": {
            "lng": 119.289152,
            "lat": 26.092037
          },
          "scenicLevel": "",
          "address": "福州市鼓楼区湖滨路70号",
          "phoneNumbers": "",
          "description": "福州著名公园，湖光山色，适合休闲漫步",
          "emoji": "🏞️"
        }
      ]
    }
  ],
  "foods": [
    {
      "name": "佛跳墙",
      "description": "闽菜经典，高级汤品"
    },
    {
      "name": "福州鱼丸",
      "description": "Q弹鲜美，街头名吃"
    },
    {
      "name": "锅边糊",
      "description": "早餐必备，清爽可口"
    },
    {
      "name": "荔枝肉",
      "description": "福州特色菜，酸甜可口"
    }
  ],
  "restaurants": [
    {
      "location": "聚春园",
      "description": "百年老字号，佛跳墙正宗"
    },
    {
      "location": "安泰楼酒家",
      "description": "传统闽菜，地道风味"
    },
    {
      "location": "钦榕大酒家",
      "description": "福州特色菜，口味地道"
    }
  ],
  "itineraryDetailsDay1": [
    {
      "startTime": "07:30",
      "endTime": "08:30",
      "weather": "晴",
      "temperature": "18℃",
      "activity": "品尝特色捞化",
      "location": "福屿鲜捞小吃(福屿捞化总店)",
      "locationCoords": {
        "lng": 119.282753,
        "lat": 26.07578
      },
      "locationName": "📍",
      "scenicLevel": "4A",
      "address": "福屿路福屿小区2号楼2店面",
      "phoneNumbers": "",
      "notes": "品尝福州传统特色捞化早餐，体验地道闽味小吃文化，感受福州人的早餐习惯",
      "icon": "🚩",
      "locationLabel": "游览",
      "routes": {
        "subway": {
          "totalTime": "15",
          "steps": [
            "🚶‍♂️ 步行前往下一站点"
          ]
        },
        "bus": {
          "totalTime": "20",
          "steps": [
            "🚌 乘坐公交前往下一站点"
          ]
        },
        "walk": {
          "totalTime": "25",
          "steps": [
            "🚶‍♂️ 步行前往"
          ]
        }
      }
    },
    {
      "startTime": "09:00",
      "endTime": "12:00",
      "weather": "晴",
      "temperature": "20℃",
      "activity": "游览历史文化街区",
      "location": "三坊七巷",
      "locationCoords": {
        "lng": 119.296623,
        "lat": 26.081958
      },
      "locationName": "📍",
      "scenicLevel": "4A",
      "address": "文儒坊6号",
      "phoneNumbers": "",
      "notes": "游览福州最具代表性的历史文化街区，参观明清时期的古建筑群和名人故居，感受深厚的闽都文化底蕴",
      "icon": "🚩",
      "locationLabel": "游览",
      "routes": {
        "subway": {
          "totalTime": "15",
          "steps": [
            "🚶‍♂️ 步行前往下一站点"
          ]
        },
        "bus": {
          "totalTime": "20",
          "steps": [
            "🚌 乘坐公交前往下一站点"
          ]
        },
        "walk": {
          "totalTime": "25",
          "steps": [
            "🚶‍♂️ 步行前往"
          ]
        }
      }
    },
    {
      "startTime": "12:30",
      "endTime": "13:30",
      "weather": "晴",
      "temperature": "22℃",
      "activity": "品尝地道闽菜",
      "location": "安泰楼酒家(三坊七巷店)",
      "locationCoords": {
        "lng": 119.300361,
        "lat": 26.080774
      },
      "locationName": "📍",
      "scenicLevel": "4A",
      "address": "吉庇路1号(南门兜地铁站S4口步行220米)",
      "phoneNumbers": "",
      "notes": "品尝福州传统闽菜，体验百年老字号的烹饪技艺，感受福州饮食文化的独特魅力",
      "icon": "🚩",
      "locationLabel": "游览",
      "routes": {
        "subway": {
          "totalTime": "15",
          "steps": [
            "🚶‍♂️ 步行前往下一站点"
          ]
        },
        "bus": {
          "totalTime": "20",
          "steps": [
            "🚌 乘坐公交前往下一站点"
          ]
        },
        "walk": {
          "totalTime": "25",
          "steps": [
            "🚶‍♂️ 步行前往"
          ]
        }
      }
    },
    {
      "startTime": "14:00",
      "endTime": "17:00",
      "weather": "晴",
      "temperature": "21℃",
      "activity": "登山观景览胜",
      "location": "福州市鼓山旅游景区",
      "locationCoords": {
        "lng": 119.386904,
        "lat": 26.049802
      },
      "locationName": "📍",
      "scenicLevel": "4A",
      "address": "福马路1027号",
      "phoneNumbers": "",
      "notes": "登上福州著名风景区鼓山，欣赏城市全景和自然风光，体验登山健身的乐趣",
      "icon": "📷",
      "locationLabel": "拍照",
      "routes": {
        "subway": {
          "totalTime": "15",
          "steps": [
            "🚶‍♂️ 步行前往下一站点"
          ]
        },
        "bus": {
          "totalTime": "20",
          "steps": [
            "🚌 乘坐公交前往下一站点"
          ]
        },
        "walk": {
          "totalTime": "25",
          "steps": [
            "🚶‍♂️ 步行前往"
          ]
        }
      }
    },
    {
      "startTime": "18:00",
      "endTime": "19:00",
      "weather": "晴",
      "temperature": "19℃",
      "activity": "品尝佛跳墙",
      "location": "聚春园(南后街店)",
      "locationCoords": {
        "lng": 119.297156,
        "lat": 26.081769
      },
      "locationName": "📍",
      "scenicLevel": "4A",
      "address": "南后街45号",
      "phoneNumbers": "",
      "notes": "品尝福州名菜佛跳墙，体验闽菜经典的高级汤品，感受福州饮食文化的精髓",
      "icon": "🚩",
      "locationLabel": "游览"
    }
  ]
};
    
    // 页面加载时更新标题
    document.addEventListener('DOMContentLoaded', function() {
      // 更新页面标题
      document.getElementById('page-title').textContent = tripConfig.city + tripConfig.days + ' 行程规划';
    });
    
    // 更直接的方法：使用window.onload确保所有内容都已加载完成
    window.onload = function() {
      // 只有当天数为1时执行页面文本替换
      if (tripConfig.daysNumber === 1) {
        console.log('window.onload: 行程天数为1，执行文本替换');
        
        // 方法1：获取所有div元素并遍历
        const allDivs = document.getElementsByTagName('div');
        console.log(`找到 ${allDivs.length} 个div元素`);
        
        for (let i = 0; i < allDivs.length; i++) {
          const div = allDivs[i];
          const text = div.textContent.trim();
          
          if (text === '第1天') {
            console.log(`找到匹配的div元素，索引 ${i}，class: ${div.className}`);
            div.textContent = '一日游';
            console.log(`已替换div文本: ${text} -> 一日游`);
          }
        }
        
        // 新增：处理span元素
        const allSpans = document.getElementsByTagName('span');
        console.log(`找到 ${allSpans.length} 个span元素`);
        
        for (let i = 0; i < allSpans.length; i++) {
          const span = allSpans[i];
          const text = span.textContent.trim();
          
          if (text === '第1天') {
            console.log(`找到匹配的span元素，索引 ${i}，class: ${span.className}`);
            span.textContent = '一日游';
            console.log(`已替换span文本: ${text} -> 一日游`);
          }
        }
        
        // 方法2：使用更精确的选择器匹配用户选中的特定样式div
        const specialSelector = 'div[style*="border-radius: 12px"], div[style*="backdrop-filter"], div[class*="rounded-lg"]';
        const specialDivs = document.querySelectorAll(specialSelector);
        console.log(`找到 ${specialDivs.length} 个特殊样式div元素`);
        
        specialDivs.forEach(div => {
          if (div.textContent.trim() === '第1天') {
            console.log(`找到特殊样式的目标div: ${div.outerHTML}`);
            div.textContent = '一日游';
            console.log('已替换特殊样式div文本');
          }
        });
        
        // 方法3：直接使用querySelector查找所有包含"第1天"文本的元素
        console.log('尝试使用XPath查找元素...');
        try {
          const xpathResult = document.evaluate(
            "//div[text()='第1天']",
            document,
            null,
            XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,
            null
          );
          
          for (let i = 0; i < xpathResult.snapshotLength; i++) {
            const div = xpathResult.snapshotItem(i);
            console.log(`XPath找到目标div: ${div.outerHTML}`);
            div.textContent = '一日游';
            console.log('已通过XPath替换div文本');
          }
        } catch (e) {
          console.error('XPath执行错误:', e);
        }
        
        // 调试按钮已移除
        
        // 根据天气获取对应emoji
        function getWeatherEmoji(weather) {
          return WEATHER_EMOJI_MAP[weather] || '🔄'; // 使用全局映射，默认天气图标
        }

        // 动态生成行程表格内容
        function generateItineraryTable() {
          const tbody = document.getElementById('itinerary-tbody');
          if (!tbody) return;
          
          // 清空现有内容
          tbody.innerHTML = '';
          
          // 根据daysNumber获取对应的行程数组
          const itineraryArray = tripConfig[`itineraryDetailsDay${tripConfig.daysNumber}`] || [];
          
          // 检查是否有行程数据
          if (itineraryArray.length === 0) {
            const emptyRow = document.createElement('tr');
            emptyRow.innerHTML = '<td colspan="4" class="py-8 text-center text-gray-500">暂无行程安排</td>';
            tbody.appendChild(emptyRow);
            return;
          }
          
          // 遍历行程数据生成表格行
          itineraryArray.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50 transition-colors has-controls';
            
            // 创建单元格
            const weatherEmoji = getWeatherEmoji(item.weather);
            row.innerHTML = `
              <td class="py-4 px-2 editable text-center">
                <span style="font-weight: bold;">
                  <span class="block md:inline">${item.startTime}</span>
                  <span class="block md:inline mx-1">-</span>
                  <span class="block md:inline">${item.endTime}</span>
                </span><br>
                <span style="font-size: 0.9em;">${weatherEmoji} <span>${item.weather}</span> <span>${item.temperature}</span></span>
              </td>
              <td class="py-4 px-6 editable">${item.activity}</td>
              <td class="py-4 px-6 font-medium editable">
                <span style="font-weight: bold; cursor: pointer; text-decoration: underline; color: rgb(37, 99, 235);" onclick="navigateToAmap('${item.location}')">${item.location}</span>
              </td>
              <td class="py-4 px-6 editable">${item.notes || ''}</td>
            `;
            
            tbody.appendChild(row);
          });
        }
        
        // 调用函数生成行程表格
        generateItineraryTable();
      }
    };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script type="text/javascript" src="https://webapi.amap.com/maps?v=2.0&key=9fc145b7b1ba7bc1dcc7d8a50a6e96b2"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E88E5',
            secondary: '#64B5F6',
            accent: '#0D47A1',
            light: '#E3F2FD',
            dark: '#0D2B53'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
    
    // 为了测试磨砂玻璃效果，添加一个页面背景样式
    document.addEventListener('DOMContentLoaded', function() {
      document.body.classList.add('bg-gradient-to-br', 'from-blue-50', 'to-purple-50');
    });
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      #trip-info-card > div { font-size: 1rem; }
      #trip-info-card > div span { font-size: 1rem; }
      .card-shadow {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      }
      .hover-lift {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }
      .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      }
      .gradient-bg {
        background: linear-gradient(135deg, #1E88E5 0%, #64B5F6 100%);
      }
      .editable:hover {
        background-color: rgba(30, 136, 229, 0.05);
        cursor: text;
      }
      .edit-controls {
        opacity: 0;
        transition: opacity 0.3s ease;
      }
      .glass-effect {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        -moz-backdrop-filter: blur(10px);
        -o-backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.01);
        background-clip: padding-box;
        color: #333;
      }
      .has-controls:hover .edit-controls {
        opacity: 1;
      }
      /* 表格样式确保表头始终横向显示 */
      table thead {
        display: table-header-group !important;
      }
      table thead tr {
        display: table-row !important;
      }
      table thead th {
        display: table-cell !important;
        white-space: nowrap !important;
      }
      /* 确保在所有设备上表格都可以水平滚动 */
      .table-container {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch;
      }
      /* 移动端竖线分隔符样式 */
      .separator-line {
        display: inline-block;
      }
      @media (max-width: 768px) {
        .separator-line {
          display: block;
          width: 100%;
          height: 0;
          margin: 0;
          visibility: hidden;
        }
      }
      /* 隐藏地图控件中的ul元素 */
      .amap-ctrl-base-layer,
      .amap-ctrl-overlay-layer {
        display: none !important;
      }
      /* 景点信息容器样式，PC端和移动端都需要适当间距 */
      .location-info-line {
        display: inline-block;
        margin-right: 1.0rem; /* PC端右侧间距 */
        margin-bottom: 0.5rem; /* 统一的底部间距 */
      }
      @media (max-width: 768px) {
        .location-info-line {
          display: block;
          margin-right: 0; /* 移动端取消右侧间距 */
          margin-bottom: 0.35rem; /* 移动端稍微增大底部间距 */
        }
      }
      /* 移动端：日期块内 emoji+标签+首个日期保持同一行 */
      @media (max-width: 768px) {
        .date-block-nowrap {
          white-space: nowrap;
        }
        .date-first-line-nowrap {
          white-space: nowrap;
        }
      }
      /* 移除最后一个容器的右侧间距，避免多余的空白 */
      .location-info-line:last-child {
        margin-right: 0;
      }
      .weather-summary-card {
        border: 1px solid rgba(255, 255, 255, 0.25);
        box-shadow: 0 12px 24px rgba(13, 43, 83, 0.12), 0 8px 16px rgba(13, 43, 83, 0.08);
        position: relative;
      }
      .weather-summary-card::before {
        content: "";
        position: absolute;
        left: -30px;
        top: -30px;
        width: 140px;
        height: 140px;
        background: var(--memphisAccent, rgba(255, 255, 255, 0.6));
        opacity: 0.12;
        border-radius: 50%;
        z-index: 0;
      }
      .weather-summary-card::after {
        content: "";
        position: absolute;
        right: -24px;
        bottom: -24px;
        width: 160px;
        height: 90px;
        background: var(--memphisAccent, rgba(255, 255, 255, 0.6));
        opacity: 0.10;
        clip-path: polygon(0% 100%, 100% 100%, 60% 0%);
        transform: rotate(-6deg);
        z-index: 0;
      }
      .weather-summary-card * {
        position: relative;
        z-index: 1;
        font-weight: 700;
      }
      .weather-summary-card h3,
      .weather-summary-card p,
      .weather-summary-card .font-medium {
        background: var(--overlaySoft, rgba(255, 193, 7, 0.18));
        backdrop-filter: blur(2px);
        -webkit-backdrop-filter: blur(2px);
        border-radius: 8px;
        padding: 2px 8px;
        display: inline-block;
      }
      .weather-summary-card li {
        background: var(--overlaySofter, rgba(255, 193, 7, 0.14));
        border-radius: 6px;
        padding: 2px 6px;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800">
  <!-- 头部横幅 -->
  <header id="page-header" class="gradient-bg text-white py-4 md:py-5">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-3xl md:text-4xl font-bold mb-4 editable"><span id="city-name"></span><span id="trip-days"></span> 行程规划</h1>
      <div id="top-info-cards" class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2 text-center">
        <div id="departure-info-card" class="flex flex-col items-center text-center font-bold">
          <div class="text-base editable flex items-center"><span class="mr-1">📅</span>出发日期：<span id="departure-info-date"></span></div>
          <div class="text-base editable flex items-center"><span class="mr-1">🏁</span>出发城市：<span id="departure-info-city"></span></div>
          <div class="text-base editable flex items-center"><span id="departure-info-weather-emoji" class="mr-1"></span>当天天气：<span id="departure-info-weather"></span></div>
          <div class="text-base editable flex items-center"><span class="mr-1">🌡️</span>气温： <span id="departure-info-temp"></span></div>
          <div class="text-base editable flex items-center"><span id="departure-info-transport-emoji" class="mr-1"></span>出行方式：<span id="departure-info-transport"></span></div>
        </div>
        <div id="trip-info-card" class="flex flex-col items-center text-center font-bold">
          <div class="text-base editable flex items-center"><span id="trip-info-date-range"></span></div>
          <div class="text-base editable flex items-center"><span class="mr-1">📍</span>旅游城市：<span id="trip-info-city"></span></div>
          <div class="text-base editable flex items-center"><span id="trip-info-weather-emoji" class="mr-1"></span>当天天气：<span id="trip-info-weather"></span></div>
          <div class="text-base editable flex items-center"><span class="mr-1">🌡️</span>气温： <span id="trip-info-temp"></span></div>
        <div class="text-base flex items-center"><span class="editable">👤 出行人数：<span id="person-count"></span>人</span></div>
        </div>
      </div>
      <p id="departure-city-summary" class="mt-2 text-sm md:text-base leading-relaxed text-white font-bold"><span class="font-bold"><span class="mr-1">🧳</span> 出行天气建议：</span> 亲爱的旅行者，12 月 11 日福州超适合出游～ 阴天间多云为主，部分区县有零星小雨，气温 14℃~25℃（温差 11℃），东北风软风，空气质量优（AQI 25），逛吃赏景体感舒适～</p>
      
      <script>
        // 填充行程信息
        document.addEventListener('DOMContentLoaded', function() {
          document.getElementById('city-name').textContent = tripConfig.city;
          document.getElementById('trip-days').textContent = tripConfig.days;
          
          // 计算日期与星期（为卡片使用）
          const dateStr = tripConfig.day1 && tripConfig.day1.date || tripConfig.day1Date || '2025年10月29日';
          function getWeekdayLabel(dateString) {
            const m = dateString.match(/(\d+)年(\d+)月(\d+)日/);
            if (!m) return '';
            const y = parseInt(m[1]);
            const mo = parseInt(m[2]) - 1;
            const d = parseInt(m[3]);
            const dateObj = new Date(y, mo, d);
            const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            return weekdays[dateObj.getDay()];
          }
          
          // 调用初始化天气函数
          initializeWeather();
          document.getElementById('person-count').textContent = tripConfig.personCount;
          const personCountContainer = document.querySelector('#person-count') ? document.querySelector('#person-count').parentElement : null;
          if (personCountContainer) {
            const countNum = parseInt(String(tripConfig.personCount), 10);
            const pcEmoji = countNum > 1 ? '👥' : '👤';
            personCountContainer.innerHTML = `${pcEmoji} 出行人数：<span id="person-count">${tripConfig.personCount}</span>人`;
          }
          
          // 动态生成所有行程点及其路线方案
          function generateAllItineraryDetails() {
            const routeContainer = document.getElementById('route1-stops');
            if (!routeContainer) return;
            
            // 清空容器
            routeContainer.innerHTML = '';
            
            // 根据daysNumber获取对应的行程数组
            const itineraryArray = tripConfig[`itineraryDetailsDay${tripConfig.daysNumber}`] || [];
            
            // 遍历所有行程点
            itineraryArray.forEach((item, index) => {
              // 创建行程点容器
              const itineraryDiv = document.createElement('div');
              itineraryDiv.className = 'has-controls';
              
              // 设置行程点标题
              const icon = item.icon || '📍';
              const locationLabel = item.locationLabel || getLocationLabel(item.activity);
              
              itineraryDiv.innerHTML = `
                <h4 class="font-semibold text-primary mb-2 flex items-center">
                  <span class="mr-2">${icon}</span>
                  <span class="editable">${locationLabel}：<span style="font-weight: bold;">${item.location}</span><span class="text-gray-600">(<span>${item.startTime}</span>-<span>${item.endTime}</span>)</span></span>
                </h4>
              `;
              
              routeContainer.appendChild(itineraryDiv);
              
              // 只有当有下一个行程点时，才显示路线方案
              if (index < itineraryArray.length - 1 && item.routes) {
                // 创建路线方案容器
                const routeDiv = document.createElement('div');
                routeDiv.className = 'flex items-center text-gray-500 text-sm ml-6';
                
                // 生成路线HTML
                let routesHTML = `<span class="editable">`;
                
                // 地铁方案
                if (item.routes.subway) {
                  const subwayTitle = item.routes.subway.title || `🚇地铁方案（⏱️总耗时约${item.routes.subway.totalTime || 0}分钟）`;
                  routesHTML += `
                    <div class="route-plan subway-plan">
                      <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                        <strong>${subwayTitle}</strong>
                        <span class="toggle-icon">▼</span>
                      </div>
                      <div class="route-details" style="display: none;">
                        ${item.routes.subway.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                      </div>
                    </div>
                  `;
                }
                
                // 公交方案
                if (item.routes.bus) {
                  const busTitle = item.routes.bus.title || `🚌公交方案（⏱️总耗时约${item.routes.bus.totalTime || 0}分钟）`;
                  routesHTML += `
                    <div class="route-plan bus-plan">
                      <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                        <strong>${busTitle}</strong>
                        <span class="toggle-icon">▼</span>
                      </div>
                      <div class="route-details" style="display: none;">
                        ${item.routes.bus.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                      </div>
                    </div>
                  `;
                }
                
                // 步行方案
                if (item.routes.walk) {
                  const walkTitle = item.routes.walk.title || `🚶步行方案（⏱️总耗时约${item.routes.walk.totalTime || 0}分钟）`;
                  routesHTML += `
                    <div class="route-plan walk-plan">
                      <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                        <strong>${walkTitle}</strong>
                        <span class="toggle-icon">▼</span>
                      </div>
                      <div class="route-details" style="display: none;">
                        ${item.routes.walk.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                      </div>
                    </div>
                  `;
                }
                
                routesHTML += `</span>`;
                routeDiv.innerHTML = routesHTML;
                routeContainer.appendChild(routeDiv);
              }
            });
          }
          
          // 根据活动类型获取地点标签
          function getLocationLabel(activity) {
            const labelMap = {
              '早餐': '早餐',
              '午餐': '午餐',
              '晚餐': '晚餐',
              '漫步': '漫步',
              '游览': '游览',
              '观景': '观景',
              '咖啡休闲': '休闲'
            };
            return labelMap[activity] || '活动';
          }
          
        // 生成所有行程内容
          generateAllItineraryDetails();
          function updateDepartureWeather() {
            const dep = tripConfig && tripConfig.departure ? tripConfig.departure : {};
            const city = dep.city || '出发城市';
            const w = dep.weather || (tripConfig.day1 && tripConfig.day1.weather) || '';
            const t = dep.temperature || (tripConfig.day1 && tripConfig.day1.temperature) || '';
            const emoji = getWeatherEmoji(w || '');
            const dEmojiEl = document.getElementById('departure-weather-emoji');
            const dWeatherEl = document.getElementById('departure-weather');
            const dTempEl = document.getElementById('departure-temperature');
            const dCityEl = document.getElementById('departure-city');
            if (dEmojiEl) dEmojiEl.textContent = emoji;
            if (dWeatherEl) dWeatherEl.textContent = w;
            if (dTempEl) dTempEl.textContent = t;
            if (dCityEl) dCityEl.textContent = city;
          }
          function updateDepartureSummary() {
            const summaryEl = document.getElementById('departure-city-summary');
            if (summaryEl) {
              const dep = tripConfig && tripConfig.departure ? tripConfig.departure : {};
              const city = dep.city || tripConfig.city || '出发城市';
              const w = dep.weather || (tripConfig.day1 && tripConfig.day1.weather) || '天气适宜';
              const t = dep.temperature || (tripConfig.day1 && tripConfig.day1.temperature) || '';
              const dateStr = dep.date || (tripConfig.day1 && tripConfig.day1.date) || '';
              if (dep.summary) {
                summaryEl.innerHTML = `<span class=\"font-bold\"><span class=\"mr-1\">🧳</span> 出行天气建议：</span> ${dep.summary}`;
              } else {
                summaryEl.innerHTML = `<span class=\"font-bold\"><span class=\"mr-1\">🧳</span> 出行天气建议：</span> 亲爱的旅行者，${dateStr} ${city}出发体感良好～ ${w}为主，气温 ${t}，建议轻便外套、舒适鞋，备折叠伞与充电宝。`;
              }
            }
          }
          function updateTopInfoCards() {
            const dep = tripConfig && tripConfig.departure ? tripConfig.departure : {};
            const depCity = dep.city || tripConfig.city || '出发城市';
            const startDateStr = (dep.date || (tripConfig.day1 && tripConfig.day1.date) || '');
            const depWeather = dep.weather || (tripConfig.day1 && tripConfig.day1.weather) || '';
            const depTemp = dep.temperature || (tripConfig.day1 && tripConfig.day1.temperature) || '';
            const depTransport = dep.transport || '';
            const cityName = tripConfig.city || '';
            const days = parseInt(String(tripConfig.daysNumber || 1), 10);
            let endDateStr = startDateStr;
            const m = startDateStr.match(/(\d+)年(\d+)月(\d+)日/);
            if (m) {
              const y = parseInt(m[1]);
              const mo = parseInt(m[2]) - 1;
              const d = parseInt(m[3]);
              const sd = new Date(y, mo, d);
              const ed = new Date(sd);
              ed.setDate(sd.getDate() + Math.max(0, days - 1));
              const fmt = (date) => `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
              endDateStr = fmt(ed);
            }
            const tripWeather = (tripConfig.day1 && tripConfig.day1.weather) || depWeather || '';
            const tripTemp = (tripConfig.day1 && tripConfig.day1.temperature) || depTemp || '';
            const depEmojiEl = document.getElementById('departure-info-weather-emoji');
            const depCityEl = document.getElementById('departure-info-city');
            const depDateEl = document.getElementById('departure-info-date');
            const depWeatherEl = document.getElementById('departure-info-weather');
            const depTempEl = document.getElementById('departure-info-temp');
            if (depEmojiEl) depEmojiEl.textContent = getWeatherEmoji(depWeather || '');
            if (depCityEl) depCityEl.textContent = depCity;
            if (depDateEl) {
              const wlabel = getWeekdayLabel(startDateStr);
              depDateEl.textContent = wlabel ? `${startDateStr} (${wlabel})` : startDateStr;
            }
            const depTransportEmojiEl = document.getElementById('departure-info-transport-emoji');
            const depTransportEl = document.getElementById('departure-info-transport');
            function getTransportEmoji(mode) {
              const map = {
                '自驾': '🚗',
                '高铁': '🚅',
                '动车': '🚄',
                '火车': '🚆',
                '飞机': '✈️',
                '大巴': '🚌',
                '公交': '🚌',
                '地铁': '🚇',
                '打车': '🚕'
              };
              return map[mode] || '🚗';
            }
            if (depTransportEmojiEl) depTransportEmojiEl.textContent = getTransportEmoji(depTransport);
            if (depTransportEl) depTransportEl.textContent = depTransport;
            if (depWeatherEl) depWeatherEl.textContent = depWeather;
            if (depTempEl) depTempEl.textContent = depTemp;
            const tripEmojiEl = document.getElementById('trip-info-weather-emoji');
            const tripCityEl = document.getElementById('trip-info-city');
            const tripDateRangeEl = document.getElementById('trip-info-date-range');
            const tripWeatherEl = document.getElementById('trip-info-weather');
            const tripTempEl = document.getElementById('trip-info-temp');
            if (tripEmojiEl) tripEmojiEl.textContent = getWeatherEmoji(tripWeather || '');
            if (tripCityEl) tripCityEl.textContent = cityName;
            if (tripDateRangeEl) {
              const ws = getWeekdayLabel(startDateStr);
              const we = getWeekdayLabel(endDateStr);
              const startHtml = `<span class="trip-date-start whitespace-nowrap">${startDateStr}${ws ? ` (${ws})` : ''}</span>`;
              if (days === 1 || !endDateStr) {
                const firstLine = `<span class="date-first-line-nowrap inline-flex items-center"><span class="mr-1">📅</span><span class="mr-1 whitespace-nowrap">游玩日期：</span>${startHtml}</span>`;
                tripDateRangeEl.innerHTML = firstLine;
              } else {
                const endHtml = `<span class="trip-date-end whitespace-nowrap">${endDateStr}${we ? ` (${we})` : ''}</span>`;
                const firstLine = `<span class="date-first-line-nowrap inline-flex items-center"><span class="mr-1">📅</span><span class="mr-1 whitespace-nowrap">游玩日期：</span>${startHtml}</span>`;
                tripDateRangeEl.innerHTML = `${firstLine} <br class="md:hidden" /> ~ ${endHtml}`;
              }
            }
            if (tripWeatherEl) tripWeatherEl.textContent = tripWeather;
            if (tripTempEl) tripTempEl.textContent = tripTemp;
          }
          function applyDepartureVisibility() {
            const dep = tripConfig && tripConfig.departure ? tripConfig.departure : {};
            const cityVal = String(dep.city || '').trim();
            const hasCity = !!(cityVal && !/^未提供$|^未设置$|^未填写$|^无$|^N\/?A$/i.test(cityVal));
            const depRow = document.getElementById('departure-city-row');
            const depSummary = document.getElementById('departure-city-summary');
            const depCard = document.getElementById('departure-info-card');
            const topCards = document.getElementById('top-info-cards');
            if (!hasCity) {
              if (depRow) depRow.classList.add('hidden');
              if (depSummary) depSummary.classList.add('hidden');
              if (depCard) depCard.classList.add('hidden');
              if (topCards) {
                topCards.classList.remove('md:grid-cols-2');
                topCards.classList.add('md:grid-cols-1');
              }
              setTripCardLayoutHorizontal(true);
            } else {
              if (depRow) depRow.classList.remove('hidden');
              if (depSummary) depSummary.classList.remove('hidden');
              if (depCard) depCard.classList.remove('hidden');
              if (topCards) {
                topCards.classList.remove('md:grid-cols-1');
                topCards.classList.add('md:grid-cols-2');
              }
              setTripCardLayoutHorizontal(false);
            }
          }
          function setTripCardLayoutHorizontal(enabled) {
            const card = document.getElementById('trip-info-card');
            if (!card) return;
            const children = Array.from(card.children).filter(el => el.tagName && el.tagName.toLowerCase() === 'div');
            Array.from(card.querySelectorAll('.separator-line.dynamic-sep')).forEach(el => el.remove());
            if (enabled) {
              card.classList.add('flex-col', 'items-center', 'justify-center', 'text-center', 'w-full', 'gap-1');
              card.classList.remove('flex-row');
              children.forEach(ch => {
                ch.classList.add('flex', 'items-center', 'justify-center', 'text-center', 'w-full');
                const isDateRange = !!ch.querySelector('#trip-info-date-range');
                if (!isDateRange) ch.classList.add('whitespace-nowrap');
              });
              if (tripConfig.daysNumber > 1 && children[0]) {
                children[0].classList.add('date-block-nowrap');
              }
              for (let i = 0; i < children.length - 1; i++) {}
            } else {
              card.classList.remove('flex-row', 'flex-wrap', 'justify-center', 'items-center', 'md:flex-row', 'md:flex-wrap', 'md:justify-center', 'md:items-center', 'gap-1', 'md:gap-2');
              card.classList.add('flex-col');
              children.forEach(ch => ch.classList.remove('flex', 'items-center', 'whitespace-nowrap'));
              if (tripConfig.daysNumber > 1 && children[0]) {
                children[0].classList.add('date-block-nowrap');
              }
            }
          }
          function updateHeaderBackgroundFromWeather() {
            const headerEl = document.getElementById('page-header');
            if (!headerEl) return;
            const weatherTextSpan = document.getElementById('trip-weather');
            const weatherText = (weatherTextSpan && weatherTextSpan.textContent) || (tripConfig.day1 && tripConfig.day1.weather) || '晴';
            const icon = getWeatherEmoji(weatherText);
            const gradient = computeWeatherGradient(icon);
            headerEl.style.background = gradient;
          }
          updateDepartureWeather();
          updateDepartureSummary();
          updateTopInfoCards();
          applyDepartureVisibility();
          updateHeaderBackgroundFromWeather();
        });
      </script>
    </div>
    <!-- 锚点：header底部 -->
    <div id="header-bottom"></div>
  </header>

  <!-- 顶部导航栏 - 固定在页面最前端 -->
  <nav id="daohanglan" class="sticky top-0 z-[9999] transition-all duration-300 py-2" style="backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); color: #333; position: sticky;">
    <!-- 所有div元素位于nav标签下层 -->
    <div class="container mx-auto px-0 py-0">
      <div class="md:flex md:items-center overflow-x-auto whitespace-nowrap px-0" style="scrollbar-width: thin; scrollbar-color: rgba(30, 136, 229, 0.5) rgba(30, 136, 229, 0.1);">
        <div class="flex items-center py-0 w-full justify-between md:justify-center">
          <!-- 汉堡菜单按钮 - 移动端显示 -->
          <button id="mobile-menu-button" class="px-4 py-1 md:hidden text-gray-700 rounded-lg">
            <i class="fa fa-bars text-xl"></i>
          </button>
          <!-- 当前位置名称 - 移动端显示 -->
          <div id="current-location" class="flex-1 text-center md:hidden font-bold text-xl">行程地图</div>
          <!-- 右侧按钮 - PC端隐藏 -->
          <button id="right-navbar-button" class="px-6 py-1 text-gray-700 rounded-lg md:hidden">
          </button>
          <!-- 导航链接 - 桌面端显示 -->
          <div id="desktop-nav" class="hidden md:flex space-x-6 px-2">
            <!-- 动态生成的导航链接将在这里插入 -->
          </div>
          <!-- 移动端导航菜单容器 - 磨砂玻璃风格 -->
          <div id="mobile-nav-menu" class="hidden absolute top-full left-0 right-0 z-[9999] py-4 transition-all duration-300 ease-in-out glass-effect">
            <div id="mobile-nav" class="flex flex-col space-y-4 px-6">
              <!-- 动态生成的移动端导航链接将在这里插入 -->
            </div>
          </div>
          <script>
            // 动态生成导航栏函数 - 显示页面所有section容器
            function generateDynamicNavbar() {
              const desktopNav = document.getElementById('desktop-nav');
              const mobileNav = document.getElementById('mobile-nav');
              
              // 清空现有内容
              desktopNav.innerHTML = '';
              mobileNav.innerHTML = '';
              
              // 直接使用默认导航项生成，不再依赖页面中的section元素
              const navItems = [];
                // 默认导航项
                const defaultNavItems = [
                  { id: 'map', text: '行程地图' }
                ];
                
                // 添加动态行程天数导航项
                for (let day = 1; day <= tripConfig.daysNumber; day++) {
                  defaultNavItems.push({ 
                    id: `day${day}`,
                    text: tripConfig.daysNumber === 1 ? '一日游' : `第${day}天行程`
                  });
                }
                
                // 添加其他默认导航项
                defaultNavItems.push(
                  { id: 'accommodation', text: '推荐住宿' },
                  { id: 'food', text: '推荐美食' },
                  { id: 'packing-list', text: '行李清单' }
                );
                
              navItems.push(...defaultNavItems);
              
              // 生成桌面端导航链接
              navItems.forEach(item => {
                const a = document.createElement('a');
                a.href = `#${item.id}`;
                a.className = 'px-4 py-2 font-bold text-center';
                a.textContent = item.text;
                desktopNav.appendChild(a);
              });
              
              // 生成移动端导航链接
              navItems.forEach((item, index) => {
                const a = document.createElement('a');
                a.href = `#${item.id}`;
                a.className = `px-4 py-2 font-bold text-center ${index < navItems.length - 1 ? 'border-b border-gray-200' : ''}`;
                a.textContent = item.text;
                mobileNav.appendChild(a);
                
                // 添加点击事件，点击后关闭移动端菜单并恢复页面滚动
                a.addEventListener('click', () => {
                  const mobileMenuButton = document.getElementById('mobile-menu-button');
                  const mobileNavMenu = document.getElementById('mobile-nav-menu');
                  if (mobileMenuButton && mobileNavMenu) {
                    mobileMenuButton.classList.remove('rotated');
                    mobileNavMenu.classList.remove('show');
                    // 恢复页面滚动
                    document.body.style.overflow = '';
                  }
                });
              });
            }
            
            // 页面加载完成后生成动态导航栏
            document.addEventListener('DOMContentLoaded', function() {
              // 确保页面中的section都已加载完成
              setTimeout(generateDynamicNavbar, 100);
            });
          </script>
        <!-- 隐藏滚动条但保留滚动功能 -->
        <div style="width: 100%; height: 0px; position: absolute; bottom: 0; left: 0; background: transparent;"></div>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-10">
  <section id="map">
    <!-- 高德地图容器 -->
    <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
      <div class="gradient-bg text-white py-4 px-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold flex items-center">
            <p>🗺️ 行程地图</p>
          </h2>
          <div class="flex items-center bg-white/20 rounded-lg overflow-hidden">
            <button id="toggle-left" class="px-3 py-1 text-sm font-medium bg-white/30">标准</button>
            <div class="w-px h-6 bg-white/50"></div>
            <button id="toggle-right" class="px-3 py-1 text-sm font-medium">卫星</button>
          </div>
        </div>
        <script>
          // 地图图层切换功能 - 使用JS API 2.0实现
          document.addEventListener('DOMContentLoaded', function() {
            const standardBtn = document.getElementById('toggle-left');
            const satelliteBtn = document.getElementById('toggle-right');
            
            if (standardBtn && satelliteBtn) {
              // 初始化全局图层对象
              window.normalLayer = null;
              window.satelliteLayer = null;
              
              // 切换到标准图层的函数
              function switchToStandardLayer() {
                if (window.amapInstance) {
                  // 使用高德地图2.0 API的方式切换到标准图层
                  // 移除卫星图层
                  if (window.satelliteLayer) {
                    window.satelliteLayer.setMap(null);
                  }
                  
                  // 确保标准图层存在并添加到地图
                  if (!window.normalLayer) {
                    window.normalLayer = AMap.createDefaultLayer();
                  }
                  window.normalLayer.setMap(window.amapInstance);
                  
                  // 更新按钮状态
                  standardBtn.classList.add('bg-white/30');
                  satelliteBtn.classList.remove('bg-white/30');
                  
                  console.log('切换到标准地图图层');
                }
              }
              
              // 切换到卫星图层的函数
              function switchToSatelliteLayer() {
                if (window.amapInstance) {
                  // 使用高德地图2.0 API的方式切换到卫星图层
                  // 移除标准图层
                  if (window.normalLayer) {
                    window.normalLayer.setMap(null);
                  }
                  
                  // 确保卫星图层存在并添加到地图
                  if (!window.satelliteLayer) {
                    window.satelliteLayer = new AMap.TileLayer.Satellite();
                  }
                  window.satelliteLayer.setMap(window.amapInstance);
                  
                  // 更新按钮状态
                  satelliteBtn.classList.add('bg-white/30');
                  standardBtn.classList.remove('bg-white/30');
                  
                  console.log('切换到卫星地图图层');
                }
              }
              
              // 为标准按钮添加点击事件
              standardBtn.addEventListener('click', switchToStandardLayer);
              
              // 为卫星按钮添加点击事件
              satelliteBtn.addEventListener('click', switchToSatelliteLayer);
              
              // 初始化时设置标准图层为默认
              setTimeout(switchToStandardLayer, 500);
            }
          });
        </script>
      </div>

      <div class="p-4">
            <!-- 为地图容器和侧边栏创建id为map的section -->
            <!-- 地图容器 -->
            <div id="map-container" class="w-full h-80 bg-gray-100 rounded-lg relative" style="min-height: 320px;">
              <!-- 交互式高德地图将在这里加载 -->
            </div>
            
            <!-- 行程选择栏和位置列表 - 移至地图下方 - 与地图无缝衔接 -->
            <div id="sidebar" class="mt-0 rounded-t-none overflow-hidden">
            <!-- 横向滚动的分类选择 -->
            <div class="overflow-x-auto whitespace-nowrap p-2 border-b" style="display: none;">
              <h3 class="inline-block px-4 py-2 cursor-pointer bg-primary text-white rounded-lg mr-2 transition-colors" id="day1-tab">
                第1天
              </h3>
              
              <h3 class="inline-block px-4 py-2 cursor-pointer bg-gray-100 hover:bg-primary/80 hover:text-white rounded-lg mr-2 transition-colors" id="day2-tab">
                第2天
              </h3>

              <h3 class="inline-block px-4 py-2 cursor-pointer bg-gray-100 hover:bg-primary/80 hover:text-white rounded-lg transition-colors" id="hotel-tab">
                推荐住宿
              </h3>
              
              <h3 class="inline-block px-4 py-2 cursor-pointer bg-gray-100 hover:bg-primary/80 hover:text-white rounded-lg mr-2 transition-colors" id="nearby-tab">
                周边景点
              </h3>
            </div>
            
            <!-- 第1天地点内容 -->
            <div id="day1-content" class="overflow-x-auto whitespace-nowrap py-1 px-1">
              <div id="day1-locations" class="flex space-x-2">
                <!-- 地点按钮将通过JavaScript动态生成 -->
              </div>
            </div>
            
            <!-- 第2天地点内容 -->
            <div id="day2-content" class="overflow-x-auto whitespace-nowrap py-1 px-1 hidden">
              <div id="day2-locations" class="flex space-x-2">
                <!-- 地点按钮将通过JavaScript动态生成 -->
              </div>
            </div>
            
            <script>
              // 动态生成地点按钮，确保与表格中地点顺序一致
              function generateLocationButtons(day = 1) {
                const locationsContainer = document.getElementById(`day${day}-locations`);
                if (!locationsContainer) return;
                
                // 清空现有内容
                locationsContainer.innerHTML = '';
                
                // 根据指定天数获取对应的行程数组
                const itineraryArray = tripConfig[`itineraryDetailsDay${day}`] || [];
                
                // 遍历行程数据生成地点按钮
                itineraryArray.forEach(item => {
                  const button = document.createElement('button');
                  button.className = 'inline-block text-left px-3 py-2 rounded hover:bg-secondary hover:text-white transition-colors whitespace-nowrap';
                  button.setAttribute('data-location', item.location);
                  if (item.locationCoords) {
                    button.setAttribute('data-location-coords', JSON.stringify(item.locationCoords));
                  }
                  
                  // 获取行程点的图标，如果没有则使用默认图标
                  const icon = item.icon || '📍';
                  
                  // 使用索引+1作为数字编号
                  const index = itineraryArray.indexOf(item) + 1;
                  button.innerHTML = `
                    <span class="inline-block w-5 h-5 bg-primary text-white text-xs rounded-full text-center leading-5 mr-2" data-location-icon="true">${index}</span>
                    ${item.location}
                  `;
                  
                  // 直接为每个新生成的按钮添加点击事件监听器
                  button.addEventListener('click', function() {
                    const locationName = this.getAttribute('data-location');
                    
                    // 检查标记是否已创建
                    if (markerMap.has(locationName)) {
                      const markerInfo = markerMap.get(locationName);
                      
                      // 移动地图中心到该位置，并设置为街道级视角
                      window.amapInstance.panTo(markerInfo.position);
                      window.amapInstance.setZoom(16);
                      // 移除动画效果，因为marker对象没有setAnimation方法
                      
                      // 关闭所有信息窗口
                      window.amapInstance.clearInfoWindow();
                      
                      // 在p标签区域显示详细信息
                      showLocationInfo(locationName, markerInfo.position);
                    } else {
                      // 如果标记尚未创建，先创建再执行操作
                      createMarkerForButton(locationName, 0);
                      
                      // 增加等待时间，确保有足够时间获取位置
                      setTimeout(() => {
                        const markerInfo = markerMap.get(locationName);
                        if (markerInfo) {
                          window.amapInstance.panTo(markerInfo.position);
                          window.amapInstance.setZoom(16);
                          // 关闭所有信息窗口
                          window.amapInstance.clearInfoWindow();
                          // 在p标签区域显示详细信息
                          showLocationInfo(locationName, markerInfo.position);
                        }
                      }, 1000);
                    }
                  });

                  
                  
                  locationsContainer.appendChild(button);
                });
              }
              
              // 页面加载时生成地点按钮
              document.addEventListener('DOMContentLoaded', function() {
                getItineraryDays().forEach(day => {
                  generateLocationButtons(day);
                });
              });
            </script>
            
            <!-- 周边景点内容 (默认隐藏) -->
            <div id="nearby-content" class="overflow-x-auto whitespace-nowrap py-1 px-1 hidden">
              <div id="nearby-locations" class="flex space-x-2">
                <!-- 按钮将通过JavaScript动态生成 -->
              </div>
              <script>
                // 动态生成周边景点按钮
                document.addEventListener('DOMContentLoaded', function() {
                  const nearbyLocationsDiv = document.querySelector('#nearby-content > div[id="nearby-locations"]');
                  if (!nearbyLocationsDiv) return;
                  
                  // 清空容器
                  nearbyLocationsDiv.innerHTML = '';
                  
                  // 遍历所有周边景点项目
                  const allNearbyAttractions = [];
                  tripConfig.nearbyAttractions.forEach(area => {
                    area.items.forEach(item => {
                      allNearbyAttractions.push(item);
                    });
                  });
                  
                  // 生成按钮
                  allNearbyAttractions.forEach((attraction, index) => {
                    const button = document.createElement('button');
                    button.className = 'inline-block text-left px-3 py-2 rounded hover:bg-secondary hover:text-white transition-colors whitespace-nowrap';
                    button.setAttribute('data-location', attraction.location);
                    // 从nearbyAttractions中获取对应的locationCoords并添加到按钮属性
                    if (attraction.locationCoords) {
                      button.setAttribute('data-location-coords', JSON.stringify(attraction.locationCoords));
                    }
                    button.innerHTML = `
                      <span class="mr-2 text-primary" data-location-icon="true">${attraction.emoji || '📍'}</span>${attraction.location}
                    `;
                    nearbyLocationsDiv.appendChild(button);
                  });
                });
              </script>
            </div>
            
            <!-- 推荐住宿内容 (默认隐藏) -->
            <div id="hotel-content" class="overflow-x-auto whitespace-nowrap py-1 px-1 hidden">
              <div id="hotel-locations" class="flex space-x-2">
                <!-- 按钮将通过JavaScript动态生成 -->
              </div>
              <script>
                // 动态生成酒店按钮
                document.addEventListener('DOMContentLoaded', function() {
                  const hotelContentDiv = document.getElementById('hotel-locations');
                  if (!hotelContentDiv) return;
                  
                  // 清空容器
                  hotelContentDiv.innerHTML = '';
                  
                  // 遍历所有住宿项目
                  const allHotels = [];
                  tripConfig.accommodations.forEach(area => {
                    area.items.forEach(item => {
                      allHotels.push(item);
                    });
                  });
                  
                  // 生成按钮
                  allHotels.forEach(hotel => {
                    const button = document.createElement('button');
                    button.className = 'inline-block text-left px-3 py-2 rounded hover:bg-secondary hover:text-white transition-colors whitespace-nowrap';
                    button.setAttribute('data-hotel', hotel.location);
                    // 从accommodations中获取对应的locationCoords并添加到按钮属性
                    if (hotel.locationCoords) {
                      button.setAttribute('data-location-coords', JSON.stringify(hotel.locationCoords));
                    }
                    button.innerHTML = `
                      <span class="mr-2 text-primary" data-location-icon="true">${hotel.emoji || '🏨'}</span>${hotel.location}
                    `;
                    hotelContentDiv.appendChild(button);
                  });
                });
              </script>
            </div>
            
            <!-- 地图说明 -->
            <div class="mt-0 bg-gray-50 p-3 rounded-lg text-sm text-gray-600">
              <p id="map-info-paragraph" class="h-auto w-full break-words"><span class="mr-1 text-blue-500">ℹ️</span> 地图显示了福州市的主要景点位置，点击标记或下方快捷按钮可查看详情</p>
            </div>
          </div>
        </div>
    </div>
  </section> <!-- 闭合id为map的section -->
    
    <!-- 动态行程sections将在这里生成 -->
    <div id="itinerary-sections-container">
      <!-- 行程sections将通过JavaScript动态生成 -->
    </div>

    <script>
      // 获取天气emoji
      // 全局天气emoji映射对象
const WEATHER_EMOJI_MAP = {
  '晴': '☀️',
  '晴偶有云': '🌤️',
  '晴间多云': '🌤️',
  '多云': '⛅',
  '阴': '☁️',
  '小雨': '🌦️',
  '中雨': '🌧️',
  '大雨': '🌧️',
  '暴雨': '⛈️',
  '阵雨': '🌦️',
  '雷阵雨': '⛈️',
  '小雪': '❄️',
  '中雪': '❄️',
  '大雪': '🌨️',
  '暴雪': '🌨️',
  '雨夹雪': '🌨️', 
  '冻雨': '🌨️', 
  '冰雹': '🌨️', 
  '雾': '🌫️',
  '霾': '😷',
  '扬沙': '💨',
  '沙尘暴': '🌪️',
  '浮尘': '💨',
  '台风': '🌀',
  '龙卷风': '🌪️',
  '大风': '🌬'
};
      function getWeatherEmoji(weather) {
        // 检查是否为复合天气（包含"转"字）
        if (weather.includes('转')) {
          const [firstWeather, secondWeather] = weather.split('转');
          const firstEmoji = WEATHER_EMOJI_MAP[firstWeather] || WEATHER_EMOJI_MAP[firstWeather.trim()] || '🔄';
          const secondEmoji = WEATHER_EMOJI_MAP[secondWeather] || WEATHER_EMOJI_MAP[secondWeather.trim()] || '🔄';
          return `${firstEmoji}~${secondEmoji}`;
        }
        
        // 检查是否为复合天气（包含"到"字）
        if (weather.includes('到')) {
          const [firstWeather, secondWeather] = weather.split('到');
          const firstEmoji = WEATHER_EMOJI_MAP[firstWeather] || WEATHER_EMOJI_MAP[firstWeather.trim()] || '🔄';
          const secondEmoji = WEATHER_EMOJI_MAP[secondWeather] || WEATHER_EMOJI_MAP[secondWeather.trim()] || '🔄';
          return `${firstEmoji}~${secondEmoji}`;
        }
        
        // 单个天气的情况
        return WEATHER_EMOJI_MAP[weather] || '🔄';
      }
      function computeWeatherGradient(weatherIcon) {
        const weatherColors = {
          '☀️': ['rgba(255, 193, 7, 0.8)', 'rgba(255, 159, 64, 0.4)'],
          '🌤️': ['rgba(255, 205, 86, 0.8)', 'rgba(255, 179, 0, 0.4)'],
          '⛅': ['rgba(173, 216, 230, 0.8)', 'rgba(135, 206, 235, 0.4)'],
          '☁️': ['rgba(211, 211, 211, 0.8)', 'rgba(169, 169, 169, 0.4)'],
          '🌦️': ['rgba(100, 149, 237, 0.8)', 'rgba(70, 130, 180, 0.4)'],
          '🌧️': ['rgba(70, 130, 180, 0.8)', 'rgba(25, 25, 112, 0.4)'],
          '⛈️': ['rgba(72, 61, 139, 0.8)', 'rgba(47, 79, 79, 0.4)'],
          '❄️': ['rgba(240, 248, 255, 0.8)', 'rgba(135, 206, 235, 0.4)'],
          '🌨️': ['rgba(240, 248, 255, 0.8)', 'rgba(173, 216, 230, 0.4)'],
          '🌫️': ['rgba(220, 220, 220, 0.8)', 'rgba(169, 169, 169, 0.4)'],
          '😷': ['rgba(128, 128, 128, 0.8)', 'rgba(105, 105, 105, 0.4)'],
          '💨': ['rgba(169, 169, 169, 0.8)', 'rgba(135, 206, 235, 0.4)'],
          '🌪️': ['rgba(128, 128, 128, 0.8)', 'rgba(105, 105, 105, 0.4)'],
          '🌀': ['rgba(70, 130, 180, 0.8)', 'rgba(25, 25, 112, 0.4)'],
          '🌬': ['rgba(169, 169, 169, 0.8)', 'rgba(135, 206, 235, 0.4)']
        };
        if (weatherIcon.includes('~')) {
          const [firstWeather, secondWeather] = weatherIcon.split('~');
          const firstColors = weatherColors[firstWeather] || weatherColors['☀️'];
          const secondColors = weatherColors[secondWeather] || weatherColors['⛅'];
          return `linear-gradient(to right, ${firstColors[0]}, ${secondColors[0]})`;
        }
        const emojis = Array.from(weatherIcon.matchAll(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]+/gu)).map(m => m[0]);
        if (emojis.length >= 2) {
          const firstColors = weatherColors[emojis[0]] || weatherColors['☀️'];
          const secondColors = weatherColors[emojis[emojis.length - 1]] || weatherColors['⛅'];
          return `linear-gradient(to right, ${firstColors[0]}, ${secondColors[0]})`;
        }
        const colors = weatherColors[weatherIcon] || weatherColors['☀️'];
        return `linear-gradient(to right, ${colors[0]}, ${colors[1]})`;
      }
      function getItineraryDays() {
        const existingDays = [];
        for (let day = 1; ; day++) {
          const arr = tripConfig[`itineraryDetailsDay${day}`];
          if (Array.isArray(arr)) {
            existingDays.push(day);
          } else {
            break;
          }
        }
        if (tripConfig.daysNumber) {
          if (existingDays.length > 0) {
            return existingDays.filter(d => d <= tripConfig.daysNumber);
          }
          const days = [];
          for (let day = 1; day <= tripConfig.daysNumber; day++) {
            days.push(day);
          }
          return days;
        }
        return existingDays;
      }
      
      // 动态生成行程section
      function generateItinerarySections() {
        const container = document.getElementById('itinerary-sections-container');
        if (!container || !tripConfig || !tripConfig.daysNumber) return;
        
        container.innerHTML = '';
        
        // 根据daysNumber动态生成对应数量的行程section
        getItineraryDays().forEach(day => {
          const section = document.createElement('section');
          section.id = `day${day}`;
          section.className = 'mb-6 scroll-mt-10';
          section.style.textAlign = 'center';
          
          // 获取当天的行程数据
          const dayConfig = tripConfig[`itineraryDetailsDay${day}`] || [];
          // 动态获取当前天的配置
          const currentDayConfig = tripConfig[`day${day}`];
          const dayDate = currentDayConfig?.date || tripConfig[`day${day}Date`] || '2025年10月29日';
          const dayWeather = currentDayConfig?.weather || tripConfig[`day${day}Weather`] || '晴';
          const dayTemperature = currentDayConfig?.temperature || tripConfig[`day${day}Temperature`] || '17°C~23°C';
          const dayWindDirection = currentDayConfig?.windDirection || tripConfig[`day${day}WindDirection`] || '';
          const dayWindForce = currentDayConfig?.windForce || tripConfig[`day${day}WindForce`] || '';
          const weatherIcon = getWeatherEmoji(dayWeather); // 直接根据显示的天气文本生成emoji
          // 直接使用dayDate，不再需要偏移计算
          const date = dayDate;
          // 计算对应的星期几
          const weekday = getWeekdayFromDate(date);
          const weather = dayConfig[0]?.weather || dayWeather;
          
          // 设置section内容
          // 根据天气emoji生成对应的渐变背景颜色
          function getWeatherGradient(weatherIcon) {
            // 提取纯色值，用于复合天气渐变
            const weatherColors = {
              '☀️': ['rgba(255, 193, 7, 0.8)', 'rgba(255, 159, 64, 0.4)'],
              '🌤️': ['rgba(255, 205, 86, 0.8)', 'rgba(255, 179, 0, 0.4)'],
              '⛅': ['rgba(173, 216, 230, 0.8)', 'rgba(135, 206, 235, 0.4)'],
              '☁️': ['rgba(211, 211, 211, 0.8)', 'rgba(169, 169, 169, 0.4)'],
              '🌦️': ['rgba(100, 149, 237, 0.8)', 'rgba(70, 130, 180, 0.4)'],
              '🌧️': ['rgba(70, 130, 180, 0.8)', 'rgba(25, 25, 112, 0.4)'],
              '⛈️': ['rgba(72, 61, 139, 0.8)', 'rgba(47, 79, 79, 0.4)'],
              '❄️': ['rgba(240, 248, 255, 0.8)', 'rgba(135, 206, 235, 0.4)'],
              '🌨️': ['rgba(240, 248, 255, 0.8)', 'rgba(173, 216, 230, 0.4)'],
              '🌫️': ['rgba(220, 220, 220, 0.8)', 'rgba(169, 169, 169, 0.4)'],
              '😷': ['rgba(128, 128, 128, 0.8)', 'rgba(105, 105, 105, 0.4)'],
              '💨': ['rgba(169, 169, 169, 0.8)', 'rgba(135, 206, 235, 0.4)'],
              '🌪️': ['rgba(128, 128, 128, 0.8)', 'rgba(105, 105, 105, 0.4)'],
              '🌀': ['rgba(70, 130, 180, 0.8)', 'rgba(25, 25, 112, 0.4)'],
              '🌬': ['rgba(169, 169, 169, 0.8)', 'rgba(135, 206, 235, 0.4)']
            };
            
            // 检查是否为复合天气（包含~分隔符）
            if (weatherIcon.includes('~')) {
              const [firstWeather, secondWeather] = weatherIcon.split('~');
              const firstColors = weatherColors[firstWeather] || weatherColors['☀️'];
              const secondColors = weatherColors[secondWeather] || weatherColors['⛅'];
              
              // 生成从第一个天气主色到第二个天气主色的渐变
              return `linear-gradient(to right, ${firstColors[0]}, ${secondColors[0]})`;
            }
            
            // 检查是否包含多个连续emoji（如晴间多云☀️⛅）
            const emojis = Array.from(weatherIcon.matchAll(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]+/gu)).map(m => m[0]);
            if (emojis.length >= 2) {
              const firstColors = weatherColors[emojis[0]] || weatherColors['☀️'];
              const secondColors = weatherColors[emojis[emojis.length - 1]] || weatherColors['⛅'];
              
              // 生成从第一个天气主色到最后一个天气主色的渐变
              return `linear-gradient(to right, ${firstColors[0]}, ${secondColors[0]})`;
            }
            
            // 单个天气的默认渐变
            const colors = weatherColors[weatherIcon] || weatherColors['☀️'];
            return `linear-gradient(to right, ${colors[0]}, ${colors[1]})`;
          }
          
          const weatherGradient = getWeatherGradient(weatherIcon);
          function getMemphisAccentColor(weatherIcon) {
            const accentMap = {
              '☀️': '#FF6B6B',
              '🌤️': '#FFA447',
              '⛅': '#00C2FF',
              '☁️': '#7E57C2',
              '🌦️': '#00BFA6',
              '🌧️': '#5C7AEA',
              '⛈️': '#8E24AA',
              '❄️': '#64D3FF',
              '🌨️': '#64D3FF',
              '🌫️': '#B0BEC5',
              '😷': '#E91E63',
              '💨': '#26A69A',
              '🌪️': '#AB47BC',
              '🌀': '#00ACC1',
              '🌬': '#26A69A'
            };
            if (weatherIcon.includes('~')) {
              const [firstWeather] = weatherIcon.split('~');
              return accentMap[firstWeather] || '#FFFFFF';
            }
            const emojis = Array.from(weatherIcon.matchAll(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]+/gu)).map(m => m[0]);
            if (emojis.length > 0) {
              return accentMap[emojis[0]] || '#FFFFFF';
            }
            return accentMap[weatherIcon] || '#FFFFFF';
          }
          function toAlpha(color, alpha) {
            try {
              if (typeof alpha !== 'number') alpha = 0.2;
              if (!color) return `rgba(255,255,255,${alpha})`;
              if (/^#/.test(color)) {
                let hex = color.replace('#', '');
                if (hex.length === 3) {
                  hex = hex.split('').map(c => c + c).join('');
                }
                const r = parseInt(hex.substring(0, 2), 16);
                const g = parseInt(hex.substring(2, 4), 16);
                const b = parseInt(hex.substring(4, 6), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
              }
              const m = color.match(/rgb\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/i);
              if (m) {
                return `rgba(${m[1]}, ${m[2]}, ${m[3]}, ${alpha})`;
              }
              return `rgba(255,255,255,${alpha})`;
            } catch (e) {
              return `rgba(255,255,255,${alpha})`;
            }
          }
          const memphisAccent = getMemphisAccentColor(weatherIcon);
          const tourTipsText = (tripConfig[`day${day}`] && tripConfig[`day${day}`].tourTips) ? tripConfig[`day${day}`].tourTips : getDayTips(day);
          section.innerHTML = `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
              <div class="table-container">
                <div style="background: ${weatherGradient}; position: relative; overflow: hidden" class="weather-gradient-container text-white py-3 px-6">
                  <div class="absolute left-0 top-0 w-full h-full weather-emoji-container pointer-events-none">
                    <!-- 处理复合天气emoji显示 -->
                    ${(() => {
                      // 检查是否为复合天气（包含~分隔符）
                      if (weatherIcon.includes('~')) {
                        const [firstWeather, secondWeather] = weatherIcon.split('~');
                        return `
                          <div class="flex justify-between items-center w-full h-full">
                            <div class="text-[120px] md:text-[90px]" style="line-height: 1; margin-left: 0px">${firstWeather}</div>
                            <div class="text-[120px] md:text-[90px]" style="line-height: 1; margin-right: 0px">${secondWeather}</div>
                          </div>
                        `;
                      }
                      // 检查是否包含多个连续emoji
                      const emojis = Array.from(weatherIcon.matchAll(/[\u{1F300}-\u{1F6FF}\u{2600}-\u{26FF}]+/gu)).map(m => m[0]);
                      if (emojis.length >= 2) {
                        return `
                          <div class="flex justify-between items-center w-full h-full">
                            <div class="text-[120px] md:text-[90px]" style="line-height: 1; margin-left: 0px">${emojis[0]}</div>
                            <div class="text-[120px] md:text-[90px]" style="line-height: 1; margin-right: 0px">${emojis[emojis.length - 1]}</div>
                          </div>
                        `;
                      }
                      // 单个天气emoji（默认左侧）
                      return `
                        <div class="flex items-center justify-start h-full">
                          <div class="text-[120px] md:text-[90px]" style="line-height: 1; margin-left: -10px">${weatherIcon}</div>
                        </div>
                      `;
                    })()}
                  </div>
                  <div class="flex flex-wrap items-center gap-x-2 justify-center">
                    <h2 class="text-2xl md:text-3xl font-bold text-white editable">${date}</h2><h2 class="text-2xl md:text-3xl font-bold text-white editable">${weekday}</h2>
                  </div>
                  <div class="text-base font-medium text-white editable text-center mb-2">
                    <div class="flex flex-col md:flex-row flex-wrap justify-center items-center gap-2 font-bold">
                      <!-- 第一部分：天气emoji、天气状况和温度 -->
                      <div class="flex flex-wrap justify-center items-center">
                        <span class="text-base mr-2">${weatherIcon}</span>
                        <span id="weather-condition-text">${dayWeather}</span>
                        <span id="weather-temperature" class="ml-2">🌡️ ${dayTemperature}</span>
                      </div>
                      <!-- 第二部分：风向和风力，在PC端与第一部分同一行 -->
                      <div class="flex flex-wrap justify-center items-center">
                        ${dayWindDirection ? `<span class="ml-2"><i class="fa fa-wind"></i> ${dayWindDirection}</span>` : ''}
                        ${dayWindForce ? `<span class="ml-2">${dayWindForce}</span>` : ''}
                      </div>
                    </div>
                  </div>
                  <h3 class="text-xl font-bold editable text-center"><span>第${day}天</span>行程安排</h3>
                </div>
                <table class="w-full">
                  <thead>
                    <tr class="bg-gray-100">
                      <th class="py-4 px-3 text-center">时间</th>
                      <th class="py-4 px-6 text-center">活动</th>
                      <th class="py-4 px-6 text-center">地点</th>
                      <th class="py-4 px-6 text-center">介绍</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-gray-200 itinerary-tbody-${day}">
                    <!-- 行程表格内容将通过JavaScript动态生成 -->
                  </tbody>
                </table>
              </div>
              <div class="p-4 bg-gray-100 text-left">
                <p class="text-sm text-gray-700">💡 游览小贴士：${tourTipsText}</p>
              </div>
            </div>

            <!-- 齿孔样式分隔符 -->
            <div class="relative h-[1.5rem] md:h-[1.80rem] my-0 mb-0">
              <div class="absolute inset-0 flex items-center">
                  <div class="w-full">
                    <div class="mx-auto w-[calc(95%)] md:w-[calc(99%)] h-[0.7rem] md:h-[0.875rem] bg-gray-100" style="clip-path: polygon(6% 100%, 94% 100%, 100% 0%, 0% 0%);"></div>
                    <div class="mx-auto w-[calc(82%)] md:w-[calc(85%)] h-0.5 border-b-[1px] border-gray-400 border-dashed"></div>
                    <div class="mx-auto w-[calc(95%)] md:w-[calc(99%)] h-[0.7rem] md:h-[0.875rem]" style="background: ${weatherGradient}; clip-path: polygon(0% 100%, 100% 100%, 94% 0%, 6% 0%);"></div>
                  </div>
                </div>
              <div class="absolute inset-0 flex justify-around items-center px-[10%] responsive-dots-${day}">
                <!-- 圆点将通过JavaScript动态生成 -->
              </div>
            </div>

            <!-- 行程路线安排 -->
            <div class="grid grid-cols-1 gap-4">
              <!-- 行程路线规划 -->
              <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div style="background: ${weatherGradient};" class="text-white py-3 px-6 cursor-default">
                  <h3 class="text-xl font-bold editable text-center"><span>第${day}天</span>行程路线</h3>
                </div>
                
                <div class="p-6">
                  <div class="space-y-6" id="route${day}-stops">
                    <!-- 行程路线内容将通过JavaScript动态生成 -->
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 齿孔样式分隔符 -->
            <div class="relative h-[1.5rem] md:h-[1.80rem] my-0 mb-0">
              <div class="absolute inset-0 flex items-center">
                  <div class="w-full">
                    <div class="mx-auto w-[calc(95%)] md:w-[calc(99%)] h-[0.7rem] md:h-[0.875rem] bg-white" style="clip-path: polygon(6% 100%, 94% 100%, 100% 0%, 0% 0%);"></div>
                    <div class="mx-auto w-[calc(82%)] md:w-[calc(85%)] h-0.5 border-b-[1px] border-gray-400 border-dashed"></div>
                    <div class="mx-auto w-[calc(95%)] md:w-[calc(99%)] h-[0.7rem] md:h-[0.875rem]" style="background: ${weatherGradient}; clip-path: polygon(0% 100%, 100% 100%, 94% 0%, 6% 0%);"></div>
                  </div>
                </div>
              <div class="absolute inset-0 flex justify-around items-center px-[10%] responsive-dots-${day}">
                <!-- 圆点将通过JavaScript动态生成 -->
              </div>
            </div>

            ${(function(){ const advice = (tripConfig[`day${day}`] && tripConfig[`day${day}`].adviceCard) || null; if (!advice) return ''; const sectionsHTML = Array.isArray(advice.sections) ? advice.sections.map(sec => `<div><div class=\"font-medium\">${sec.title || ''}</div><ul class=\"mt-1 space-y-1 text-sm md:text-base\">${(sec.items || []).map(it => `<li>${it}</li>`).join('')}</ul></div>`).join('') : ''; return `<div style=\"background: ${weatherGradient}; position: relative; overflow: hidden; --memphisAccent: ${memphisAccent}; --overlaySoft: ${toAlpha(memphisAccent, 0.22)}; --overlaySofter: ${toAlpha(memphisAccent, 0.14)};\" class=\"weather-gradient-container text-white py-3 px-6 rounded-xl font-bold weather-summary-card\"><h3 class=\"text-xl font-bold editable text-center\" style=\"color: ${memphisAccent};\">${advice.title || '🏝️旅游天气建议'}</h3><p class=\"mt-2 text-sm md:text-base leading-relaxed text-white\">${advice.summary || ''}</p><div class=\"mt-2 grid grid-cols-1 md:grid-cols-3 gap-4\">${sectionsHTML}</div></div>`; })()}
          `;
          
          container.appendChild(section);
          
          // 为每个day生成对应的表格内容
          generateItineraryTableByDay(day);
          
          // 生成对应的圆点
          generateResponsiveDotsByDay(day);
          
          // 生成对应的路线内容
          generateRouteDetailsByDay(day);
        });
      }
      
      // 根据指定的day生成行程表格
      // 根据天气emoji和时间段生成td背景色
      function getTdBackground(weatherEmoji, startTime, endTime) {
        // 定义每个整点对应的背景颜色（带透明度）
        const hourColors = {
          0: 'rgba(17, 24, 39, 0.3)',    // 午夜
          1: 'rgba(22, 27, 34, 0.3)',    // 午夜
          2: 'rgba(26, 32, 44, 0.3)',    // 凌晨
          3: 'rgba(30, 41, 59, 0.3)',    // 凌晨
          4: 'rgba(38, 70, 83, 0.3)',    // 黎明前
          5: 'rgba(42, 157, 143, 0.3)',  // 黎明前
          6: 'rgba(56, 189, 248, 0.3)',  // 日出
          7: 'rgba(134, 239, 172, 0.3)', // 日出
          8: 'rgba(235, 222, 179, 0.3)', // 早晨
          9: 'rgba(252, 211, 77, 0.3)',  // 早晨
          10: 'rgba(255, 228, 181, 0.3)',// 上午
          11: 'rgba(253, 230, 138, 0.3)',// 上午
          12: 'rgba(252, 211, 77, 0.3)', // 中午（最亮）
          13: 'rgba(255, 183, 3, 0.3)',  // 中午
          14: 'rgba(251, 191, 36, 0.3)', // 下午
          15: 'rgba(249, 115, 22, 0.3)', // 下午
          16: 'rgba(233, 150, 122, 0.3)',// 下午末
          17: 'rgba(225, 127, 80, 0.3)', // 下午末
          18: 'rgba(234, 88, 12, 0.3)',  // 日落
          19: 'rgba(147, 51, 234, 0.3)', // 日落
          20: 'rgba(124, 58, 237, 0.3)', // 晚上
          21: 'rgba(79, 70, 229, 0.3)',  // 晚上
          22: 'rgba(55, 48, 163, 0.3)',  // 深夜
          23: 'rgba(30, 41, 59, 0.3)'    // 深夜
        };
        
        // 提取开始时间和结束时间的小时部分
        const startHour = parseInt(startTime.split(':')[0]);
        const endHour = parseInt(endTime.split(':')[0]);
        
        // 获取开始时间和结束时间对应的颜色
        const startColor = hourColors[startHour] || hourColors[12];
        const endColor = hourColors[endHour] || hourColors[12];
        
        // 生成从上到下的渐变背景，从开始时间颜色渐变到结束时间颜色
        return `linear-gradient(to bottom, ${startColor}, ${endColor})`;
      }
      
      function generateItineraryTableByDay(day) {
        const tbody = document.querySelector(`.itinerary-tbody-${day}`);
        if (!tbody) return;
        
        // 清空现有内容
        tbody.innerHTML = '';
        
        // 获取对应的行程数组
        const itineraryArray = tripConfig[`itineraryDetailsDay${day}`] || [];
        
        // 检查是否有行程数据
        if (itineraryArray.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = '<td colspan="4" class="py-8 text-center text-gray-500">暂无行程安排</td>';
          tbody.appendChild(emptyRow);
          return;
        }
        
        // 遍历行程数据生成表格行
        itineraryArray.forEach((item, index) => {
          const row = document.createElement('tr');
          row.className = 'hover:bg-gray-50 transition-colors has-controls';
          
          // 创建单元格
          const weatherEmoji = getWeatherEmoji(item.weather);
          const tdBackground = getTdBackground(weatherEmoji, item.startTime, item.endTime);
          row.innerHTML = `
            <td class="py-4 px-2 editable text-center" style="background: ${tdBackground};">
              <span style="font-weight: bold;">
                <span class="block md:inline">${item.startTime}</span>
                <span class="block md:inline mx-1">-</span>
                <span class="block md:inline">${item.endTime}</span>
              </span><br>
              <span style="font-size: 0.9em;">${weatherEmoji} <span>${item.weather}</span> <span>${item.temperature}</span></span>
            </td>
            <td class="py-4 px-6 editable">${item.activity}</td>
            <td class="py-4 px-6 font-medium editable">
              <span style="font-weight: bold; cursor: pointer; text-decoration: underline; color: rgb(37, 99, 235);" onclick="navigateToAmap('${item.location}')">${item.location}</span>
            </td>
            <td class="py-4 px-6 editable">${item.notes || ''}</td>
          `;
          
          tbody.appendChild(row);
        });
      }
      
      // 生成特定day的响应式圆点
      function generateResponsiveDotsByDay(day) {
        // 获取所有匹配的容器：支持同一day下的多个分隔符
        const containers = [
          ...Array.from(document.querySelectorAll(`.responsive-dots-${day}`)),
          ...Array.from(document.querySelectorAll(`.responsive-dots-top-${day}`))
        ].filter(Boolean);
        
        if (containers.length === 0) return;
        
        // 使用requestAnimationFrame确保DOM已完全渲染
        requestAnimationFrame(() => {
          // 获取第一个容器的宽度（假设所有容器宽度相同）
          const containerWidth = containers[0].offsetWidth || 800; // 添加默认宽度避免为0
          const paddingPercentage = 8; // 对应px-[8%]
          const availableWidth = containerWidth * (1 - (paddingPercentage * 2) / 100);
          
          // 单个圆点宽度和间距设置
          const dotWidth = 20; // 估算的圆点宽度 (h-4 w-5)
          const spacing = 15; // 减小间距以显示更多圆点
          
          // 计算可容纳的圆点数量（确保至少有3个圆点以避免两端分布效果）
          let dotCount = Math.max(3, Math.floor(availableWidth / (dotWidth + spacing)));
          
          // 针对移动端进一步优化
          if (window.innerWidth < 768) {
            dotCount = Math.max(3, Math.floor(availableWidth / (dotWidth + spacing * 0.8))); // 移动端使用更小的间距
          }
          
          // 为每个容器生成相同的圆点
          containers.forEach(container => {
            // 清空容器
            container.innerHTML = '';
            
            // 生成圆点
            for (let i = 0; i < dotCount; i++) {
              const dot = document.createElement('div');
              dot.className = 'h-4 w-5 rounded-full bg-[#edeff8] border-[3px] border-gray-300 shadow-sm';
              dot.style.borderWidth = 'calc(0px + 0.05rem)';
              container.appendChild(dot);
            }
          });
          
          // 函数逻辑结束
        });
      }
      
      // 生成特定day的路线详情
      function generateRouteDetailsByDay(day) {
        const routeContainer = document.getElementById(`route${day}-stops`);
        if (!routeContainer) return;
        
        // 清空容器
        routeContainer.innerHTML = '';
        
        // 获取对应的行程数组
        const itineraryArray = tripConfig[`itineraryDetailsDay${day}`] || [];
        
        // 遍历所有行程点
        itineraryArray.forEach((item, index) => {
          // 创建行程点容器
          const itineraryDiv = document.createElement('div');
          itineraryDiv.className = 'has-controls';
          
          // 设置行程点标题
          const icon = item.icon || '📍';
          const locationLabel = item.locationLabel || getLocationLabel(item.activity);
          
          itineraryDiv.innerHTML = `
            <h4 class="font-semibold text-primary mb-2 flex items-center">
              <span class="mr-2">${icon}</span>
              <span class="editable">${locationLabel}：<span style="font-weight: bold; cursor: pointer; text-decoration: underline; color: rgb(37, 99, 235);" onclick="navigateToAmap('${item.location}')">${item.location}</span><span class="text-gray-600">(<span>${item.startTime}</span>-<span>${item.endTime}</span>)</span></span>
            </h4>
          `;
          
          routeContainer.appendChild(itineraryDiv);
          
          // 只有当有下一个行程点时，才显示路线方案
          if (index < itineraryArray.length - 1 && item.routes) {
            // 创建路线方案容器
            const routeDiv = document.createElement('div');
            routeDiv.className = 'flex items-center text-gray-500 text-sm ml-6';
            
            // 生成路线HTML
            let routesHTML = `<span class="editable">`;
            
            // 地铁方案
            if (item.routes.subway) {
              const subwayTitle = item.routes.subway.title || `🚇地铁方案（⏱️总耗时约${item.routes.subway.totalTime || 0}分钟）`;
              routesHTML += `
                <div class="route-plan subway-plan">
                  <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                    <strong>${subwayTitle}</strong>
                    <span class="toggle-icon">▼</span>
                  </div>
                  <div class="route-details" style="display: none;">
                    ${item.routes.subway.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                  </div>
                </div>
              `;
            }
            
            // 公交方案
            if (item.routes.bus) {
              const busTitle = item.routes.bus.title || `🚌公交方案（⏱️总耗时约${item.routes.bus.totalTime || 0}分钟）`;
              routesHTML += `
                <div class="route-plan bus-plan">
                  <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                    <strong>${busTitle}</strong>
                    <span class="toggle-icon">▼</span>
                  </div>
                  <div class="route-details" style="display: none;">
                    ${item.routes.bus.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                  </div>
                </div>
              `;
            }
            
            // 步行方案
            if (item.routes.walk) {
              const walkTitle = item.routes.walk.title || `🚶步行方案（⏱️总耗时约${item.routes.walk.totalTime || 0}分钟）`;
              routesHTML += `
                <div class="route-plan walk-plan">
                  <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
                    <strong>${walkTitle}</strong>
                    <span class="toggle-icon">▼</span>
                  </div>
                  <div class="route-details" style="display: none;">
                    ${item.routes.walk.steps.map(step => `<div class="route-step" style="text-align: left;">${step}</div>`).join('')}
                  </div>
                </div>
              `;
            }
            
            routesHTML += `</span>`;
            routeDiv.innerHTML = routesHTML;
            routeContainer.appendChild(routeDiv);
          }
        });
      }
      
      // 获取位置标签
      function getLocationLabel(activity) {
        if (activity.includes('午餐')) return '午餐';
        if (activity.includes('晚餐')) return '晚餐';
        if (activity.includes('住宿')) return '住宿';
        if (activity.includes('历史') || activity.includes('游览')) return '游览';
        if (activity.includes('观景')) return '观景';
        return '景点';
      }
      
      // 解析日期字符串并根据偏移量计算新日期
      function getDateWithOffset(baseDateStr, offset) {
        // 解析中文日期格式 "2025年10月29日"
        const dateMatch = baseDateStr.match(/(\d+)年(\d+)月(\d+)日/);
        if (dateMatch) {
          const year = parseInt(dateMatch[1]);
          const month = parseInt(dateMatch[2]) - 1; // 月份从0开始
          const day = parseInt(dateMatch[3]);
          
          // 创建日期对象并增加偏移天数
          const dateObj = new Date(year, month, day);
          dateObj.setDate(dateObj.getDate() + offset);
          
          // 格式化回中文日期格式
          return `${dateObj.getFullYear()}年${dateObj.getMonth() + 1}月${dateObj.getDate()}日`;
        }
        return baseDateStr;
      }
      
      // 根据日期获取星期几
      function getWeekdayFromDate(dateStr) {
        const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
        // 解析中文日期格式 "2025年10月29日"
        const dateMatch = dateStr.match(/(\d+)年(\d+)月(\d+)日/);
        if (dateMatch) {
          const year = parseInt(dateMatch[1]);
          const month = parseInt(dateMatch[2]) - 1;
          const day = parseInt(dateMatch[3]);
          const date = new Date(year, month, day);
          return `(${weekdays[date.getDay()]})`;
        }
        const date = new Date(dateStr);
        return `(${weekdays[date.getDay()]})`;
      }
      
      // 获取每天的小贴士
      function getDayTips(day) {
        const tips = [
          '上午晴朗适合拍照，下午多云带把遮阳伞，傍晚可观赏夕阳，晚上温度适宜夜游。',
          '上午气温适宜户外活动，中午注意防晒，下午可能有阵雨，建议携带雨具。',
          '全天天气较好，适合长时间户外活动，记得补充水分和涂抹防晒霜。',
          '早晨有雾，能见度较低，上午10点后逐渐好转，下午阳光充足。',
          '温度适中，是游览的好天气，傍晚可欣赏城市夜景。'
        ];
        return tips[day - 1] || '祝您旅途愉快！';
      }
      
      // 切换路线详情显示/隐藏
      function toggleRouteDetails(routePlan) {
        const details = routePlan.querySelector('.route-details');
        const icon = routePlan.querySelector('.toggle-icon');
        
        if (details.style.display === 'none' || details.style.display === '') {
          details.style.display = 'block';
          icon.textContent = '▲';
        } else {
          details.style.display = 'none';
          icon.textContent = '▼';
        }
      }
      
      // 页面加载完成后生成行程sections
      document.addEventListener('DOMContentLoaded', function() {
        generateItinerarySections();
        
        // 监听窗口大小变化，重新生成圆点
        window.addEventListener('resize', function() {
          getItineraryDays().forEach(day => {
            generateResponsiveDotsByDay(day);
          });
        });
      });
    </script>

    <!-- 住宿推荐 -->
    <section id="accommodation" class="mb-6 scroll-mt-10">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white mr-3">
          <span>🏨</span>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 editable">住宿推荐</h2>
      </div>
      
      <div class="grid gap-6" id="accommodation-container">
        <!-- 住宿推荐将通过JavaScript动态生成 -->
      </div>
      
      <script>
        // 动态生成住宿推荐内容
        document.addEventListener('DOMContentLoaded', function() {
          const accommodationContainer = document.getElementById('accommodation-container');
          if (!accommodationContainer) return;
          
          // 清空容器
          accommodationContainer.innerHTML = '';
          
          // 根据住宿区域数量计算并设置网格布局
          const accommodationCount = tripConfig.accommodations.length;
          let gridLayout = '';
          
          // 根据容器数量动态设置网格布局
          if (accommodationCount <= 1) {
            // 1个容器时，铺满显示
            gridLayout = 'grid-cols-1';
          } else if (accommodationCount <= 2) {
            // 2个容器时，每行2个
            gridLayout = 'grid-cols-1 md:grid-cols-2';
          } else if (accommodationCount <= 4) {
            // 3-4个容器时，根据容器数量平均分
            gridLayout = `grid-cols-1 md:grid-cols-${Math.ceil(accommodationCount / 2)} lg:grid-cols-${accommodationCount}`;
          } else {
            // 超过4个容器时，每行最多4个
            gridLayout = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4';
          }
          
          // 应用网格布局类
          accommodationContainer.className = `grid ${gridLayout} gap-6`;
          
          // 遍历住宿推荐数据
          tripConfig.accommodations.forEach(area => {
            // 创建住宿区域容器
            const areaDiv = document.createElement('div');
            areaDiv.className = 'bg-white rounded-xl shadow-lg p-6 hover-lift';
            
            // 设置区域标题
            areaDiv.innerHTML = `
              <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">${area.title}</h3>
              <ul class="space-y-3" id="${area.id}">
                <!-- 住宿项目将动态添加 -->
              </ul>
            `;
            
            // 获取住宿项目列表
            const itemsList = areaDiv.querySelector(`#${area.id}`);
            
            // 添加住宿项目
            area.items.forEach(item => {
              const itemLi = document.createElement('li');
              itemLi.className = 'flex items-start';
              itemLi.innerHTML = `
                <div class="text-primary mt-1 mr-3">
                  <span data-location-icon="true">${item.emoji || '🏨'}</span>
                </div>
                <div>
                  <span class="font-medium editable">${item.location}</span>
                  <p class="text-sm text-gray-600 editable">${item.description}</p>
                </div>
                <button class="view-on-map ml-auto text-blue-500 hover:text-blue-700 p-2" title="在地图上查看" data-location="${item.location}">
                  <span>🗺️</span>
                </button>
              `;
              itemsList.appendChild(itemLi);
            });
            
            accommodationContainer.appendChild(areaDiv);
          });
        });
      </script>
    </section>

    <!-- 周边景点 -->
    <section id="nearby-attractions" class="mb-6 scroll-mt-10">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white mr-3">
          <span>📍</span>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 editable">周边景点推荐</h2>
      </div>
      
      <div class="grid gap-6" id="nearby-attractions-container">
        <!-- 周边景点将通过JavaScript动态生成 -->
      </div>
      
      <script>
        // 动态生成周边景点内容
        document.addEventListener('DOMContentLoaded', function() {
          const container = document.getElementById('nearby-attractions-container');
          if (!container) return;
          
          // 清空容器
          container.innerHTML = '';
          
          // 根据景点区域数量计算并设置网格布局
          const attractionCount = tripConfig.nearbyAttractions.length;
          let gridLayout = '';
          
          // 根据容器数量动态设置网格布局
          if (attractionCount <= 1) {
            gridLayout = 'grid-cols-1';
          } else if (attractionCount <= 2) {
            gridLayout = 'grid-cols-1 md:grid-cols-2';
          } else if (attractionCount <= 4) {
            gridLayout = `grid-cols-1 md:grid-cols-${Math.ceil(attractionCount / 2)} lg:grid-cols-${attractionCount}`;
          } else {
            gridLayout = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-4';
          }
          
          // 应用网格布局类
          container.className = `grid ${gridLayout} gap-6`;
          
          // 遍历周边景点数据
          tripConfig.nearbyAttractions.forEach(area => {
            // 创建景点区域容器
            const areaDiv = document.createElement('div');
            areaDiv.className = 'bg-white rounded-xl shadow-lg p-6 hover-lift';
            
            // 设置区域标题
            areaDiv.innerHTML = `
              <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">${area.title}</h3>
              <ul class="space-y-3" id="nearby-${area.id}">
                <!-- 景点项目将动态添加 -->
              </ul>
            `;
            
            // 获取景点项目列表
            const itemsList = areaDiv.querySelector(`#nearby-${area.id}`);
            
            // 添加景点项目
            area.items.forEach(item => {
              const itemLi = document.createElement('li');
              itemLi.className = 'flex items-start';
              
              // 创建星级显示
              let starRating = '';
              if (item.scenicLevel) {
                starRating = '⭐'.repeat(Math.min(item.scenicLevel, 5));
              } else {
                starRating = '⭐';
              }
              
              itemLi.innerHTML = `
                <div class="text-primary mt-1 mr-3">
                  <span data-location-icon="true">${item.emoji || '📍'}</span>
                </div>
                <div>
                  <span class="font-medium editable">${item.location}</span>
                  <p class="text-sm text-gray-600 editable">${item.description || '值得一游的景点'}</p>
                </div>
                <button class="view-on-map ml-auto text-blue-500 hover:text-blue-700 p-2" title="在地图上查看" data-location="${item.location}" ${item.emoji ? `data-emoji="${item.emoji}"` : ''}>
                  <span>🗺️</span>
                </button>
              `;
              
              itemsList.appendChild(itemLi);
            });
            
            container.appendChild(areaDiv);
          });
          
          // 为新生成的地图查看按钮绑定事件
          document.querySelectorAll('.view-on-map[data-location]').forEach(button => {
            button.addEventListener('click', function() {
              const locationName = this.getAttribute('data-location');
              const emoji = this.getAttribute('data-emoji');
              
              // 查找地点坐标和emoji
              let locationCoords = null;
              let locationEmoji = emoji || '📍';
              
              // 首先从nearbyAttractions中查找
              tripConfig.nearbyAttractions.forEach(area => {
                const foundItem = area.items.find(item => item.location === locationName);
                if (foundItem && foundItem.locationCoords) {
                  locationCoords = foundItem.locationCoords;
                  if (foundItem.emoji) {
                    locationEmoji = foundItem.emoji;
                  }
                }
              });
              
              // 如果找到坐标，创建标记
              if (locationCoords) {
                createMarkerForButton(locationName, locationEmoji, locationCoords.lng, locationCoords.lat);
              } else {
                // 否则通过API获取坐标
                getLocationByApi(locationName, (coords) => {
                  createMarkerForButton(locationName, locationEmoji, coords.lng, coords.lat);
                });
              }
            });
          });
        });
      </script>
    </section>

    <!-- 美食推荐 -->
    <section id="food" class="mb-6 scroll-mt-10">

    <!-- 行李清单 -->
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white mr-3">
          <span>🍽️</span>
        </div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800 editable">特色美食推荐</h2>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl shadow-lg p-6 hover-lift">
          <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">必吃美食</h3>
          <ul class="space-y-3" id="food-list"></ul>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const foodList = document.getElementById('food-list');
              if (!foodList) return;
              foodList.innerHTML = '';
              const foods = (tripConfig && Array.isArray(tripConfig.foods)) ? tripConfig.foods : [];
              foods.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-start';
                li.innerHTML = `
                  <div class="text-green-500 mt-1 mr-3"><span>✅</span></div>
                  <div>
                    <span class="font-medium editable">${item.name || ''}</span>
                    <p class="text-sm text-gray-600 editable">${item.description || ''}</p>
                  </div>
                `;
                foodList.appendChild(li);
              });
            });
          </script>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 hover-lift">
          <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">推荐餐厅</h3>
          <ul class="space-y-3" id="restaurant-list"></ul>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const restaurantList = document.getElementById('restaurant-list');
              if (!restaurantList) return;
              restaurantList.innerHTML = '';
              const restaurants = (tripConfig && Array.isArray(tripConfig.restaurants)) ? tripConfig.restaurants : [];
              restaurants.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex items-start';
                const name = item.location || '';
                const desc = item.description || '';
                li.innerHTML = `
                  <span class="text-red-500 mt-1 mr-3">📍</span>
                  <div>
                    <span class="font-medium editable">${name}</span>
                    <p class="text-sm text-gray-600 editable">${desc}</p>
                  </div>
                  <button class="view-on-map ml-auto text-blue-500 hover:text-blue-700 p-2" title="在地图上查看" data-location="${name}">
                    <span>🗺️</span>
                  </button>
                `;
                restaurantList.appendChild(li);
              });
            });
          </script>
        </div>
      </div>
    </section>

    <!-- 行李清单 -->
    <section id="packing-list" class="mb-6 scroll-mt-10">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
          <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center text-white mr-3">
          <span>🧳</span>
        </div>
          <h2 class="text-2xl md:text-3xl font-bold text-gray-800 editable">行李清单</h2>
        </div>
        <div id="buttonContainer" class="flex items-center">
          <button id="addNewItemBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center mr-2" style="display: none;">
              <span class="mr-2">➕</span>添加
            </button>
            <button id="addEssentialBtn" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition-colors flex items-center">
              <span class="mr-2">✏️</span>编辑
            </button>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white rounded-xl shadow-lg p-6 hover-lift">
          <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">随身携带</h3>
          <ul class="space-y-3" id="essentials">
            <li class="flex items-start">
              <div class="mt-1 mr-3">
                <span>🆔</span>
              </div>
              <div class="flex-1">
                <span class="font-medium editable">证件</span>
                <p class="text-sm text-gray-600 editable">身份证、银行卡</p>
              </div>
              <button class="edit-essential text-blue-500 hover:text-blue-700 p-2 -mr-2" title="修改" style="display: none;">
                <span>✏️</span>
              </button>
              <button class="remove-essential text-red-500 hover:text-red-700 p-2 -mr-2" title="删除" style="display: none;">
                <span>❌</span>
              </button>
            </li>
            <li class="flex items-start">
              <div class="mt-1 mr-3">
                <span>🔋</span>
              </div>
              <div class="flex-1">
                <span class="font-medium editable">充电宝</span>
                <p class="text-sm text-gray-600 editable">充电宝、数据线</p>
              </div>
              <button class="edit-essential text-blue-500 hover:text-blue-700 p-2 -mr-2" title="修改" style="display: none;">
                <span>✏️</span>
              </button>
              <button class="remove-essential text-red-500 hover:text-red-700 p-2 -mr-2" title="删除" style="display: none;">
                <span>❌</span>
              </button>
            </li>
          </ul>
        </div>
        
        <div class="bg-white rounded-xl shadow-lg p-6 hover-lift">
          <h3 class="text-xl font-bold text-primary mb-4 border-b pb-2 editable text-center">行李物品</h3>
          <ul class="space-y-3" id="luggage-items">
            <li class="flex items-start">
              <div class="mt-1 mr-3">
                <span>🧳</span>
              </div>
              <div class="flex-1">
                <span class="font-medium editable">衣物</span>
                <p class="text-sm text-gray-600 editable">换洗衣物、外套、舒适鞋</p>
              </div>
              <button class="edit-essential text-blue-500 hover:text-blue-700 p-2 -mr-2" title="修改" style="display: none;">
                <span>✏️</span>
              </button>
              <button class="remove-essential text-red-500 hover:text-red-700 p-2 -mr-2" title="删除" style="display: none;">
                <span>❌</span>
              </button>
            </li>
            <li class="flex items-start">
              <div class="mt-1 mr-3">
                <span>🧴</span>
              </div>
              <div class="flex-1">
                <span class="font-medium editable">日用品</span>
                <p class="text-sm text-gray-600 editable">牙刷、牙膏、毛巾、洗发水</p>
              </div>
              <button class="edit-essential text-blue-500 hover:text-blue-700 p-2 -mr-2" title="修改" style="display: none;">
                <span>✏️</span>
              </button>
              <button class="remove-essential text-red-500 hover:text-red-700 p-2 -mr-2" title="删除" style="display: none;">
                <span>❌</span>
              </button>
            </li>
          </ul>
        </div>
      </div>
    </section>

  </main>

  <!-- 返回顶部按钮 - 液态玻璃效果 -->
  <button id="backToTop" class="fixed bottom-6 right-6 w-12 h-12 rounded-full flex items-center justify-center opacity-0 invisible transition-all duration-300 z-[99999]" style="z-index: 99999 !important; position: fixed !important; pointer-events: auto !important; background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1); color: #333;">
    <i class="fa fa-arrow-up"></i>
  </button>

  <style>
    /* 汉堡菜单按钮旋转动画 */
    #mobile-menu-button .fa-bars {
      transition: transform 0.3s ease;
    }
    #mobile-menu-button.rotated .fa-bars {
      transform: rotate(90deg);
    }
    
    /* 下拉菜单自上而下的动画 */
    #mobile-nav-menu {
      max-height: 0;
      overflow: hidden;
      transform-origin: top;
      transform: scaleY(0);
      transition: max-height 0.3s ease, transform 0.3s ease;
    }
    #mobile-nav-menu.show {
      max-height: 500px;
      transform: scaleY(1);
    }
    
    /* 移动端时间换行样式 */
    @media (max-width: 768px) {
      .text-gray-600 {
        display: block;
        margin-top: 4px;
        text-align: left !important;
      }
    }
    
    /* 确保所有文本左对齐 */
    .text-gray-600 {
      text-align: left;
    }
  </style>
  
  <script>
    // 汉堡菜单功能
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileNavMenu = document.getElementById('mobile-nav-menu');
    
    if (mobileMenuButton && mobileNavMenu) {
      // 移除hidden类，改用我们的动画类
      mobileNavMenu.classList.remove('hidden');
      
      // 添加底部磨砂玻璃阴影效果
      mobileNavMenu.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1)';
      
      // 点击按钮切换菜单
      mobileMenuButton.addEventListener('click', function() {
        // 切换按钮旋转类
        mobileMenuButton.classList.toggle('rotated');
        // 切换下拉菜单动画类
        mobileNavMenu.classList.toggle('show');
        
        // 控制页面滚动
        if (mobileNavMenu.classList.contains('show')) {
          // 菜单显示时禁用页面滚动
          document.body.style.overflow = 'hidden';
        } else {
          // 菜单隐藏时恢复页面滚动
          document.body.style.overflow = '';
        }
      });
      
      // 点击导航链接后关闭菜单
      mobileNavMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', function() {
          mobileMenuButton.classList.remove('rotated');
          mobileNavMenu.classList.remove('show');
          // 恢复页面滚动
          document.body.style.overflow = '';
        });
      });
      
      // 点击页面其他地方关闭菜单
      document.addEventListener('click', function(event) {
        if (!mobileMenuButton.contains(event.target) && 
            !mobileNavMenu.contains(event.target) && 
            mobileNavMenu.classList.contains('show')) {
          mobileMenuButton.classList.remove('rotated');
          mobileNavMenu.classList.remove('show');
          // 恢复页面滚动
          document.body.style.overflow = '';
        }
      });
      
      // 移动端：点击nav的任意区域自动触发button按钮功能
      // 为移动端导航菜单内部div添加滚动样式
          const mobileNavDiv = document.getElementById('mobile-nav');
          if (mobileNavDiv) {
            // 设置最大高度和垂直滚动
            mobileNavDiv.style.maxHeight = '70vh';
            mobileNavDiv.style.overflowY = 'auto';
            // 添加滚动条样式
            mobileNavDiv.style.scrollbarWidth = 'thin';
            mobileNavDiv.style.scrollbarColor = 'rgba(30, 136, 229, 0.5) rgba(30, 136, 229, 0.1)';
          }
          
          const navElement = document.getElementById('daohanglan');
      if (navElement) {
        navElement.addEventListener('click', function(event) {
          // 确保点击的不是按钮本身（避免重复触发）
          // 确保点击的不是导航链接（避免点击链接后菜单状态混乱）
          // 确保点击的不是移动导航菜单容器
          if (event.target !== mobileMenuButton && 
              !mobileMenuButton.contains(event.target) &&
              !mobileNavMenu.contains(event.target) &&
              !event.target.closest('a') &&
              window.innerWidth < 768) { // 仅在移动端视图下触发
            mobileMenuButton.click();
          }
        });
      }
      
      // 创建共享函数用于获取页面导航项
      function getSharedNavigationItems() {
        // 动态获取页面所有section元素
        const sections = document.querySelectorAll('section[id]');
        const navItems = [];
        
        // 预定义的section显示文本映射（优先级高）
        const sectionTextMap = {
          'map': '行程地图',
          'day1': tripConfig.daysNumber === 1 ? '一日游' : '第1天行程',
          'day2': '第2天行程',
          'day3': '第3天行程',
          'day4': '第4天行程',
          'day5': '第5天行程',
          'day6': '第6天行程',
          'day7': '第7天行程',
          'day8': '第8天行程',
          'day9': '第9天行程',
          'day10': '第10天行程',
          'day11': '第11天行程',
          'day12': '第12天行程',
          'day13': '第13天行程',
          'day14': '第14天行程',
          'day15': '第15天行程',
          'day16': '第16天行程',
          'day17': '第17天行程',
          'day18': '第18天行程',
          'day19': '第19天行程',
          'day20': '第20天行程',
          'day21': '第21天行程',
          'day22': '第22天行程',
          'day23': '第23天行程',
          'day24': '第24天行程',
          'day25': '第25天行程',
          'day26': '第26天行程',
          'day27': '第27天行程',
          'day28': '第28天行程',
          'day29': '第29天行程',
          'day30': '第30天行程',
          'day31': '第31天行程',
          
          'accommodation': '推荐住宿',
          'food': '推荐美食',
          'packing-list': '行李清单'
        };
        
        // 为每个section创建导航项
        sections.forEach(section => {
          const id = section.id;
          // 获取显示文本的优先级：1. 映射表 2. section的h2标题 3. section的id
          let text = sectionTextMap[id] || '';
          
          if (!text) {
            // 尝试从section中获取h2标题作为显示文本
            const h2 = section.querySelector('h2');
            if (h2) {
              text = h2.textContent.trim();
            } else {
              // 如果没有h2标题，使用id作为默认文本
              text = id.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            }
          }
          
          navItems.push({ id, text });
        });
        
        return navItems;
      }
      
      // 动态显示当前页面所处的导航位置信息
      const currentLocationDiv = document.getElementById('current-location');
      if (currentLocationDiv) {
        // 监听滚动事件，更新当前位置显示
        function updateCurrentLocation() {
          // 使用共享函数获取导航项
          const navItems = getSharedNavigationItems();
          
          // 如果没有找到任何section，使用默认显示
          if (navItems.length === 0) {
            currentLocationDiv.textContent = '行程地图';
            return;
          }
          
          let currentSection = navItems[0]; // 默认显示第一个部分
          
          // 先检查哪个section在视口中或最靠近视口顶部
          for (let i = navItems.length - 1; i >= 0; i--) {
            const element = document.getElementById(navItems[i].id);
            if (element) {
              const rect = element.getBoundingClientRect();
              // 如果section的顶部在视口内或在视口上方一点点
              if (rect.top <= 100) {
                currentSection = navItems[i];
                break;
              }
            }
          }
          
          // 更新移动端显示文本
          if (window.innerWidth < 768) {
            currentLocationDiv.textContent = currentSection.text;
          }
          
          // PC端导航栏高亮功能
          if (window.innerWidth >= 768) {
            const desktopNavLinks = document.querySelectorAll('#desktop-nav a');
            desktopNavLinks.forEach(link => {
              // 移除所有链接的高亮样式
              link.style = '';
              link.className = 'px-4 py-2 font-bold text-center';
              
              // 为当前位置的链接添加高亮样式
              if (link.getAttribute('href') === `#${currentSection.id}`) {
                link.style.cssText = `
                  border-radius: 12px;
                  padding: 8px 16px;
                  backdrop-filter: blur(12px);
                  border: 1px solid rgba(255, 255, 255, 0.3);
                  white-space: nowrap;
                  min-width: 60px;
                  text-align: center;
                  background-color: rgba(30, 136, 229, 0.6);
                  color: white;
                  box-shadow: rgba(30, 136, 229, 0.2) 0px 4px 12px, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset;
                  font-weight: bold;
                `;
              }
            });
          }
        }
        
        // 初始加载和滚动时更新
        updateCurrentLocation();
        window.addEventListener('scroll', updateCurrentLocation);
      }
      
      // 页面加载完成后，统一更新所有导航链接的标题
        document.addEventListener('DOMContentLoaded', function() {
          // 更新桌面端导航链接
          // 使用属性选择器来正确选择带有Tailwind类的元素
          const desktopNav = document.querySelector('div[class*="hidden"][class*="md:flex"][class*="space-x-6"]');
          if (desktopNav) {
            // 清空现有内容
            desktopNav.innerHTML = '';
            
            // 使用统一数据源创建导航链接
            const navItems = getSharedNavigationItems();
            navItems.forEach(item => {
            const link = document.createElement('a');
            link.href = `#${item.id}`;
              link.className = 'px-4 py-2 font-bold text-center';
              link.textContent = item.text;
            
            // 添加点击事件实现带偏移的滚动
            link.addEventListener('click', function(e) {
              e.preventDefault(); // 阻止默认跳转行为
              const targetElement = document.getElementById(item.id);
              if (targetElement) {
                const offset = 80; // 偏移固定值
                const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - offset;
                
                // 平滑滚动到目标位置
                window.scrollTo({
                  top: targetPosition,
                  behavior: 'smooth'
                });
              }
            });
            
            desktopNav.appendChild(link);
          });
        }
        
        // 更新移动端导航菜单
          const mobileNavContent = document.querySelector('#mobile-nav-menu > div');
          if (mobileNavContent) {
            // 清空现有内容
            mobileNavContent.innerHTML = '';
            
            // 使用统一数据源创建移动端导航链接
            const navItems = getSharedNavigationItems();
            navItems.forEach((item, index) => {
            const link = document.createElement('a');
            link.href = `#${item.id}`;
            // 除了最后一个链接外，其他都添加底边框
              if (index < navItems.length - 1) {
                link.className = 'px-4 py-2 font-bold text-center border-b border-gray-200';
              } else {
                link.className = 'px-4 py-2 font-bold text-center';
              }
              link.textContent = item.text;
            
            // 添加点击事件以关闭菜单并实现带偏移的滚动
            link.addEventListener('click', function(e) {
              e.preventDefault(); // 阻止默认跳转行为
              
              // 关闭菜单
              mobileMenuButton.classList.remove('rotated');
              mobileNavMenu.classList.remove('show');
              
              // 实现带偏移的滚动
              const targetElement = document.getElementById(item.id);
              if (targetElement) {
                const offset = 70; // 跳转偏移固定值
                const targetPosition = targetElement.getBoundingClientRect().top + window.pageYOffset - offset;
                
                // 平滑滚动到目标位置
                window.scrollTo({
                  top: targetPosition,
                  behavior: 'smooth'
                });
              }
            });
            
            mobileNavContent.appendChild(link);
          });
        }
      });
    }
    
    // 返回顶部按钮
    const backToTopButton = document.getElementById('backToTop');
    
    window.addEventListener('scroll', () => {
      // 滑动页面时自动收回导航菜单
      if (mobileNavMenu && mobileNavMenu.classList.contains('show')) {
        mobileMenuButton.classList.remove('rotated');
        mobileNavMenu.classList.remove('show');
      }
      
      if (window.pageYOffset > 300) {
        backToTopButton.classList.remove('opacity-0', 'invisible');
        backToTopButton.classList.add('opacity-100', 'visible');
      } else {
        backToTopButton.classList.remove('opacity-100', 'visible');
        backToTopButton.classList.add('opacity-0', 'invisible');
      }
      
      // 导航栏滚动效果
        const nav = document.querySelector('nav');
      if (window.pageYOffset > 100) {
        nav.classList.add('py-2');
        nav.classList.remove('py-3');
      } else {
        nav.classList.add('py-3');
        nav.classList.remove('py-2');
      }
    });
    
    backToTopButton.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
    
    // 平滑滚动
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        
        document.querySelector(this.getAttribute('href')).scrollIntoView({
          behavior: 'smooth'
        });
      });
    });

    // 智能编辑功能
    function removeRow(button) {
      const row = button.closest('tr');
      row.remove();
    }
    
    // 设备识别功能 - 判断PC端还是移动端
    function isMobileDevice() {
      // 使用UA字符串判断是否为移动设备
      return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // 高德地图跳转功能
    function setupMapNavigationButtons() {
      // 为所有地图查看按钮添加点击事件
      document.querySelectorAll('.view-on-map').forEach(button => {
        button.addEventListener('click', function() {
          const locationName = this.getAttribute('data-location');
          navigateToAmap(locationName);
        });
      });
    }
    
    // 导航到高德地图
    function navigateToAmap(locationName) {
      console.log(`导航到地点: ${locationName}`);
      
      // 预定义一些地点的坐标（作为备用）
      const predefinedPositions = {
        '三坊七巷': {lat: 26.0838, lng: 119.2965}, 
        '安泰楼酒家': {lat: 26.080774, lng: 119.300361},
        '安泰楼酒家(三坊七巷店)': {lat: 26.080774, lng: 119.300361},
        '上下杭历史文化街区': {lat: 26.052103, lng: 119.304687},
        '青年广场': {lat: 26.049044, lng: 119.309939},
        '台江万达': {lat: 26.054302, lng: 119.341885},
        '福州泰禾铂尔曼酒店': {lat: 26.095799, lng: 119.291334},
        '福州西湖大酒店': {lat: 26.095799, lng: 119.291334},
        '福州冠城大通首玺公寓': {lat: 26.074229, lng: 119.30182},
        '聚春园': {lat: 26.0827, lng: 119.2962},
        '老药洲街美食': {lat: 26.0667, lng: 119.3203},
        '同利肉燕老铺': {lat: 26.0783, lng: 119.2965}
      };
      
      // 检查是否有预定义坐标
      const position = predefinedPositions[locationName];
      
      
      // 首先尝试使用POI搜索功能
      searchPOI(locationName, function(poiData) {
        // 判断是否为移动设备
        if (isMobileDevice()) {
          // 移动端 - 使用高德地图App URI，根据规范添加callnative=1
          let amapUrl;
          
          // 优先使用POI搜索结果
          if (poiData && poiData.position) {
            amapUrl = `amapuri://viewMap?sourceApplication=福州旅游攻略&poiname=${encodeURIComponent(locationName)}&lat=${poiData.position.lat}&lon=${poiData.position.lng}&dev=0&callnative=1`;
          } else if (position) {
            // 其次使用预定义坐标
            amapUrl = `amapuri://viewMap?sourceApplication=福州旅游攻略&poiname=${encodeURIComponent(locationName)}&lat=${position.lat}&lon=${position.lng}&dev=0&callnative=1`;
          } else {
            // 最后使用关键词搜索
            amapUrl = `amapuri://keywordNavi?sourceApplication=福州旅游攻略&keyword=${encodeURIComponent(locationName)}&dev=0&callnative=1`;
          }
          
          // 尝试打开App，如果失败则跳转至Web端
          window.location.href = amapUrl;
          
          // 延迟检查是否跳转成功
          setTimeout(() => {
            // 如果500ms内未跳转成功，则跳转到Web端
            const webUrl = generateWebUrl(locationName, poiData || position);
            window.location.href = webUrl;
          }, 500);
        } else {
          // PC端 - 打开Web端高德地图
          const webUrl = generateWebUrl(locationName, poiData || position);
          window.open(webUrl, '_blank');
        }
      });
    }
    
    // 使用PoiPicker.searchByKeywords搜索POI
    function searchPOI(keyword, callback) {
      console.log(`搜索POI: ${keyword}`);
      
      // 检查是否启用POI搜索
      if (!window.AMAP_API_CONFIG.enablePOISearch) {
        console.log('POI搜索已禁用，返回null (测试模式)');
        callback(null);
        return;
      }
      
      // 由于直接在前端使用PoiPicker可能受限制，这里我们使用MCP/API的方式
      // 使用高德地图的Web服务API进行POI搜索
      const apiKey = '9fc145b7b1ba7bc1dcc7d8a50a6e96b2'; // 从页面头部获取的API Key
      const city = '福州'; // 默认搜索城市
      
      // 构造搜索请求URL
      const searchUrl = `https://restapi.amap.com/v3/place/text?key=${apiKey}&keywords=${encodeURIComponent(keyword)}&city=${encodeURIComponent(city)}&offset=1&page=1&output=json`;
      
      // 发送API请求
      fetch(searchUrl)
        .then(response => response.json())
        .then(data => {
          if (data.status === '1' && data.pois && data.pois.length > 0) {
            const poi = data.pois[0];
            const locationData = {
              id: poi.id,
              name: poi.name,
              address: poi.address,
              position: {
                lng: parseFloat(poi.location.split(',')[0]),
                lat: parseFloat(poi.location.split(',')[1])
              },
              category: poi.type
            };
            console.log('POI搜索成功:', locationData);
            callback(locationData);
          } else {
            console.log('POI搜索无结果或失败:', data);
            callback(null);
          }
        })
        .catch(error => {
          console.error('POI搜索请求失败:', error);
          // 如果API调用失败，使用回调函数返回null
          callback(null);
        });
    }
    
    // 生成Web端地图URL
    function generateWebUrl(locationName, poiData) {
      let url = `https://ditu.amap.com/search?query=${encodeURIComponent(locationName)}&city=福州`;
      
      if (poiData && poiData.position) {
        // 如果有精确坐标，可以在URL中添加位置信息
        url = `https://ditu.amap.com/place/${poiData.id || ''}?zoom=16&center=${poiData.position.lng},${poiData.position.lat}&name=${encodeURIComponent(locationName)}`;
      }
      
      return url;
    }
    
    // 为地名span元素添加地图导航功能
    function setupLocationLinks() {
      // 查找所有包含地点名称的span元素（通常有font-weight: bold样式）
      document.querySelectorAll('span[style*="font-weight: bold"]').forEach(span => {
        const locationName = span.textContent.trim();
        
        // 检查是否为有效的地点名称（避免包含特殊字符或过短的文本）
        // 移除括号检查，因为地点名称中经常包含括号（如分店信息）
        if (locationName.length > 1 && !locationName.includes('：') && !locationName.includes(':')) {
          // 为span添加点击事件
          span.style.cursor = 'pointer';
          span.style.textDecoration = 'underline';
          span.style.color = '#2563eb'; // 蓝色文本
          
          span.addEventListener('click', function(event) {
            event.stopPropagation(); // 阻止事件冒泡
            navigateToAmap(locationName);
          });
        }
      });
    }
    
    // 页面加载完成后设置地图导航按钮和地点链接
    document.addEventListener('DOMContentLoaded', function() {
      setupMapNavigationButtons();
      setupLocationLinks();
    });

  </script>

  <script>
    // 初始化天气信息显示
    function initializeWeather() {
      // 从tripConfig对象中获取天气数据
      const condition = tripConfig.day1 && tripConfig.day1.weather || tripConfig.day1Weather || tripConfig.weather || '多云';
      const temperature = tripConfig.day1 && tripConfig.day1.temperature || tripConfig.day1Temperature || tripConfig.temperature || '17°C~23°C';
      
      // 更新页面上的天气信息
      const conditionElement = document.querySelector('#weather-condition .weather-data');
      const tempElement = document.querySelector('#temperature-range .weather-data');
      const weatherContainer = document.querySelector('#weather-condition');
      
      // 使用getWeatherEmoji函数获取正确的emoji（支持复合天气）
      const emoji = getWeatherEmoji(condition);
      
      // 更新天气emoji
      if (weatherContainer) {
        // 查找或创建emoji文本节点
        const textNode = Array.from(weatherContainer.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
        if (textNode) {
          textNode.textContent = `${emoji} 当地天气：`;
        } else if (weatherContainer.firstChild) {
          // 如果没有纯文本节点，创建新的结构
          weatherContainer.innerHTML = `<span class="editable mr-2">${emoji} 当地天气：<span class="weather-data" id="trip-weather"></span></span>`;
        }
      }
      
      // 更新天气和温度显示
      if (conditionElement) {
        conditionElement.textContent = condition;
      }
      
      if (tempElement) {
        tempElement.textContent = temperature;
      }
    }
    
    // 根据日期计算星期几并更新显示
    function updateWeekDay() {
      const dateElement = document.querySelector('div.flex.items-center:nth-child(1) span:nth-child(2)');
      const weekDayElement = dateElement.nextElementSibling;
      
      if (dateElement && weekDayElement) {
        const dateStr = dateElement.textContent.trim();
        
        try {
          // 解析日期字符串 "YYYY年MM月DD日"
          const match = dateStr.match(/(\d{4})年(\d{1,2})月(\d{1,2})日/);
          if (match) {
            const year = parseInt(match[1]);
            const month = parseInt(match[2]) - 1; // JavaScript的月份从0开始
            const day = parseInt(match[3]);
            
            const date = new Date(year, month, day);
            
            // 检查日期是否有效
            if (!isNaN(date.getTime())) {
              const weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
              const weekDay = weekDays[date.getDay()];
              weekDayElement.textContent = weekDay;
            } else {
              weekDayElement.textContent = '无效日期';
              console.error('无效的日期:', dateStr);
            }
          } else {
            weekDayElement.textContent = '格式错误';
            console.error('日期格式错误:', dateStr);
          }
        } catch (error) {
          weekDayElement.textContent = '获取失败';
          console.error('计算星期几出错:', error);
        }
      }
    }
    
    // 日期变化时更新星期几
    function setupDateObserver() {
      const dateElement = document.querySelector('div.flex.items-center:nth-child(1) span:nth-child(2)');
      if (dateElement) {
        const observer = new MutationObserver(() => {
          console.log('日期已更改，更新星期几...');
          updateWeekDay();
        });
        
        observer.observe(dateElement, {
          characterData: true,
          subtree: true,
          childList: true
        });
      }
    }
    
    // 加载高德地图API
    function loadAmapScript() {
      // 检查是否启用地图加载
      if (!window.AMAP_API_CONFIG.enableMapLoading) {
        console.log('高德地图加载已禁用 (测试模式)');
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-gray-600 p-4">
              <span class="text-6xl text-gray-400 mb-4">🗺️</span>
              <h3 class="text-lg font-semibold mb-2">地图加载已禁用</h3>
              <p class="text-center">测试模式：已禁用高德地图API加载以节省资源</p>
            </div>
          `;
        }
        return;
      }
      
      // 添加调试信息
      console.log('开始加载高德地图API...');
       
      const mapContainer = document.getElementById('map-container');
      if (mapContainer) {
        mapContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full text-gray-600 p-4">
            <span class="text-6xl text-primary mb-4">🔄</span>
            <h3 class="text-lg font-semibold mb-2">地图加载中...</h3>
            <p class="text-center">正在连接高德地图服务器，请稍候...</p>
          </div>
        `;
      }
       
      // 移除之前可能存在的地图脚本
      const existingScript = document.querySelector('script[src*="webapi.amap.com"]');
      if (existingScript) {
        document.head.removeChild(existingScript);
      }
       
      const script = document.createElement('script');
      // 使用高德地图JavaScript API v2版本
      script.src = 'https://webapi.amap.com/maps?v=2.0&key=9fc145b7b1ba7bc1dcc7d8a50a6e96b2&callback=initMap';
      script.onerror = function() {
        console.error('高德地图API加载失败！');
        if (mapContainer) {
          mapContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-gray-600 p-4">
              <span class="text-6xl text-red-500 mb-4">❌</span>
              <h3 class="text-lg font-semibold mb-2 text-red-500">地图加载失败</h3>
              <p class="text-center">无法连接到高德地图服务器</p>
              <p class="mt-2 text-sm">请检查：</p>
              <ul class="text-sm text-left mt-1">
                <li>网络连接是否正常</li>
                <li>API密钥是否有效</li>
                <li>域名是否在授权列表中</li>
              </ul>
              <button id="retry-map" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors">
                重试加载地图
              </button>
            </div>
          `;
           
          // 添加重试按钮事件
          document.getElementById('retry-map').addEventListener('click', loadAmapScript);
        }
      };
      document.head.appendChild(script);
    }
    
    // 地图初始化函数
    window.initMap = function() {
      console.log('高德地图API v2加载成功，开始初始化地图...');
      
      const mapContainer = document.getElementById('map-container');
      if (!mapContainer) {
        console.error('地图容器未找到！');
        return;
      }
      
      try {
        // 创建高德地图实例，设置中心点和缩放级别
        const map = new AMap.Map('map-container', {
          center: [119.296411,26.074286], // 福州市中心点经纬度
          zoom: 11, // 地图缩放级别
          viewMode: '3D', // 使用2D视图
          showLabel: true // 显示地图标签
        });
        
        // 将地图实例保存到全局，以便在按钮点击事件中访问
        window.amapInstance = map;
        
        // 添加地图类型切换控件
        AMap.plugin(['AMap.MapType'], function() {
          const mapType = new AMap.MapType({
            showTraffic: false, // 不显示实时交通
            showRoad: false,    // 不显示道路
            defaultType: 0,     // 默认显示标准地图
            mapTypes: ['amap://styles/normal', 'amap://styles/satellite', 'amap://styles/roadnet'] // 标准地图、卫星地图、路网地图
          });
          
          // 添加到地图
          map.addControl(mapType);
          
          // 地图加载完成后将地图类型控件移到正上方居中位置
          map.on('complete', function() {
            setTimeout(function() {
              const mapTypeControl = document.querySelector('.amap-control.amap-maptype');
              if (mapTypeControl) {
                mapTypeControl.style.position = 'absolute';
                mapTypeControl.style.bottom = 'auto';
                mapTypeControl.style.right = 'auto';
                mapTypeControl.style.top = '10px';
                mapTypeControl.style.left = '50%';
                mapTypeControl.style.transform = 'translateX(-50%)';
                mapTypeControl.style.zIndex = '99';
              }
            }, 100);
          });
        });
        
        // 创建自定义指北针容器
        const createCustomCompass = () => {
          // 移除可能存在的默认罗盘
          const existingCompass = document.querySelector('.amap-compass');
          if (existingCompass) {
            existingCompass.parentNode.removeChild(existingCompass);
          }
          
          // 创建指北针容器
          const compassContainer = document.createElement('div');
          compassContainer.id = 'custom-compass';
          compassContainer.className = 'custom-compass';
          compassContainer.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            width: 40px;
            height: 40px;
            backdrop-filter: blur(12px);
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 8px, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.3);
          `;
          
          // 添加北文字（同时作为指针）
          const northText = document.createElement('span');
          northText.textContent = '北';
          northText.className = 'compass-pointer';
          northText.style.cssText = `
            font-size: 16px;
            font-weight: 900;
            color: #1890ff;
            transition: transform 0.3s ease;
            transform-origin: center;
          `;
          
          compassContainer.appendChild(northText);
          
          // 添加点击事件 - 点击后恢复朝北
          compassContainer.addEventListener('click', function() {
            map.setRotation(0);
            northText.style.transform = 'rotate(0deg)';
          });
          
          // 监听地图旋转事件，更新北字旋转角度
          map.on('mapmove', function() {
            const rotation = map.getRotation();
            northText.style.transform = `rotate(${rotation}deg)`;
          });
          
          return compassContainer;
        };
        
        // 将自定义指北针添加到地图容器
        const mapContainer = document.getElementById('map-container');
        const customCompass = createCustomCompass();
        mapContainer.appendChild(customCompass);
        
        // 在指北针下方添加emoji容器
        const emojiContainer1 = document.createElement('div');
        emojiContainer1.style.cssText = `
          position: absolute;
          top: 60px;
          right: 10px;
          width: 40px;
          height: 40px;
          backdrop-filter: blur(12px);
          background-color: rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 8px, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          border: 1px solid rgba(255, 255, 255, 0.3);
          font-size: 20px;
        `;
        emojiContainer1.textContent = '🚥';
        mapContainer.appendChild(emojiContainer1);
        
        const emojiContainer2 = document.createElement('div');
        emojiContainer2.style.cssText = `
          position: absolute;
          top: 110px;
          right: 10px;
          width: 40px;
          height: 40px;
          backdrop-filter: blur(12px);
          background-color: rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 8px, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100;
          border: 1px solid rgba(255, 255, 255, 0.3);
          font-size: 20px;
        `;
        emojiContainer2.textContent = '🛣️';
        mapContainer.appendChild(emojiContainer2);
        
        // 初始化路况和路网图层
        let trafficLayer = null;
        let roadNetLayer = null;
        let isTrafficVisible = false;
        let isRoadNetVisible = false;
        
        // 为路况按钮添加点击事件
        emojiContainer1.addEventListener('click', function() {
          if (!trafficLayer) {
            // 首次点击时创建路况图层
            AMap.plugin(['AMap.TileLayer.Traffic'], function() {
              trafficLayer = new AMap.TileLayer.Traffic({
                zIndex: 10, // 设置图层层级
                zooms: [4, 18] // 设置显示级别范围
              });
              
              // 显示路况图层
              trafficLayer.setMap(map);
              isTrafficVisible = true;
              emojiContainer1.style.backgroundColor = 'rgba(30, 136, 229, 0.6)'; // 蓝色半透明背景
              emojiContainer1.style.color = 'white'; // 白色文字
              emojiContainer1.style.fontWeight = 'bold'; // 加粗字体
              console.log('路况图层已显示');
            });
          } else {
            // 切换路况图层显示状态
            if (isTrafficVisible) {
              trafficLayer.setMap(null);
              isTrafficVisible = false;
              emojiContainer1.style.backgroundColor = 'rgba(255, 255, 255, 0.3)'; // 恢复默认样式
              emojiContainer1.style.color = ''; // 恢复默认文字颜色
              emojiContainer1.style.fontWeight = ''; // 恢复默认字体
              console.log('路况图层已隐藏');
            } else {
              trafficLayer.setMap(map);
              isTrafficVisible = true;
              emojiContainer1.style.backgroundColor = 'rgba(30, 136, 229, 0.6)'; // 蓝色半透明背景
              emojiContainer1.style.color = 'white'; // 白色文字
              emojiContainer1.style.fontWeight = 'bold'; // 加粗字体
              console.log('路况图层已显示');
            }
          }
        });
        
        // 为路网按钮添加点击事件
        emojiContainer2.addEventListener('click', function() {
          if (!roadNetLayer) {
            // 首次点击时创建路网图层
            AMap.plugin(['AMap.TileLayer.RoadNet'], function() {
              roadNetLayer = new AMap.TileLayer.RoadNet({
                zIndex: 9, // 设置图层层级
                zooms: [4, 18] // 设置显示级别范围
              });
              
              // 显示路网图层
              roadNetLayer.setMap(map);
              isRoadNetVisible = true;
              emojiContainer2.style.backgroundColor = 'rgba(30, 136, 229, 0.6)'; // 蓝色半透明背景
              emojiContainer2.style.color = 'white'; // 白色文字
              emojiContainer2.style.fontWeight = 'bold'; // 加粗字体
              console.log('路网图层已显示');
            });
          } else {
            // 切换路网图层显示状态
            if (isRoadNetVisible) {
              roadNetLayer.setMap(null);
              isRoadNetVisible = false;
              emojiContainer2.style.backgroundColor = 'rgba(255, 255, 255, 0.3)'; // 恢复默认样式
              emojiContainer2.style.color = ''; // 恢复默认文字颜色
              emojiContainer2.style.fontWeight = ''; // 恢复默认字体
              console.log('路网图层已隐藏');
            } else {
              roadNetLayer.setMap(map);
              isRoadNetVisible = true;
              emojiContainer2.style.backgroundColor = 'rgba(30, 136, 229, 0.6)'; // 蓝色半透明背景
              emojiContainer2.style.color = 'white'; // 白色文字
              emojiContainer2.style.fontWeight = 'bold'; // 加粗字体
              console.log('路网图层已显示');
            }
          }
        });
        
        // 添加定位控件
        AMap.plugin(['AMap.Geolocation'], function() {
          // 将geolocation定义为全局变量，确保自定义按钮可以访问
          window.geolocation = new AMap.Geolocation({
            enableHighAccuracy: true, // 是否使用高精度定位
            timeout: 10000, // 超过10秒后停止定位
            buttonPosition: 'LT', // 定位按钮放在左上角
            buttonOffset: new AMap.Pixel(10, 10), // 定位按钮偏移量
            zoomToAccuracy: true, // 定位成功后是否自动缩放
            showCircle: true, // 显示定位精度圈
            panToLocation: true // 定位成功后将定位结果放到地图中心点
          });
          
          // 确保定位控件显示在canvas左上角
          window.geolocation.on('complete', function() {
            setTimeout(function() {
              const geolocationControl = document.querySelector('.amap-control.amap-geolocation');
              if (geolocationControl) {
                geolocationControl.style.bottom = 'auto';
                geolocationControl.style.right = 'auto';
                geolocationControl.style.top = '10px';
                geolocationControl.style.left = '10px';
              }
            }, 100);
          });
          
          // 地图加载完成后也确保定位控件位置正确
          map.on('complete', function() {
            setTimeout(function() {
              const geolocationControl = document.querySelector('.amap-control.amap-geolocation');
              if (geolocationControl) {
                geolocationControl.style.bottom = 'auto';
                geolocationControl.style.right = 'auto';
                geolocationControl.style.top = '10px';
                geolocationControl.style.left = '10px';
              }
            }, 100);
          });
          
          // 将定位控件添加到地图
          map.addControl(window.geolocation);
          
          // 隐藏原生定位控件div但保持其功能可用
          setTimeout(function() {
            const geolocationControl = document.querySelector('.amap-control.amap-geolocation');
            if (geolocationControl) {
              geolocationControl.style.display = 'none';
              console.log('原生定位控件已隐藏，但功能仍可用');
            }
          }, 100);
          
          // 可以在这里添加定位事件监听
          window.geolocation.on('complete', function(data) {
            console.log('定位成功:', data);
          });
          
          window.geolocation.on('error', function(data) {
            console.log('定位失败:', data);
          });
          
          // 在canvas左侧创建新的定位按钮
          setTimeout(function() {
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
              // 创建新的定位按钮div
              const newLocationButton = document.createElement('div');
              newLocationButton.id = 'custom-location-button';
              newLocationButton.className = 'amap-control custom-location-btn absolute z-10';
              newLocationButton.style = 'inset: 10px auto auto 10px; height: 40px; width: 40px; border-radius: 50%; backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.3); box-shadow: rgba(0, 0, 0, 0.2) 0px 4px 8px, rgba(255, 255, 255, 0.1) 0px 0px 0px 1px inset; z-index: 100;';
              newLocationButton.innerHTML = '<i class="fa fa-crosshairs text-primary" style="font-size: 24px;"></i>';
              
              // 添加点击事件，实现与定位控件相同的功能
              newLocationButton.addEventListener('click', function() {
                // 使用全局定位控件进行定位，完全实现AMap.Geolocation的功能
                if (window.geolocation) {
                  // 模拟原生定位按钮的完整行为
                  window.geolocation.getCurrentPosition();
                  console.log('手动触发定位，完全实现AMap.Geolocation功能');
                }
              });
              
              // 添加到地图容器
              mapContainer.appendChild(newLocationButton);
              console.log('自定义定位按钮已创建');
            }
          }, 1000);
        });
        
        // 添加地图加载完成事件监听器
        map.on('complete', function() {
          console.log('地图加载完成，开始显示地图界面...');
          // 注意：不在这里移除加载界面，等待所有位置坐标获取完成后再移除
          // 确保地图容器可见
          mapContainer.style.display = 'block';
          
          // 显示第1天标签页的内容
          const day1Tab = document.getElementById('day1-tab');
          const day1Content = document.getElementById('day1-content');
          if (day1Tab && day1Content) {
            showTab('day1-tab', 'day1-content');
          }
        });
        
        // markerMap已在文件顶部定义为全局变量
        

        
        // 获取地点描述信息
        const getLocationDescription = (locationName) => {
          const descriptions = {
            '三坊七巷': '福州历史文化街区，明清古建筑群',
            '上下杭历史文化街区': '福州传统商业区，拥有丰富的历史遗迹',
            '鼓山旅游景区': '福州著名风景区，拥有涌泉寺等古迹',
            '西湖公园': '福州历史悠久的古典园林，风景优美',
            '林则徐纪念馆': '纪念民族英雄林则徐的专题博物馆',
            '福道': '城市森林步道，可俯瞰福州全景',
            '烟台山商业漫步街区': '福州近代建筑博物馆，拥有众多欧式建筑',
            '台江万达': '福州现代化商业中心，集购物、餐饮、娱乐于一体'
          };
          return descriptions[locationName] || '福州的一个地点';
        };
        
        // 获取地点分类
        const getLocationCategory = (locationName) => {
          const categories = {
            '三坊七巷': ['day1', 'recommend'],
            '上下杭历史文化街区': ['day1', 'recommend'],
            '林则徐纪念馆': ['day1', 'recommend'],
            '烟台山商业漫步街区': ['day1', 'recommend'],

          };
          return categories[locationName] || ['recommend'];
        };
        
        // 存储悬浮按钮的引用
        const floatingButtons = {};
        
        // 设置按钮激活状态样式
        function setButtonActive(button) {
          button.style.backgroundColor = 'rgba(30, 136, 229, 0.6)';
          button.style.color = 'white';
          button.style.boxShadow = '0 4px 12px rgba(30, 136, 229, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1) inset';
          button.style.backdropFilter = 'blur(12px)';
          button.style.border = '1px solid rgba(255, 255, 255, 0.3)';
          button.style.fontWeight = 'bold';
        }
        
        // 设置按钮默认状态样式
        function setButtonDefault(button) {
          button.style.backgroundColor = 'rgba(255, 255, 255, 0.3)';
          button.style.color = '#334155';
          button.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(255, 255, 255, 0.1) inset';
          button.style.backdropFilter = 'blur(12px)';
          button.style.border = '1px solid rgba(255, 255, 255, 0.4)';
          button.style.fontWeight = 'bold';
        }
        
        // 设置按钮悬停状态样式
        function setButtonHover(button) {
          button.style.backgroundColor = 'rgba(255, 255, 255, 0.25)';
          button.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.15) inset';
        }
        
        // 将标签移动到地图底部并设置悬浮置顶
        function moveTabsToMapBottom() {
          // 获取所有需要移动的标签
          const day1Tab = document.getElementById('day1-tab');
          
          const recommendTab = document.getElementById('recommend-tab');
          const hotelTab = document.getElementById('hotel-tab');
          // 获取地图容器
          const mapContainer = document.getElementById('map-container');
          
          if (mapContainer) {
            // 创建一个新的悬浮容器来容纳所有标签
            const floatingContainer = document.createElement('div');
            // 使用横向滚动容器以适应不同屏幕宽度，底部与canvas对齐
            floatingContainer.className = 'absolute bottom-0 left-0 right-0 z-50 flex justify-center overflow-x-auto scrollbar-hide';
            floatingContainer.style.padding = '0 10px 10px 10px'; // 添加底部padding避免内容紧贴底部
            
            // 创建按钮包裹容器，用于居中显示
            const buttonsWrapper = document.createElement('div');
            buttonsWrapper.className = 'flex space-x-2'; // 默认为居中显示
            floatingContainer.appendChild(buttonsWrapper);
            
            // 在DOM更新后检查是否需要滚动，如果需要则添加左侧padding
            setTimeout(() => {
              if (floatingContainer.scrollWidth > floatingContainer.clientWidth) {
                buttonsWrapper.classList.add('pl-10'); // 只有在需要滚动时才添加左侧空间
              }
            }, 0);
            
            // 收集所有标签和它们的点击事件
            const tabs = [];
            
            getItineraryDays().forEach(day => {
              tabs.push({
                id: `day${day}-tab`,
                text: getItineraryDays().length === 1 ? '一日游' : `第${day}天`,
                clickHandler: () => {
                  ensureDayContentExists(day);
                  showTab(`day${day}-tab`, `day${day}-content`);
                  showDayItinerary(`day${day}`);
                }
              });
            });
            
            // 添加其他固定标签按钮
            tabs.push(
              { id: 'hotel-tab', text: '推荐住宿', clickHandler: () => { 
                showTab('hotel-tab', 'hotel-content');
                // 更新map-info-paragraph内容
                const infoParagraph = document.getElementById('map-info-paragraph');
                if (infoParagraph) {
                  infoParagraph.innerHTML = '<span class="mr-1 text-blue-500">ℹ️</span> 推荐住宿包括从五星级酒店到特色民宿的多种选择，分布在福州市的各个主要区域，方便游览。点击住宿按钮可查看详情并定位到地图上。';
                }
              } },
              { id: 'nearby-tab', text: '周边景点', clickHandler: () => { 
                showTab('nearby-tab', 'nearby-content');
                // 更新map-info-paragraph内容
                const infoParagraph = document.getElementById('map-info-paragraph');
                if (infoParagraph) {
                  infoParagraph.innerHTML = '<span class="mr-1 text-blue-500">ℹ️</span> 周边景点汇集了福州市及周边地区值得游览的景点，包括城市周边公园和郊县特色景点。点击景点按钮可查看详情并定位到地图上。';
                }
              } }
            );
            
            // 确保天数内容容器存在的辅助函数
            function ensureDayContentExists(day) {
              const contentId = `day${day}-content`;
              let contentElement = document.getElementById(contentId);
              
              if (!contentElement) {
                const tabsContainer = document.querySelector('#day1-content')?.parentElement || 
                                     document.querySelector('#map-options') || 
                                     document.createElement('div');
                contentElement = document.createElement('div');
                contentElement.id = contentId;
                contentElement.className = 'overflow-x-auto whitespace-nowrap py-1 px-1 hidden';
                const locationsContainer = document.createElement('div');
                locationsContainer.id = `day${day}-locations`;
                locationsContainer.className = 'flex space-x-2';
                contentElement.appendChild(locationsContainer);
                const anchor = document.getElementById('nearby-content') || document.getElementById('hotel-content') || (document.getElementById('map-info-paragraph') && document.getElementById('map-info-paragraph').parentElement);
                if (anchor && tabsContainer.contains(anchor)) {
                  tabsContainer.insertBefore(contentElement, anchor);
                } else {
                  tabsContainer.appendChild(contentElement);
                }
              } else {
                const tabsContainer = document.querySelector('#day1-content')?.parentElement || document.querySelector('#map-options');
                const anchor = document.getElementById('nearby-content') || document.getElementById('hotel-content') || (document.getElementById('map-info-paragraph') && document.getElementById('map-info-paragraph').parentElement);
                if (tabsContainer && anchor && tabsContainer.contains(anchor)) {
                  tabsContainer.insertBefore(contentElement, anchor);
                }
              }
              
              // 生成地点按钮
              generateLocationButtons(day);
            }
            
            // 为每个标签创建按钮并添加到悬浮容器
            tabs.forEach((tab, index) => {
              // 创建按钮
              const button = document.createElement('div');
              button.className = 'px-4 py-2 rounded-lg cursor-pointer transition-all duration-300 whitespace-nowrap';
              
              // 存储按钮引用，使用标签ID作为键
              floatingButtons[tab.id] = button;
              
              // 设置基础样式
              button.style.borderRadius = '12px';
              button.style.padding = '8px 16px';
              button.style.backdropFilter = 'blur(12px)';
              button.style.border = '1px solid rgba(255, 255, 255, 0.3)';
              button.style.whiteSpace = 'nowrap'; // 确保文字不换行
              button.style.minWidth = '60px'; // 设置最小宽度防止文字竖向显示
              button.style.textAlign = 'center'; // 文字居中显示
              
              if (index === 0) {
                // 第1天标签设置为激活状态
                setButtonActive(button);
              } else {
                // 其他标签设置为默认状态
                setButtonDefault(button);
              }
              
              // 为所有标签添加悬停效果
              button.addEventListener('mouseenter', function() {
                // 只有在未激活状态下才改变颜色
                if (this.style.backgroundColor !== 'rgba(30, 136, 229, 0.6)' && this.style.backgroundColor !== 'rgb(30, 136, 229)' && this.style.backgroundColor !== '#1E88E5') {
                  setButtonHover(this);
                }
              });
              button.addEventListener('mouseleave', function() {
                // 只有在未激活状态下才恢复颜色
                if (this.style.backgroundColor !== 'rgba(30, 136, 229, 0.6)' && this.style.backgroundColor !== 'rgb(30, 136, 229)' && this.style.backgroundColor !== '#1E88E5') {
                  setButtonDefault(this);
                }
              });
              
              // 设置文本内容
              button.textContent = tab.text;
              
              // 绑定点击事件
              button.addEventListener('click', tab.clickHandler);
              
              // 添加到按钮包裹容器中
              buttonsWrapper.appendChild(button);
            });
            
            // 添加到地图容器中
            mapContainer.appendChild(floatingContainer);
          }
        }
        
        // 等待地图完全加载后执行移动操作
        setTimeout(moveTabsToMapBottom, 1000);
        
        // 定义全局变量用于跟踪位置获取状态
        let pendingLocations = new Set();
        let failedLocations = new Map(); // 存储获取失败的位置及重试次数
        const MAX_RETRY = 3; // 最大重试次数
        const RETRY_DELAY = 1000; // 重试延迟时间(ms)
        
        // 从行程数据中的locationCoords获取位置坐标
        function getLocationByApi(locationName, callback) {
          console.log(`从行程数据获取位置: ${locationName}`);
          
          // 标记为正在获取中
          pendingLocations.add(locationName);
          
          // 确保locationName有效
          if (!locationName || locationName.trim() === '') {
            console.error('无效的位置名称');
            handleLocationResult(locationName, callback, [119.2965, 26.0753], false);
            return;
          }
          
          // 从行程数据中查找对应的坐标
          let position = null;
          
          // 首先检查是否为住宿地点，从accommodations数据中查找
          for (const area of tripConfig.accommodations) {
            for (const hotel of area.items) {
              if (hotel.location === locationName && hotel.locationCoords && hotel.locationCoords.lng && hotel.locationCoords.lat) {
                // 确保坐标不为0
                if (hotel.locationCoords.lng !== 0 && hotel.locationCoords.lat !== 0) {
                  position = [hotel.locationCoords.lng, hotel.locationCoords.lat];
                  break;
                }
              }
            }
            if (position) break;
          }
          
          // 遍历所有行程天数，优先使用itineraryDetailsDay*中的坐标
          if (!position) {
            const days = getItineraryDays();
            for (const d of days) {
              const arr = tripConfig[`itineraryDetailsDay${d}`] || [];
              for (const item of arr) {
                if (item.location === locationName && item.locationCoords && item.locationCoords.lng && item.locationCoords.lat) {
                  if (item.locationCoords.lng !== 0 && item.locationCoords.lat !== 0) {
                    position = [item.locationCoords.lng, item.locationCoords.lat];
                    break;
                  }
                }
              }
              if (position) break;
            }
          }
          
          // 如果找到坐标
          if (position) {
            console.log('从行程数据获取坐标成功:', position);
            handleLocationResult(locationName, callback, position, true);
          } else {
            console.warn(`行程数据中未找到位置: ${locationName}，使用默认坐标`);
            // 使用默认坐标（福州市中心）
            handleLocationResult(locationName, callback, [119.2965, 26.0753], false);
          }
        }
        
        // 处理位置获取结果
        function handleLocationResult(locationName, callback, position, success) {
          // 从待处理列表中移除
          pendingLocations.delete(locationName);
          // 移除失败记录
          failedLocations.delete(locationName);
          
          // 执行回调
          callback(position);
          
          // 检查是否所有位置都已获取完成
          checkAllLocationsCompleted();
        }
        
        // 由于现在从行程数据获取坐标，重试函数简化为直接返回默认坐标
        function retryLocationFetch(locationName, callback) {
          console.log(`位置: ${locationName} 未在行程数据中找到，使用默认坐标`);
          // 直接返回默认坐标（福州市中心）
          handleLocationResult(locationName, callback, [119.2965, 26.0753], false);
        }
        
        // 检查是否所有位置都已获取完成
        function checkAllLocationsCompleted() {
          if (pendingLocations.size === 0 && failedLocations.size === 0) {
            console.log('所有位置坐标获取完成，显示地图');
            // 所有位置都已处理完成，显示地图
            showMapAfterAllLocationsLoaded();
          }
        }
        
        // 所有位置加载完成后显示地图
         function showMapAfterAllLocationsLoaded() {
           // 获取加载相关元素
           const loadingDiv = document.getElementById('map-loading');
           const spinner = document.getElementById('loading-spinner');
           const successCircle = document.getElementById('success-circle');
           const checkmark = document.getElementById('checkmark');
           const ripple1 = document.getElementById('ripple1');
           const ripple2 = document.getElementById('ripple2');
           const ripple3 = document.getElementById('ripple3');
           const loadingText = document.getElementById('loading-text');
           
           // 恢复页面滚动的函数（支持跨平台）
           const restoreScroll = () => {
             if (loadingDiv) {
               // 1. 恢复body的样式
               document.body.style.overflow = loadingDiv.dataset.originalBodyOverflow !== undefined ? loadingDiv.dataset.originalBodyOverflow : '';
               document.body.style.position = loadingDiv.dataset.originalBodyPosition !== undefined ? loadingDiv.dataset.originalBodyPosition : '';
               document.body.style.height = loadingDiv.dataset.originalBodyHeight !== undefined ? loadingDiv.dataset.originalBodyHeight : '';
               document.body.style.width = loadingDiv.dataset.originalBodyWidth !== undefined ? loadingDiv.dataset.originalBodyWidth : '';
               
               // 2. 恢复html的样式
               document.documentElement.style.overflow = loadingDiv.dataset.originalHtmlOverflow !== undefined ? loadingDiv.dataset.originalHtmlOverflow : '';
               
               // 3. 移除触摸事件监听器
               if (loadingDiv._preventScroll) {
                 document.removeEventListener('touchmove', loadingDiv._preventScroll, { passive: false });
                 document.removeEventListener('wheel', loadingDiv._preventScroll, { passive: false });
                 delete loadingDiv._preventScroll;
               }
             }
           };
           
           // 添加事件监听器阻止滚动
            if (loadingDiv && loadingDiv._preventScroll) {
              document.addEventListener('touchmove', loadingDiv._preventScroll, { passive: false }); // 阻止移动端触摸滚动
              document.addEventListener('wheel', loadingDiv._preventScroll, { passive: false }); // 阻止鼠标滚轮滚动
            }
           
           if (loadingDiv) {
             // 更改文本为加载完成，并添加淡入动画
             const textContent = document.getElementById('loading-text-content');
             const loadingDots = document.querySelector('.loading-dots');
             
             // 隐藏省略号
             if (loadingDots) {
               loadingDots.style.display = 'none';
             }
             
             // 修改文本并添加淡入动画
             if (textContent) {
               textContent.textContent = '加载完成';
               textContent.style.animation = 'text-fade-in 0.5s ease-out forwards';
             } else {
               loadingText.textContent = '加载完成';
             }
              
             // 隐藏旋转器
             setTimeout(() => {
               spinner.style.display = 'none';
               
               // 显示成功圆形
               successCircle.style.animation = 'success-circle-appear 0.5s forwards';
               
               // 延迟显示打勾（Apple Pay风格的弹跳动画）
               setTimeout(() => {
                 checkmark.style.animation = 'checkmark-bounce 0.6s forwards';
                 
                 // 添加放射状波纹效果（Apple Pay风格）
                 setTimeout(() => {
                   ripple1.style.animation = 'ripple-expand 0.8s forwards';
                   setTimeout(() => {
                     ripple2.style.animation = 'ripple-expand 0.8s forwards';
                     setTimeout(() => {
                       ripple3.style.animation = 'ripple-expand 0.8s forwards';
                       
                       // 延迟移除加载提示，让用户看到完整的Apple Pay风格动画
                       setTimeout(() => {
                         // 恢复页面滚动功能
                         restoreScroll();
                         
                         // 移除加载提示
                         if (loadingDiv && loadingDiv.parentNode) {
                           loadingDiv.parentNode.removeChild(loadingDiv);
                         }
                       }, 1200);
                     }, 200);
                   }, 200);
                 }, 300);
               }, 400);
             }, 300);
           }
           
           // 确保地图容器可见
           mapContainer.style.display = 'block';
           
           // 先隐藏所有标记点
           markerMap.forEach((info) => {
             info.marker.setMap(null);
           });
           
           // 然后显示第1天标签页的内容和标记点
           showTab('day1-tab', 'day1-content');
         }
        
        // 为按钮创建地图标记
        function createMarkerForButton(locationName, index) {
          // 首先尝试从配置文件中获取坐标和emoji
          let position = null;
          let emoji = '📍'; // 默认emoji
          
          // 先从accommodations中查找
          for (let accommodationGroup of tripConfig.accommodations) {
            for (let item of accommodationGroup.items) {
              if (item.location === locationName) {
                if (item.locationCoords) {
                  position = [item.locationCoords.lng, item.locationCoords.lat];
                }
                if (item.emoji) {
                  emoji = item.emoji;
                }
                break;
              }
            }
          }
          
          // 如果在accommodations中没找到，再从nearbyAttractions中查找
          if (!position) {
            for (let attractionGroup of tripConfig.nearbyAttractions) {
              for (let item of attractionGroup.items) {
                if (item.location === locationName) {
                  if (item.locationCoords) {
                    position = [item.locationCoords.lng, item.locationCoords.lat];
                  }
                  if (item.emoji) {
                    emoji = item.emoji;
                  }
                  break;
                }
              }
            }
          }
          
          // 获取分类和描述
          const category = getLocationCategory(locationName);
          const description = getLocationDescription(locationName);
          
          // 如果从配置文件中找到了坐标，直接使用
          if (position) {
            // 从待处理列表中移除
            pendingLocations.delete(locationName);
            // 移除失败记录
            failedLocations.delete(locationName);
            // 处理标记
            processMarker(position, locationName, category, description, emoji);
            // 检查是否所有位置都已获取完成
            checkAllLocationsCompleted();
          } else {
            // 如果没找到，通过API获取
            getLocationByApi(locationName, function(apiPosition) {
              processMarker(apiPosition, locationName, category, description, emoji);
            });
          }
        }

        
        // 处理标记的通用函数
        function processMarker(position, locationName, category, description, emoji) {
          // 使用对应emoji作为标记图标
          const pointMarker = new AMap.Marker({
            position: position,
            title: locationName,
            visible: true, // 默认显示所有标记，由showTab函数控制实际显示和隐藏
            content: `<div style="font-size: 24px; pointer-events: none; cursor: default;">${emoji}</div>` // 使用对应emoji作为标记内容，设置为不可点击
          });
          
          // 添加信息窗口，包含对应的emoji
          const infoWindow = new AMap.InfoWindow({
            content: `<div style="padding:10px;"><div class="location-info-line"><span class="mr-1 text-blue-500">${emoji}</span><h3>${locationName}</h3></div><p>${description}</p></div>`
          });
          
          // 移除点击事件，使标记完全不可点击
          // 之前的代码:
          /*
          pointMarker.on('click', function() {
            // infoWindow.open(map, position); // 取消默认信息窗口
            showLocationInfo(locationName, position);
          });
          */
          
          // 添加到地图
          map.add(pointMarker);
          
          // 添加到映射中，包含分类信息
          markerMap.set(locationName, { 
            marker: pointMarker, 
            position: position, 
            infoWindow: infoWindow, 
            category: category 
          });
        }
        
        // 获取所有需要创建标记的地点名称
        const locationNames = new Set();
        
        // 收集所有data-location属性的地点
        document.querySelectorAll('[data-location]').forEach(button => {
          const locationName = button.getAttribute('data-location');
          if (locationName && locationName.trim() !== '') {
            locationNames.add(locationName);
            console.log(`添加景点: ${locationName}`);
          }
        });
        
        // 收集所有data-hotel属性的住宿地点
        document.querySelectorAll('[data-hotel]').forEach(button => {
          const hotelName = button.getAttribute('data-hotel');
          if (hotelName && hotelName.trim() !== '') {
            locationNames.add(hotelName);
            console.log(`添加住宿: ${hotelName}`);
          }
        });
        
        // 初始化待处理位置集合
        locationNames.forEach(name => {
          pendingLocations.add(name);
        });
        
        // 为每个地点创建标记，添加500毫秒间隔
        let index = 0;
        const locationsArray = Array.from(locationNames);
        let currentIndex = 0;
        const INTERVAL_DELAY = 0; // 间隔延迟时间(ms)
        
        function createMarkerWithDelay() {
          if (currentIndex < locationsArray.length) {
            const locationName = locationsArray[currentIndex];
            // 对于住宿地点使用0作为index以确保使用不带序号的图标
            const isHotel = document.querySelector(`[data-hotel="${locationName}"]`) !== null;
            createMarkerForButton(locationName, isHotel ? 0 : index);
            if (!isHotel) index++;
            
            currentIndex++;
            // 添加延迟后处理下一个位置
            setTimeout(createMarkerWithDelay, INTERVAL_DELAY);
          }
        }
        
        // 开始创建标记
        createMarkerWithDelay();
        
        // 添加调试信息
        console.log('开始获取位置信息，总共需要获取', locationNames.size, '个标记点');
        
        // 如果没有位置需要处理，直接显示地图
        if (locationNames.size === 0) {
          console.log('没有位置需要处理，直接显示地图');
          setTimeout(function() {
            checkAllLocationsCompleted();
          }, 500);
        }
        
        // 保持地图容器可见，不隐藏地图canvas
        mapContainer.style.display = 'block';
        
        // 保存原始滚动状态，支持跨平台（PC、移动、微信等）
        const originalBodyStyle = {
          overflow: document.body.style.overflow,
          position: document.body.style.position,
          height: document.body.style.height,
          width: document.body.style.width
        };
        
        const originalHtmlStyle = {
          overflow: document.documentElement.style.overflow
        };
        
        // 跨平台禁用页面滚动
        // 1. 禁用body滚动
        document.body.style.overflow = 'hidden';
        document.body.style.position = 'fixed';
        document.body.style.height = '100%';
        document.body.style.width = '100%';
        
        // 2. 禁用html滚动（某些浏览器需要）
        document.documentElement.style.overflow = 'hidden';
        
        // 3. 阻止移动端触摸滚动事件
        const preventScroll = (e) => {
          e.preventDefault();
          e.stopPropagation();
          return false;
        };
        
        // 添加一个加载状态提示，覆盖在地图上方
        const loadingDiv = document.createElement('div');
        loadingDiv.id = 'map-loading';
        loadingDiv.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          display: flex;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          text-align: center;
          background: rgba(255, 255, 255, 0.2);
          backdrop-filter: blur(10px);
          -webkit-backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          z-index: 99999;
          pointer-events: auto;
          touch-action: none; /* 防止触摸事件 */
        `;
        
        // 存储原始样式状态到loadingDiv上，以便后续恢复
        loadingDiv.dataset.originalBodyOverflow = originalBodyStyle.overflow;
        loadingDiv.dataset.originalBodyPosition = originalBodyStyle.position;
        loadingDiv.dataset.originalBodyHeight = originalBodyStyle.height;
        loadingDiv.dataset.originalBodyWidth = originalBodyStyle.width;
        loadingDiv.dataset.originalHtmlOverflow = originalHtmlStyle.overflow;
        
        // 存储阻止滚动的函数引用
        loadingDiv._preventScroll = preventScroll;
        loadingDiv.innerHTML = `
          <div id="apple-pay-animation" style="position: relative; width: 80px; height: 80px; margin: 0 auto 20px; display: flex; justify-content: center; align-items: center;">
            <!-- 加载旋转器 -->
            <div id="loading-spinner" style="width: 60px; height: 60px; border-radius: 50%; border: 3px solid rgba(0, 122, 255, 0.2); border-top-color: #007AFF; animation: spin 1s linear infinite;"></div>
            
            <!-- 成功圆形容器 -->
            <div id="success-circle" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; background-color: #34C759; transform: scale(0); opacity: 0;"></div>
            
            <!-- 打勾图标 -->
            <svg id="checkmark" width="30" height="30" viewBox="0 0 24 24" fill="none" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0); opacity: 0;">
              <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="white"/>
            </svg>
            
            <!-- 波纹效果 -->
            <div id="ripple1" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; border: 3px solid #34C759; transform: scale(0); opacity: 0;"></div>
            <div id="ripple2" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; border: 3px solid #34C759; transform: scale(0); opacity: 0;"></div>
            <div id="ripple3" style="position: absolute; width: 60px; height: 60px; border-radius: 50%; border: 3px solid #34C759; transform: scale(0); opacity: 0;"></div>
          </div>
          <p id="loading-text" style="font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', sans-serif; font-size: 20px; color: #333333; font-weight: 500; letter-spacing: -0.3px; margin-top: 16px;">
            <span id="loading-text-content">正在加载地图，请稍候</span>
            <span class="loading-dots">
              <span>.</span>
              <span>.</span>
              <span>.</span>
            </span>
          </p>
        `;
        
        // 添加Apple Pay风格的动画
        const style = document.createElement('style');
        style.textContent = `
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
          
          @keyframes success-circle-appear {
            0% { transform: scale(0); opacity: 0; }
            60% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
          }
          
          /* 打字机效果 */
          .loading-dots span {
            display: inline-block;
            opacity: 0;
            animation: dots-blink 1.4s infinite both;
          }
          
          .loading-dots span:nth-child(1) {
            animation-delay: 0s;
          }
          
          .loading-dots span:nth-child(2) {
            animation-delay: 0.4s;
          }
          
          .loading-dots span:nth-child(3) {
            animation-delay: 0.8s;
          }
          
          @keyframes dots-blink {
            0%, 60%, 100% {
              opacity: 0;
              transform: translateY(0);
            }
            30% {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          /* 文字出现动画 */
          @keyframes text-appear {
            from {
              opacity: 0;
              transform: translateY(5px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
          
          @keyframes text-fade-in {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          
          @keyframes checkmark-bounce {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(0.9); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
          }
          
          @keyframes ripple-expand {
            0% { transform: scale(0); opacity: 1; }
            70% { opacity: 0.7; }
            100% { transform: scale(2.5); opacity: 0; }
          }
        `;
        document.head.appendChild(style);
        mapContainer.parentNode.appendChild(loadingDiv);
        
        // 为右侧快捷点击栏添加事件监听器
        document.querySelectorAll('[data-location]').forEach(button => {
          button.addEventListener('click', function() {
            const locationName = this.getAttribute('data-location');
            
            // 检查标记是否已创建
            if (markerMap.has(locationName)) {
              const markerInfo = markerMap.get(locationName);
              
              // 移动地图中心到该位置，并设置为街道级视角
              window.amapInstance.panTo(markerInfo.position);
              window.amapInstance.setZoom(16);
              // 移除动画效果，因为marker对象没有setAnimation方法
              
              // 关闭所有信息窗口
              window.amapInstance.clearInfoWindow();
              
              // 在p标签区域显示详细信息
              showLocationInfo(locationName, markerInfo.position);
            } else {
              // 如果标记尚未创建，先创建再执行操作
              createMarkerForButton(locationName, 0);
              
              // 增加等待时间，确保有足够时间获取位置
              setTimeout(() => {
                const markerInfo = markerMap.get(locationName);
                if (markerInfo) {
                  window.amapInstance.panTo(markerInfo.position);
                  // 关闭所有信息窗口
                  window.amapInstance.clearInfoWindow();
                  // 在p标签区域显示详细信息
                  showLocationInfo(locationName, markerInfo.position);
                }
              }, 500);
            }
          });
        });
        
        // showLocationInfo函数已在文件顶部定义为全局函数

          // 为所有标签添加切换功能
        function showTab(tabId, contentId) {
          // 重置所有标签和内容
          const tabs = [];
          const contents = [];
          
          getItineraryDays().forEach(day => {
            tabs.push(`day${day}-tab`);
            contents.push(`day${day}-content`);
          });
          
          // 添加固定标签和内容
            tabs.push('nearby-tab', 'hotel-tab');
          contents.push('nearby-content', 'hotel-content');
          
          tabs.forEach(id => {
            const tab = document.getElementById(id);
            if (tab) {
              tab.classList.remove('bg-primary', 'text-white');
              tab.classList.add('bg-gray-100', 'hover:bg-primary/80', 'hover:text-white');
            }
            
            // 重置对应的悬浮按钮样式 - iOS液态玻璃效果
            if (floatingButtons[id]) {
              setButtonDefault(floatingButtons[id]);
            }
          });
          
          contents.forEach(id => {
            const content = document.getElementById(id);
            if (content) {
              content.classList.add('hidden');
              
              // 清除当前内容容器中所有按钮的选中状态
              const buttons = content.querySelectorAll('button');
              buttons.forEach(button => {
                button.classList.remove('bg-secondary', 'text-white');
              });
            }
          });
          
          // 显示选中的标签和内容
          const selectedTab = document.getElementById(tabId);
          if (selectedTab) {
            selectedTab.classList.add('bg-primary', 'text-white');
            selectedTab.classList.remove('bg-gray-100', 'hover:bg-primary/80', 'hover:text-white');
          }
          
          // 设置对应的悬浮按钮为选中样式 - iOS液态玻璃效果
          if (floatingButtons[tabId]) {
            setButtonActive(floatingButtons[tabId]);
          }
          
          // 确保内容容器存在
          const contentElement = document.getElementById(contentId);
          if (contentElement) {
            contentElement.classList.remove('hidden');
            // 重新设置按钮选中状态，确保动态生成的按钮也能正常工作
            setupButtonSelection();
          }
          
          // 根据选中的标签显示对应的地图标记点
          const selectedContent = document.getElementById(contentId);
          
          // 获取当前标签页内容中所有的地点名称
          const visibleLocations = new Set();
          
          // 统一处理所有标签页的标记点显示
          if (contentId === 'hotel-content') {
            // 获取住宿内容中的所有酒店
            const hotelButtons = selectedContent.querySelectorAll('[data-hotel]');
            hotelButtons.forEach(button => {
              const hotelName = button.getAttribute('data-hotel');
              visibleLocations.add(hotelName);
            });
          } else {
            // 收集其他标签页的所有地点
            const locationButtons = selectedContent.querySelectorAll('[data-location]');
            locationButtons.forEach(button => {
              const locationName = button.getAttribute('data-location');
              visibleLocations.add(locationName);
            });
          }
          
          console.log(`标签页 ${tabId} 选中，需要显示的地点:`, Array.from(visibleLocations));
          
          // 遍历所有标记点，只显示当前标签页中存在的标记点
          markerMap.forEach((info, title) => {
            if (visibleLocations.has(title)) {
              info.marker.setMap(map);
              console.log(`显示标记: ${title}`);
            } else {
              info.marker.setMap(null);
              console.log(`隐藏标记: ${title}`);
            }
          });
          
          // 自动定位到第一个地点/酒店
          if (contentId === 'hotel-content') {
            const hotelButtons = selectedContent.querySelectorAll('[data-hotel]');
            if (hotelButtons.length > 0) {
              const firstHotelName = hotelButtons[0].getAttribute('data-hotel');
              // 延迟检查标记，确保创建完成并显示
              setTimeout(() => {
                if (markerMap.has(firstHotelName)) {
                  const markerInfo = markerMap.get(firstHotelName);
                  // 确保标记已添加到地图
                  markerInfo.marker.setMap(map);
                  // 移动地图中心到该标记位置
                  map.panTo(markerInfo.position);
                  console.log(`自动定位到酒店: ${firstHotelName}`);
                }
              }, 200);
            }
          } else {
            // 其他标签页自动定位到第一个地点
            const locationButtons = selectedContent.querySelectorAll('[data-location]');
            if (locationButtons.length > 0) {
              const firstLocationName = locationButtons[0].getAttribute('data-location');
              // 延迟检查标记，确保创建完成并显示
              setTimeout(() => {
                if (markerMap.has(firstLocationName)) {
                  const markerInfo = markerMap.get(firstLocationName);
                  // 确保标记已添加到地图
                  markerInfo.marker.setMap(map);
                  // 移动地图中心到该标记位置
                  map.panTo(markerInfo.position);
                  console.log(`自动定位到地点: ${firstLocationName}`);
                }
              }, 200);
            }
          }
           
          // 强制刷新地图canvas，确保标签切换时地图正确渲染
          map.render();
          
          // 点击标签页时设置地图为区级别视角
          map.setZoom(12);
        }
        
        // 为每个标签添加点击事件
        document.getElementById('day1-tab').addEventListener('click', function() {
          showTab('day1-tab', 'day1-content');
          // 显示第1天的地点流程
          showDayItinerary('day1');
        });
        
        
        document.getElementById('day2-tab').addEventListener('click', function() {
          showTab('day2-tab', 'day2-content');
          // 显示第2天的地点流程
          showDayItinerary('day2');
        });
        
        
        document.getElementById('nearby-tab').addEventListener('click', function() {
          showTab('nearby-tab', 'nearby-content');
          // 显示周边景点的小贴士
          setTimeout(() => {
            // 确保所有周边景点都通过POI API获取位置并创建标记
            const locationButtons = document.getElementById('nearby-locations').querySelectorAll('button[data-location]');
            locationButtons.forEach((button) => {
              const locationName = button.getAttribute('data-location');
              if (!markerMap.has(locationName)) {
                createMarkerForButton(locationName, 0); // 使用0确保使用不带序号的图标
              }
            });
          }, 300);
        });
        
        
        document.getElementById('hotel-tab').addEventListener('click', function() {
          showTab('hotel-tab', 'hotel-content');
          // 显示推荐住宿的小贴士
          setTimeout(() => {
            // 确保所有推荐住宿都通过POI API获取位置并创建标记
            const hotelButtons = document.getElementById('hotel-locations').querySelectorAll('button[data-hotel]');
            hotelButtons.forEach((button) => {
              const hotelName = button.getAttribute('data-hotel');
              if (!markerMap.has(hotelName)) {
                createMarkerForButton(hotelName, 0); // 使用0确保使用不带序号的图标
              }
            });
          }, 300);
        });
        

        
        // 周边景点按钮的事件监听器已经在前面的通用选择器中处理了
        

        
        // 为推荐住宿按钮添加点击事件（与周边景点保持一致的跳转形式）
        document.querySelectorAll('[data-hotel]').forEach(button => {
          button.addEventListener('click', function() {
            const hotelName = this.getAttribute('data-hotel');
            
            // 检查标记是否已创建
            if (markerMap.has(hotelName)) {
              const markerInfo = markerMap.get(hotelName);
              
              // 移动地图中心到该位置，并设置为街道级视角
              map.panTo(markerInfo.position);
              map.setZoom(16);
              // 移除动画效果，因为marker对象没有setAnimation方法
              
              // 关闭所有信息窗口
              map.clearInfoWindow();
              
              // 在p标签区域显示详细信息
              showLocationInfo(hotelName, markerInfo.position);
            } else {
              // 如果标记尚未创建，先创建再执行操作
              createMarkerForButton(hotelName, 0);
              
              // 增加等待时间，确保有足够时间获取位置
              setTimeout(() => {
                const markerInfo = markerMap.get(hotelName);
                if (markerInfo) {
                  map.panTo(markerInfo.position);
                  // 关闭所有信息窗口
                  map.clearInfoWindow();
                  // 在p标签区域显示详细信息
                  showLocationInfo(hotelName, markerInfo.position);
                }
              }, 500);
            }
          });
        });
      } catch (error) {
        console.error('地图初始化过程中发生错误:', error);
        mapContainer.innerHTML = `
          <div class="flex flex-col items-center justify-center h-full text-gray-600 p-4">
            <span class="text-6xl text-red-500 mb-4">❌</span>
            <h3 class="text-lg font-semibold mb-2 text-red-500">地图初始化失败</h3>
            <p class="text-center">初始化过程中发生错误</p>
            <p class="mt-2 text-sm">错误信息: ${error.message}</p>
            <button id="retry-init-map" class="mt-4 bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary-dark transition-colors">
              重试初始化地图
            </button>
          </div>
        `;
        
        // 添加重试按钮事件
        document.getElementById('retry-init-map').addEventListener('click', function() {
          loadAmapScript();
        });
      }
    };
    
    // 将地图标记图标替换为数字图标
    function replaceMapMarkersWithNumbers() {
      // 处理第1天的地点列表
      const day1Locations = document.getElementById('day1-locations');
      if (day1Locations) {
        const day1Buttons = day1Locations.querySelectorAll('button');
        day1Buttons.forEach((button, index) => {
          const mapIcon = button.querySelector('[data-location-icon="true"]');
          if (mapIcon) {
            // 创建数字图标元素
            const numberIcon = document.createElement('span');
            numberIcon.className = 'inline-block w-5 h-5 bg-primary text-white text-xs rounded-full text-center leading-5 mr-2';
            numberIcon.textContent = index + 1;
            
            // 替换图标
            button.replaceChild(numberIcon, mapIcon);
          }
        });
      }
      
      
    }
    
    // 设置按钮点击选中效果和单选功能
    function setupButtonSelection() {
      // 为所有地点容器分别设置选择功能
      const containers = [];
      
      // 添加所有天数的地点容器
      getItineraryDays().forEach(day => {
        containers.push(`day${day}-locations`);
      });
      
      // 添加固定容器
      containers.push('recommend-locations', 'hotel-content');
      
      containers.forEach(containerId => {
        const container = document.getElementById(containerId);
        if (container) {
          const buttons = container.querySelectorAll('button');
          
          buttons.forEach(button => {
            button.addEventListener('click', function() {
              // 移除当前容器中所有按钮的选中状态
              buttons.forEach(btn => {
                btn.classList.remove('bg-secondary', 'text-white');
              });
              
              // 为当前点击的按钮添加选中状态
              this.classList.add('bg-secondary', 'text-white');
            });
          });
        }
      });
    }

    // 显示日期行程信息
        function showDayItinerary(dayId) {
          // 通过唯一ID选择p标签
          const infoParagraph = document.getElementById('map-info-paragraph');
          if (!infoParagraph) {
              console.error('未能找到显示信息的p标签');
              return;
          }
          
          // 先显示加载中状态
            infoParagraph.innerHTML = '<span class="mr-1 text-blue-500">🔄</span> 获取行程信息中...';
          
          // 查找对应的行程section
          const daySection = document.getElementById(dayId);
          if (!daySection) {
              infoParagraph.innerHTML = '<span class="mr-1 text-red-500">❌</span> 未找到对应行程信息';
              return;
          }
          
          // 查找表格
          const table = daySection.querySelector('table');
          if (!table) {
              infoParagraph.innerHTML = '<span class="mr-1 text-red-500">❌</span> 行程信息格式不正确';
              return;
          }
          
          // 获取表格中的所有行
          const rows = table.querySelectorAll('tbody tr');
          if (rows.length === 0) {
              infoParagraph.innerHTML = '<span class="mr-1 text-red-500">❌</span> 暂无行程信息';
              return;
          }
          
          // 从配置中获取行程地点，按照配置文件中的顺序
          const dayNumber = parseInt(dayId.replace('day', ''), 10);
          const itineraryArray = tripConfig[`itineraryDetailsDay${dayNumber}`] || [];
          
          // 提取地点并保持原始顺序
          const locations = itineraryArray.map(item => item.location).filter(location => location);
          
          const dayLabel = (tripConfig.daysNumber === 1 ? `${tripConfig.days}行程` : `第${dayNumber}天行程`);
          let itineraryContent = `<span class="mr-1 text-blue-500">📅</span><strong>${dayLabel}：${locations.join(' ➡️ ')}</strong>`;
          
          // 添加300毫秒延迟，模拟网络请求时间，提升用户体验
          setTimeout(() => {
              // 更新p标签内容
              infoParagraph.innerHTML = itineraryContent;
          }, 200);
        }

        // 页面加载完成后，加载地图和天气数据
    window.addEventListener('load', function() {
      console.log('页面加载完成，准备加载地图和天气数据...');
      
      // 加载地图
      loadAmapScript();
      
      // 设置按钮选择功能
      setupButtonSelection();
      
      // 替换地图标记为数字图标
      replaceMapMarkersWithNumbers();
      
      // 获取天气数据
      initializeWeather();
      
      // 计算并显示当前日期对应的星期几
      updateWeekDay();
      
      // 设置日期变化的观察者
      setupDateObserver();
      
      // 检查是否存在可调整大小的容器元素，如果存在再调用setupResizableContainer
        try {
          setupResizableContainer();
        } catch (error) {
          console.warn('容器调整功能未启用:', error.message);
        }
        
        // 默认显示第1天的行程信息并设置第1天标签为选中状态
        setTimeout(() => {
          try {
            // 先调用showTab设置第1天标签为选中状态
            if (typeof showTab === 'function') {
              showTab('day1-tab', 'day1-content');
            } else {
              // 如果showTab函数不可用，手动设置标签状态
              console.warn('showTab函数不可用，手动设置标签状态');
              const tab = document.getElementById('day1-tab');
              const content = document.getElementById('day1-content');
              if (tab && content) {
                tab.classList.add('bg-primary', 'text-white');
                tab.classList.remove('bg-gray-100', 'hover:bg-primary/80', 'hover:text-white');
                content.classList.remove('hidden');
              }
            }
            // 然后显示第1天的行程信息
            showDayItinerary('day1');
          } catch (error) {
            console.error('设置默认标签状态失败:', error);
          }
        }, 500);
        
        // 返回顶部按钮功能
        const backToTopButton = document.getElementById('backToTop');
        
        // 监听页面滚动事件
        window.addEventListener('scroll', () => {
          if (window.pageYOffset > 300) {
            // 显示返回顶部按钮
            backToTopButton.classList.remove('opacity-0', 'invisible');
            backToTopButton.classList.add('opacity-100', 'visible');
          } else {
            // 隐藏返回顶部按钮
            backToTopButton.classList.remove('opacity-100', 'visible');
            backToTopButton.classList.add('opacity-0', 'invisible');
          }
        });
        
        // 返回顶部按钮点击事件
        backToTopButton.addEventListener('click', () => {
          window.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
        });
      });
    
    // 设置左右拖动功能
    function setupResizableContainer() {
      const container = document.getElementById('resizable-container');
      const mapContainer = document.getElementById('map-container');
      const sidebar = document.getElementById('sidebar');
      const resizer = document.getElementById('resizer');
      
      // 检查是否所有必要元素都存在
      const missingElements = [];
      if (!container) missingElements.push('resizable-container');
      if (!mapContainer) missingElements.push('map-container');
      if (!sidebar) missingElements.push('sidebar');
      if (!resizer) missingElements.push('resizer');
      
      if (missingElements.length > 0) {
        console.warn(`未能找到可调整大小的容器元素: ${missingElements.join(', ')}`);
        // 不抛出错误，允许页面继续加载
        return;
      }
      
      let isResizing = false;
      
      // 鼠标按下开始拖动
      resizer.addEventListener('mousedown', function(e) {
        e.preventDefault();
        isResizing = true;
        document.body.style.cursor = 'col-resize';
        
        // 添加鼠标移动和释放事件监听器
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      });
      
      // 鼠标移动调整大小
      function onMouseMove(e) {
        if (!isResizing) return;
        
        // 获取容器的位置和宽度
        const containerRect = container.getBoundingClientRect();
        const containerWidth = containerRect.width;
        
        // 计算新的地图宽度（相对于容器的百分比）
        const newMapWidthPercent = ((e.clientX - containerRect.left) / containerWidth) * 100;
        
        // 限制最小和最大宽度（避免过小或过大）
        const minWidthPercent = 30; // 最小30%
        const maxWidthPercent = 70; // 最大70%
        const clampedWidthPercent = Math.max(minWidthPercent, Math.min(maxWidthPercent, newMapWidthPercent));
        
        // 更新地图和侧边栏的宽度
        mapContainer.style.width = `${clampedWidthPercent}%`;
        sidebar.style.width = `${100 - clampedWidthPercent}%`;
      }
      
      // 鼠标释放结束拖动
      function onMouseUp() {
        isResizing = false;
        document.body.style.cursor = '';
        
        // 移除事件监听器
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
      }
      
      // 防止文本选择
      resizer.addEventListener('selectstart', function(e) {
        e.preventDefault();
        return false;
      });
    }
  </script>
  
  <!-- 交通路线查询功能 -->
  <script>
    // 获取城市名称
     function getCityName() {
       // 查找所有span元素
       const spans = document.querySelectorAll('span');
       // 遍历所有span元素，查找包含'福州'文本的元素
       for (let i = 0; i < spans.length; i++) {
         if (spans[i].textContent.includes('福州')) {
           return '福州';
         }
       }
       return '福州'; // 默认使用福州
     }
    
    // 获取前一个地点
    function getPreviousPlace(element) {
      // 获取当前div元素
      const currentDiv = element.closest('.flex.items-center.text-gray-500.text-sm.ml-6');
      if (!currentDiv) return null;
      
      // 找到前一个地点元素（通常是带有地点信息的h4元素）
      let previousElement = currentDiv.previousElementSibling;
      while (previousElement) {
        if (previousElement.tagName === 'H4' || previousElement.querySelector('h4')) {
          const h4Element = previousElement.tagName === 'H4' ? previousElement : previousElement.querySelector('h4');
          const placeSpan = h4Element.querySelector('span[style="font-weight: bold;"]');
          if (placeSpan) {
            return placeSpan.textContent.trim();
          }
          // 如果没有bold span，尝试从文本中提取
          const textContent = h4Element.textContent;
          const match = textContent.match(/：([^\s]+)/);
          if (match && match.length > 1) {
            return match[1].trim();
          }
          return textContent.replace(/[：\(\)\s\d:-]+/g, '').trim();
        }
        previousElement = previousElement.previousElementSibling;
      }
      
      return '三坊七巷'; // 默认返回
    }
    
    // 解析路线信息，提取起点和终点
    function parseRouteInfo(text, div) {
      // 从路线文本中提取起点和终点
      const walkMatches = text.match(/步行至(.*?)\s/);
      const rideMatches = text.match(/乘车至(.*?)\s/);
      
      if (walkMatches && walkMatches.length > 1) {
        // 获取前一个地点作为起点
        const previousPlace = getPreviousPlace(div);
        if (previousPlace) {
          return {
            start: previousPlace,
            end: walkMatches[1].trim(),
            type: 'walk'
          };
        }
      } else if (rideMatches && rideMatches.length > 1) {
        // 获取前一个地点作为起点
        const previousPlace = getPreviousPlace(div);
        if (previousPlace) {
          return {
            start: previousPlace,
            end: rideMatches[1].trim(),
            type: 'ride'
          };
        }
      }
      
      return null;
    }
    
    // 获取城市名称
    function getCityName() {
      // 从页面标题或内容中提取城市名称
      const title = document.querySelector('h1');
      if (title) {
        const cityMatch = title.textContent.match(/(\w+)两日游/);
        if (cityMatch && cityMatch.length > 1) {
          return cityMatch[1];
        }
      }
      return '福州'; // 默认返回福州
    }
    
    // 调用高德地图API查询路线
    async function queryRouteInfo(start, end, city) {
      // 检查是否启用路线查询API
      if (!window.AMAP_API_CONFIG.enableRouteAPI) {
        console.log('路线查询API已禁用，返回模拟数据 (测试模式)');
        return getMockRoutes(start, end);
      }
      
      try {
        // 构建API请求URL
        // 先获取起点和终点的地理编码
        const [startGeo, endGeo] = await Promise.all([
          getGeocode(start, city),
          getGeocode(end, city)
        ]);
        
        if (!startGeo || !endGeo) {
          throw new Error('无法获取地点的地理编码');
        }
        
        // 查询公交路线（包含地铁）
        const busRoute = await queryBusRoute(startGeo, endGeo);
        
        // 查询步行路线
        const walkRoute = await queryWalkRoute(startGeo, endGeo);
        
        // 解析并格式化路线数据
        return parseRouteResponse(busRoute, walkRoute, start, end);
      } catch (error) {
        console.error('查询路线时出错:', error);
        // 出错时返回模拟数据
        return getMockRoutes(start, end);
      }
    }
    
    // 获取地点的地理编码
    async function getGeocode(address, city) {
      // 检查是否启用地理编码API
      if (!window.AMAP_API_CONFIG.enableGeocodeAPI) {
        console.log('地理编码API已禁用 (测试模式)');
        // 返回模拟的地理编码数据
        return null;
      }
      
      const url = `https://restapi.amap.com/v3/geocode/geo?address=${encodeURIComponent(address)}&city=${encodeURIComponent(city)}&output=json&key=9fc145b7b1ba7bc1dcc7d8a50a6e96b2`;
      const response = await fetch(url);
      const data = await response.json();
      
      if (data.status === '1' && data.count > '0') {
        const geo = data.geocodes[0].location.split(',');
        return {
          longitude: geo[0],
          latitude: geo[1]
        };
      }
      return null;
    }
    
    // 查询公交路线
    async function queryBusRoute(start, end) {
      // 检查是否启用路线查询API
      if (!window.AMAP_API_CONFIG.enableRouteAPI) {
        console.log('公交路线API已禁用 (测试模式)');
        // 返回模拟的空数据
        return { status: '0', info: 'API调用已禁用' };
      }
      
      const url = `https://restapi.amap.com/v3/direction/transit/integrated?origin=${start.longitude},${start.latitude}&destination=${end.longitude},${end.latitude}&city=福州&output=json&key=9fc145b7b1ba7bc1dcc7d8a50a6e96b2`;
      const response = await fetch(url);
      return await response.json();
    }
    
    // 查询步行路线
    async function queryWalkRoute(start, end) {
      // 检查是否启用路线查询API
      if (!window.AMAP_API_CONFIG.enableRouteAPI) {
        console.log('步行路线API已禁用 (测试模式)');
        // 返回模拟的空数据
        return { status: '0', info: 'API调用已禁用' };
      }
      
      const url = `https://restapi.amap.com/v3/direction/walking?origin=${start.longitude},${start.latitude}&destination=${end.longitude},${end.latitude}&output=json&key=9fc145b7b1ba7bc1dcc7d8a50a6e96b2`;
      const response = await fetch(url);
      return await response.json();
    }
    
    // 解析路线响应数据
    function parseRouteResponse(busRoute, walkRoute, start, end) {
      const result = {
        subway: null,
        bus: null,
        walk: null
      };
      
      // 处理步行路线
      if (walkRoute.status === '1' && walkRoute.route && walkRoute.route.paths && walkRoute.route.paths.length > 0) {
        const path = walkRoute.route.paths[0];
        const duration = Math.round(path.duration / 60); // 转换为分钟
        const distance = (path.distance / 1000).toFixed(1); // 转换为公里
        
        result.walk = {
          duration: `约${duration}分钟`,
          steps: [{
            type: 'walk',
            distance: `约${distance}公里`,
            duration: `约${duration}分钟`,
            start: start,
            end: end
          }]
        };
      }
      
      // 处理公交/地铁路线
      if (busRoute.status === '1' && busRoute.route && busRoute.route.transits && busRoute.route.transits.length > 0) {
        const transit = busRoute.route.transits[0]; // 取第一条路线
        const duration = Math.round(transit.duration / 60);
        
        // 检查是否包含地铁
        let hasSubway = false;
        let subwayLines = [];
        
        transit.segments.forEach(segment => {
          if (segment.bus && segment.bus.buslines) {
            segment.bus.buslines.forEach(busline => {
              if (busline.type === 'subway') {
                hasSubway = true;
                subwayLines.push(busline.name);
              }
            });
          }
        });
        
        // 格式化公交/地铁路线
        const steps = [];
        transit.segments.forEach(segment => {
          // 处理步行部分
          if (segment.walking) {
            const distance = (segment.walking.distance / 1000).toFixed(1);
            const duration = Math.round(segment.walking.duration / 60);
            steps.push({
              type: 'walk',
              distance: `约${distance}公里`,
              duration: `约${duration}分钟`,
              start: segment.walking.origin.name || start,
              end: segment.walking.destination.name || '站点'
            });
          }
          
          // 处理公交/地铁部分
          if (segment.bus && segment.bus.buslines) {
            const busline = segment.bus.buslines[0]; // 取第一条公交线路
            const stations = segment.bus.station_num;
            const duration = Math.round(segment.bus.duration / 60);
            
            if (busline.type === 'subway') {
              steps.push({
                type: 'subway',
                line: busline.name,
                direction: busline.start_stop + '➡️' + busline.end_stop,
                stations: stations,
                duration: `约${duration}分钟`,
                start: segment.bus.departure_stop.name || '起点站',
                end: segment.bus.arrival_stop.name || '终点站'
              });
            } else {
              steps.push({
                type: 'bus',
                line: busline.name,
                direction: busline.start_stop + '➡️' + busline.end_stop,
                stations: stations,
                duration: `约${duration}分钟`,
                start: segment.bus.departure_stop.name || '起点站',
                end: segment.bus.arrival_stop.name || '终点站'
              });
            }
          }
        });
        
        // 根据是否包含地铁决定路线类型
        if (hasSubway) {
          result.subway = {
            duration: `约${duration}分钟`,
            steps: steps
          };
        } else {
          result.bus = {
            duration: `约${duration}分钟`,
            steps: steps
          };
        }
      }
      
      // 如果API返回的数据不完整，补充模拟数据
      if (!result.subway && !result.bus) {
        const mockData = getMockRoutes(start, end);
        result.subway = mockData.subway;
        result.bus = mockData.bus;
      }
      
      if (!result.walk) {
        const mockData = getMockRoutes(start, end);
        result.walk = mockData.walk;
      }
      
      return result;
    }
    
    // 获取模拟路线数据（备用）
    function getMockRoutes(start, end) {
      return {
        subway: {
          duration: '30-40分钟',
          steps: [
            { type: 'walk', distance: '约500米', duration: '约8分钟', start: start, end: '南门兜地铁站' },
            { type: 'subway', line: '地铁1号线', direction: '往象峰方向', stations: 4, duration: '约10分钟', start: '南门兜站', end: '斗门站' },
            { type: 'walk', distance: '约400米', duration: '约5分钟', start: '斗门站', end: end }
          ]
        },
        bus: {
          duration: '30-40分钟',
          steps: [
            { type: 'walk', distance: '约500米', duration: '约8分钟', start: start, end: '南门兜地铁站' },
            { type: 'bus', line: '36路公交车', direction: '往象峰方向', stations: 4, duration: '约10分钟', start: '南门兜站', end: '斗门站' },
            { type: 'walk', distance: '约400米', duration: '约5分钟', start: '斗门站', end: end }
          ]
        },
        walk: {
          duration: '约15分钟',
          steps: [
            { type: 'walk', distance: '约1000米', duration: '约15分钟', start: start, end: end }
          ]
        }
      };
    }
    
    // 格式化路线数据
    function formatRouteData(routeData, start, end) {
      let formatted = '';
      
      // 格式化地铁方案
      if (routeData.subway) {
        formatted += `
        <div class="route-plan subway-plan">
          <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
            <strong>🚇地铁方案（⏱️总耗时${routeData.subway.duration}）</strong>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="route-details">`;
        
        routeData.subway.steps.forEach(step => {
          if (step.type === 'walk') {
            formatted += `
              <div class="route-step">🚶‍♂️步行：从${step.start} 步行 ${step.distance}到🚏${step.end}（${step.duration}）</div>`;
          } else if (step.type === 'subway') {
            formatted += `
              <div class="route-step">🚇地铁：从🚏${step.start}乘坐🚇${step.line}（${step.direction}），经${step.stations}站到🚏${step.end}（${step.duration}）</div>`;
          }
        });
        
        formatted += `
          </div>
        </div>`;
      }
      
      // 格式化公交方案
      if (routeData.bus) {
        formatted += `
        <div class="route-plan bus-plan">
          <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
            <strong>🚍️公交方案（⏱️总耗时${routeData.bus.duration}）</strong>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="route-details">`;
        
        routeData.bus.steps.forEach(step => {
          if (step.type === 'walk') {
            formatted += `
              <div class="route-step">🚶‍♂️步行：从${step.start} 步行 ${step.distance}到🚏${step.end}（${step.duration}）</div>`;
          } else if (step.type === 'bus') {
            formatted += `
              <div class="route-step">🚌️公交：从🚏${step.start}乘坐🚌️${step.line}（${step.direction}），经${step.stations}站到🚏${step.end}（${step.duration}）</div>`;
          }
        });
        
        formatted += `
          </div>
        </div>`;
      }
      
      // 格式化步行方案
      if (routeData.walk) {
        formatted += `
        <div class="route-plan walk-plan">
          <div class="route-header" onclick="toggleRouteDetails(this.parentNode)">
            <strong>🚶‍♂️步行方案（⏱️总耗时${routeData.walk.duration}）</strong>
            <span class="toggle-icon">▼</span>
          </div>
          <div class="route-details">`;
        
        routeData.walk.steps.forEach(step => {
          if (step.type === 'walk') {
            formatted += `
              <div class="route-step">🚶‍♂️步行：从${step.start} 步行 ${step.distance}到达${step.end}（${step.duration}）</div>`;
          }
        });
        
        formatted += `
          </div>
        </div>`;
      }
      
      return formatted;
    }
    
    // 切换路线详情的展开/收起状态
    function toggleRouteDetails(planElement) {
      const detailsElement = planElement.querySelector('.route-details');
      const toggleIcon = planElement.querySelector('.toggle-icon');
      
      if (detailsElement.style.display === 'none') {
        // 展开详情
        detailsElement.style.display = 'block';
        toggleIcon.textContent = '▲';
        
        // 添加高德地图链接
        addAmapLink(detailsElement, planElement);
      } else {
        // 收起详情
        detailsElement.style.display = 'none';
        toggleIcon.textContent = '▼';
      }
    }
    
    // 添加高德地图链接到路线详情
    function addAmapLink(detailsElement, planElement) {
      // 检查是否已经添加过链接
      if (detailsElement.querySelector('.amap-link')) {
        return;
      }
      
      // 获取路线类型（地铁、公交、步行）
      const planType = planElement.classList.contains('subway-plan') ? 'subway' : 
                       planElement.classList.contains('bus-plan') ? 'bus' : 'walk';
      
      // 获取路线步骤信息以提取起点和终点
      const routeSteps = detailsElement.querySelectorAll('.route-step');
      if (routeSteps.length === 0) return;
      
      // 尝试从步骤中提取起点和终点
      let startLocation = '';
      let endLocation = '';
      
      // 直接从页面上的span元素获取当前地点和下一个地点
      const locationSpans = document.querySelectorAll('span[style*="font-weight: bold; cursor: pointer; text-decoration: underline;"]');
      
      if (locationSpans.length >= 2) {
        // 获取当前行程的索引（基于planElement在DOM中的位置）
        const parentDiv = planElement.closest('.flex.items-center.text-gray-500.text-sm.ml-6');
        let currentIndex = 0;
        
        if (parentDiv) {
          const allRouteDivs = Array.from(parentDiv.closest('.space-y-6').querySelectorAll('.flex.items-center.text-gray-500.text-sm.ml-6'));
          currentIndex = allRouteDivs.indexOf(parentDiv);
        }
        
        // 确保索引有效
        if (currentIndex >= 0 && currentIndex < locationSpans.length - 1) {
          startLocation = locationSpans[currentIndex].textContent;
          endLocation = locationSpans[currentIndex + 1].textContent;
        } else {
          // 如果无法确定正确的索引，使用前两个地点作为默认值
          startLocation = locationSpans[0].textContent;
          endLocation = locationSpans[1].textContent;
        }
      } else if (locationSpans.length === 1) {
        // 只有一个地点时的处理
        startLocation = locationSpans[0].textContent;
        
        // 尝试从行程配置中查找下一个地点
        const itineraryArray = tripConfig[`itineraryDetailsDay${tripConfig.daysNumber}`] || [];
        for (let i = 0; i < itineraryArray.length; i++) {
          if (itineraryArray[i].location === startLocation) {
            if (i < itineraryArray.length - 1) {
              endLocation = itineraryArray[i + 1].location;
            }
            break;
          }
        }
      }
      
      // 如果上述方法失败，尝试备用方法
      if (!startLocation || !endLocation) {
        // 从第一个步骤提取起点
        const firstStep = routeSteps[0].textContent;
        const startMatch = firstStep.match(/从(.+?)步行|从(.+?)乘坐/);
        if (startMatch) {
          startLocation = startMatch[1] || startMatch[2];
        }
        
        // 从最后一个步骤提取终点
        const lastStep = routeSteps[routeSteps.length - 1].textContent;
        const endMatch = lastStep.match(/到达(.+?)(?:（|$)/);
        if (endMatch) {
          endLocation = endMatch[1];
        }
      }
      
      // 从tripConfig的行程数组中获取坐标
      function getCoordFromItinerary(locationName) {
        // 首先尝试精确匹配
        let coord = null;
        
        // 根据daysNumber获取对应的行程数组
        const itineraryArray = tripConfig[`itineraryDetailsDay${tripConfig.daysNumber}`] || [];
        
        // 精确匹配location字段
        for (const item of itineraryArray) {
          if (item.location === locationName || 
              item.location === locationName + ' (三坊七巷店)' ||
              item.location.replace(' (三坊七巷店)', '') === locationName) {
            coord = item.locationCoords;
            break;
          }
        }
        
        // 如果精确匹配失败，尝试模糊匹配
        if (!coord) {
          for (const item of itineraryArray) {
            if (locationName.includes(item.location) || item.location.includes(locationName)) {
              coord = item.locationCoords;
              break;
            }
          }
        }
        
        return coord;
      }
      
      // 获取起点和终点的坐标
      let startCoord = getCoordFromItinerary(startLocation);
      let endCoord = getCoordFromItinerary(endLocation);
      
      // 备用的预定义地点坐标（当itineraryDetails中找不到时使用）
      const predefinedPositions = {
        '三坊七巷': {lat: 26.0838, lng: 119.2965}, 
        '安泰楼酒家': {lat: 26.080774, lng: 119.300361},
        '安泰楼酒家(三坊七巷店)': {lat: 26.080774, lng: 119.300361},
        '上下杭历史文化街区': {lat: 26.052103, lng: 119.304687},
        '青年广场': {lat: 26.049044, lng: 119.309939},
        '台江万达': {lat: 26.054302, lng: 119.341885},
        '福州泰禾铂尔曼酒店': {lat: 26.095799, lng: 119.291334},
        '福州西湖大酒店': {lat: 26.095799, lng: 119.291334},
        '福州冠城大通首玺公寓': {lat: 26.074229, lng: 119.30182},
        '聚春园': {lat: 26.0827, lng: 119.2962},
        '老药洲街美食': {lat: 26.0667, lng: 119.3203},
        '同利肉燕老铺': {lat: 26.0783, lng: 119.2965}
      };
      
      // 如果从itineraryDetails中找不到，尝试从predefinedPositions中查找
      if (!startCoord) {
        startCoord = predefinedPositions[startLocation];
        // 如果找不到精确匹配，尝试模糊匹配
        if (!startCoord) {
          for (const [key, value] of Object.entries(predefinedPositions)) {
            if (startLocation.includes(key)) {
              startCoord = value;
              break;
            }
          }
        }
      }
      
      if (!endCoord) {
        endCoord = predefinedPositions[endLocation];
        // 如果找不到精确匹配，尝试模糊匹配
        if (!endCoord) {
          for (const [key, value] of Object.entries(predefinedPositions)) {
            if (endLocation.includes(key)) {
              endCoord = value;
              break;
            }
          }
        }
      }
      
      // 生成高德地图URI
      let amapUrl = '';
      if (startCoord && endCoord) {
        // 使用坐标构建URL
        const origin = `${startCoord.lng},${startCoord.lat}`;
        const destination = `${endCoord.lng},${endCoord.lat}`;
        const originName = encodeURIComponent(startLocation);
        const destName = encodeURIComponent(endLocation);
        
        // 根据路线类型选择导航方式和策略
        let mode = 'bus';
        let policy = '';
        
        if (planType === 'subway') {
          mode = 'bus'; // 地铁方案使用bus模式
          policy = '&policy=0'; // 策略0优先地铁
        } else if (planType === 'bus') {
          mode = 'bus'; // 公交方案使用bus模式
          policy = '&policy=3'; // 策略3公交优先
        } else if (planType === 'walk') {
          mode = 'walk'; // 步行方案使用walk模式
        }
        
        // 构建高德地图URI
        amapUrl = `https://uri.amap.com/navigation?from=${origin}&fromname=${originName}&to=${destination}&toname=${destName}&mode=${mode}${policy}`;
      } else {
        // 如果没有坐标，使用地点名称
        const originName = encodeURIComponent(startLocation);
        const destName = encodeURIComponent(endLocation);
        let mode = 'bus';
        let policy = '';
        
        if (planType === 'subway') {
          mode = 'bus';
          policy = '&policy=0';
        } else if (planType === 'bus') {
          mode = 'bus';
          policy = '&policy=3';
        } else if (planType === 'walk') {
          mode = 'walk';
        }
        
        amapUrl = `https://uri.amap.com/navigation?fromname=${originName}&toname=${destName}&mode=${mode}${policy}`;
      }
      
      // 创建链接元素
      const linkElement = document.createElement('div');
      linkElement.className = 'amap-link mt-4 pt-2 border-t border-gray-200';
      linkElement.innerHTML = `<a href="${amapUrl}" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center justify-center">
        🗺️ 打开高德地图导航
      </a>`;
      
      // 添加到详情底部
      detailsElement.appendChild(linkElement);
    }
    
    // 页面加载完成后初始化所有路线方案为收起状态
    document.addEventListener('DOMContentLoaded', function() {
      // 为现有的交通方案HTML结构添加展开缩放功能
      const routeDivs = document.querySelectorAll('.flex.items-center.text-gray-500.text-sm.ml-6 .editable');
      
      routeDivs.forEach(div => {
        const content = div.innerHTML;
        // 转换现有的交通方案HTML结构
        const newContent = content.replace(/<div class="mb-1"><strong>🚇地铁方案/g, '<div class="route-plan subway-plan"><div class="route-header" onclick="toggleRouteDetails(this.parentNode)"><strong>🚇地铁方案')
                                 .replace(/<\/strong><\/div>/g, '</strong><span class="toggle-icon">▼</span></div><div class="route-details">')
                                 .replace(/<div class="mb-1 mt-2"><strong>🚌️公交方案/g, '</div></div><div class="route-plan bus-plan"><div class="route-header" onclick="toggleRouteDetails(this.parentNode)"><strong>🚌️公交方案')
                                 .replace(/<div class="mb-1 mt-2"><strong>🚶‍♂️步行方案/g, '</div></div><div class="route-plan walk-plan"><div class="route-header" onclick="toggleRouteDetails(this.parentNode)"><strong>🚶‍♂️步行方案')
                                 .replace(/<\/span>$/, '</div></div></span>')
                                 .replace(/<div class="ml-4">/g, '<div class="route-step">');
        
        div.innerHTML = newContent;
      });
      
      // 初始化所有详情为收起状态
      const allDetails = document.querySelectorAll('.route-details');
      allDetails.forEach(details => {
        details.style.display = 'none';
      });
    });
    
    // 添加CSS样式
    const style = document.createElement('style');
    style.textContent = `
      .route-plan {
        margin-bottom: 8px;
        border-radius: 4px;
        overflow: hidden;
      }
      
      .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        background-color: #f8f9fa;
        border: 1px solid #e9ecef;
        transition: background-color 0.2s;
      }
      
      .route-header:hover {
        background-color: #e9ecef;
      }
      
      .toggle-icon {
        font-size: 12px;
        transition: transform 0.2s;
      }
      
      .route-details {
        padding: 8px 12px;
        background-color: #ffffff;
        border: 1px solid #e9ecef;
        border-top: none;
      }
      
      .route-step {
        margin: 4px 0;
        padding-left: 16px;
        position: relative;
      }
      
      .subway-plan .route-header {
        border-left: 4px solid #0072CE;
      }
      
      .bus-plan .route-header {
        border-left: 4px solid #00a84d;
      }
      
      .walk-plan .route-header {
        border-left: 4px solid #9ea3a8;
      }
    `;
    document.head.appendChild(style);
    
    // 更新路线div元素显示详细路线
    async function updateRouteDiv(div) {
      const span = div.querySelector('span.editable');
      if (!span) return;
      
      const originalText = span.textContent;
      const routeInfo = parseRouteInfo(originalText, div);
      
      if (routeInfo) {
        span.innerHTML = '正在查询路线...';
        
        try {
          const city = getCityName();
          const routeData = await queryRouteInfo(routeInfo.start, routeInfo.end, city);
          const formattedRoute = formatRouteData(routeData, routeInfo.start, routeInfo.end);
          
          // 将路线文本转换为HTML显示
          const routeHtml = formattedRoute.split('\n').map(line => {
            if (line.startsWith('🚇地铁方案') || line.startsWith('🚍️公交方案') || line.startsWith('🚶‍♂️步行方案')) {
              return `<div class="font-semibold mt-2 mb-1">${line}</div>`;
            }
            return `<div>${line}</div>`;
          }).join('');
          
          span.innerHTML = `<div style="white-space: pre-line; font-size: 0.9em;">${routeHtml}</div>`;
        } catch (error) {
          console.error('更新路线失败:', error);
          span.textContent = originalText; // 失败时恢复原始文本
        }
      }
    }

    // 必备物品管理功能
    document.addEventListener('DOMContentLoaded', function() {
      const essentialsList = document.getElementById('essentials');
      const luggageList = document.getElementById('luggage-items');
      const editBtn = document.getElementById('addEssentialBtn');
      const addNewItemBtn = document.getElementById('addNewItemBtn');
      const STORAGE_KEY = 'travelItems';
      let isEditMode = false; // 跟踪按钮状态
      
      // 从localStorage加载数据
      function loadEssentials() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          let hasLoadedData = false;
          
          // 确保saved是有效的字符串才尝试解析
          if (saved && typeof saved === 'string' && saved.trim() !== '') {
            const items = JSON.parse(saved);
            
            // 清空现有列表
            essentialsList.innerHTML = '';
            luggageList.innerHTML = '';
            
            // 添加保存的物品到对应的列表
            items.forEach(item => {
              if (item.type === 'essential') {
                addEssentialToList(item.name, item.description, 'mt-1 mr-3', false, essentialsList, item.emoji || item.icon || '📄');
              } else if (item.type === 'luggage') {
                addEssentialToList(item.name, item.description, 'mt-1 mr-3', false, luggageList, item.emoji || item.icon || '📄');
              }
            });
            hasLoadedData = true;
          }
          
          // 如果没有成功加载数据或列表为空，添加默认物品
          if (!hasLoadedData || essentialsList.children.length === 0) {
            console.log('没有加载到数据或列表为空，添加默认物品');
            
            // 如果列表为空，先清空可能的残留内容
            if (essentialsList.children.length === 0) {
              essentialsList.innerHTML = '';
              // 添加随身携带默认物品
              addEssentialToList('证件', '身份证、银行卡', 'mt-1 mr-3', false, essentialsList, '🆔');
              addEssentialToList('充电宝', '充电宝、数据线', 'mt-1 mr-3', false, essentialsList, '🔋');
            }
            
            if (luggageList.children.length === 0) {
              luggageList.innerHTML = '';
              // 添加行李物品默认物品
              addEssentialToList('衣物', '换洗衣物、外套、舒适鞋', 'mt-1 mr-3', false, luggageList, '🧳');
            }
          }
        } catch (error) {
          console.error('加载物品失败:', error);
          // 如果发生错误，清空localStorage中的无效数据
          localStorage.removeItem(STORAGE_KEY);
          
          // 发生错误时，确保显示默认物品
          essentialsList.innerHTML = '';
          luggageList.innerHTML = '';
          addEssentialToList('证件', '身份证、银行卡', 'mt-1 mr-3', false, essentialsList, '🆔');
          addEssentialToList('充电宝', '充电宝、数据线', 'mt-1 mr-3', false, essentialsList, '🔋');
          addEssentialToList('衣物', '换洗衣物、外套、舒适鞋', 'mt-1 mr-3', false, luggageList, '🧳');
        }
      }
      
      // 保存数据到localStorage
      function saveEssentials() {
        try {
          const allItems = [];
          
          // 保存随身携带列表
          const essentialItems = essentialsList.querySelectorAll('li');
          essentialItems.forEach(item => {
            const nameSpan = item.querySelector('span.editable');
            const descP = item.querySelector('p.editable');
            const emojiSpan = item.querySelector('.mt-1.mr-3 span');
            const emoji = emojiSpan ? emojiSpan.textContent : '📄';
            
            if (nameSpan && descP) {
              allItems.push({
                type: 'essential',
                name: nameSpan.textContent.trim(),
                description: descP.textContent.trim(),
                emoji: emoji
              });
            }
          });
          
          // 保存行李清单列表
          const luggageItems = luggageList.querySelectorAll('li');
          luggageItems.forEach(item => {
            const nameSpan = item.querySelector('span.editable');
            const descP = item.querySelector('p.editable');
            const emojiSpan = item.querySelector('.mt-1.mr-3 span');
            const emoji = emojiSpan ? emojiSpan.textContent : '📄';
            
            if (nameSpan && descP) {
              allItems.push({
                type: 'luggage',
                name: nameSpan.textContent.trim(),
                description: descP.textContent.trim(),
                emoji: emoji
              });
            }
          });
          
          localStorage.setItem(STORAGE_KEY, JSON.stringify(allItems));
          
          // 显示保存成功提示
          const originalText = editBtn.innerHTML;
          editBtn.innerHTML = '<span>🔄</span>正在保存';
          editBtn.classList.add('bg-green-700');
          
          setTimeout(() => {
            // 保存成功后，恢复到编辑模式
            toggleButtonMode();
          }, 1000);
        } catch (error) {
          console.error('保存必备物品失败:', error);
        }
      }
      
      // 添加物品到列表
      function addEssentialToList(name = '新物品', description = '请输入描述', iconClass = 'mt-1 mr-3', saveAfterAdd = true, targetList = essentialsList, emoji = '📄') {
        // 检查emoji参数是否包含Font Awesome类名，如果包含则根据物品类型选择合适的emoji
        if (typeof emoji === 'string' && emoji.includes('fa ')) {
          // 根据物品名称或描述选择合适的emoji
          const nameLower = name.toLowerCase();
          const descLower = description.toLowerCase();
          
          if (nameLower.includes('身份证') || nameLower.includes('护照') || nameLower.includes('证件')) {
            emoji = '🪪';
          } else if (nameLower.includes('钱包') || nameLower.includes('信用卡') || nameLower.includes('现金')) {
            emoji = '💰';
          } else if (nameLower.includes('手机') || nameLower.includes('充电器') || nameLower.includes('充电宝')) {
            emoji = '📱';
          } else if (nameLower.includes('衣服') || nameLower.includes('外套') || nameLower.includes('裤子') || nameLower.includes('鞋')) {
            emoji = '👕';
          } else if (nameLower.includes('牙刷') || nameLower.includes('牙膏') || nameLower.includes('毛巾') || descLower.includes('洗漱')) {
            emoji = '🧴';
          } else if (nameLower.includes('雨伞') || descLower.includes('雨具')) {
            emoji = '☂️';
          } else if (nameLower.includes('相机') || nameLower.includes('拍照')) {
            emoji = '📷';
          } else if (nameLower.includes('药') || descLower.includes('药品')) {
            emoji = '💊';
          } else if (nameLower.includes('地图') || nameLower.includes('导航')) {
            emoji = '🗺️';
          } else if (nameLower.includes('书') || nameLower.includes('杂志')) {
            emoji = '📚';
          } else if (nameLower.includes('零食') || nameLower.includes('饮料')) {
            emoji = '🍫';
          } else {
            emoji = '📄'; // 使用默认文档emoji
          }
        }
        
        const newLi = document.createElement('li');
        newLi.className = 'flex items-start';
        newLi.innerHTML = `
          <div class="${iconClass}">
            <span>${emoji}</span>
          </div>
          <div class="flex-1">
            <span class="font-medium editable">${name}</span>
            <p class="text-sm text-gray-600 editable">${description}</p>
          </div>
          <button class="edit-essential text-blue-500 hover:text-blue-700 p-2 -mr-2" title="修改" style="display: none;">
            <span>✏️</span>
          </button>
          <button class="remove-essential text-red-500 hover:text-red-700 p-2 -mr-2" title="删除" style="display: none;">
            <span>❌</span>
          </button>
        `;
        
        targetList.appendChild(newLi);
        
        // 添加删除事件
        const removeBtn = newLi.querySelector('.remove-essential');
        removeBtn.addEventListener('click', function() {
          newLi.remove();
        });
        
        // 添加修改事件
        const editBtn = newLi.querySelector('.edit-essential');
        editBtn.addEventListener('click', function() {
          editEssentialItem(newLi, targetList === essentialsList ? 'essential' : 'luggage');
        });
        
        // 如果当前是编辑模式，显示删除和修改按钮
        if (isEditMode) {
          removeBtn.style.display = 'flex';
          editBtn.style.display = 'flex';
        }
        
        if (saveAfterAdd) {
          saveEssentials();
        }
      }
      
      // 在模态框显示时调整返回顶部按钮和导航栏
      function adjustUIForModal(isModalVisible) {
        const backToTopBtn = document.getElementById('backToTop');
        const navbar = document.querySelector('nav');
        
        // 确保元素存在
        if (!backToTopBtn || !navbar) {
          console.warn('无法找到返回顶部按钮或导航栏元素');
          return;
        }
        
        if (isModalVisible) {
          // 保存原始样式以便后续恢复
          if (!backToTopBtn.dataset.originalZIndex) {
            backToTopBtn.dataset.originalZIndex = backToTopBtn.style.zIndex || '99999'; // 默认值
          }
          if (!backToTopBtn.dataset.originalPointerEvents) {
            backToTopBtn.dataset.originalPointerEvents = backToTopBtn.style.pointerEvents || 'auto';
          }
          if (!navbar.dataset.originalZIndex) {
            navbar.dataset.originalZIndex = navbar.style.zIndex || '9999'; // 默认值
          }
          if (!navbar.dataset.originalPointerEvents) {
            navbar.dataset.originalPointerEvents = navbar.style.pointerEvents || 'auto';
          }
          
          // 设置模态框显示时的样式
          backToTopBtn.style.zIndex = '1';
          backToTopBtn.style.pointerEvents = 'none';
          navbar.style.zIndex = '1';
          navbar.style.pointerEvents = 'none';
        } else {
          // 恢复原始样式，即使没有保存过也提供合理的默认值
          backToTopBtn.style.zIndex = backToTopBtn.dataset.originalZIndex || '99999';
          backToTopBtn.style.pointerEvents = backToTopBtn.dataset.originalPointerEvents || 'auto';
          navbar.style.zIndex = navbar.dataset.originalZIndex || '9999';
          navbar.style.pointerEvents = navbar.dataset.originalPointerEvents || 'auto';
          
          // 清除保存的数据，避免累积多个模态框的状态
          delete backToTopBtn.dataset.originalZIndex;
          delete backToTopBtn.dataset.originalPointerEvents;
          delete navbar.dataset.originalZIndex;
          delete navbar.dataset.originalPointerEvents;
        }
      }
      
      // 编辑物品
      function editEssentialItem(itemElement, itemType) {
        // 从元素中获取当前物品信息
        const editableElements = itemElement.querySelectorAll('.editable');
        const itemName = editableElements[0].textContent.trim();
        const itemDesc = editableElements[1].textContent.trim();
        const itemEmoji = itemElement.querySelector('.mt-1.mr-3 span').textContent.trim();
        
        // 创建模态框
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4';
        
        // 在模态框显示时调整UI元素
        adjustUIForModal(true);
        modal.innerHTML = `
          <div class="bg-white rounded-xl w-full max-w-md p-6">
            <h3 class="text-xl font-bold mb-4">编辑物品</h3>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">名称</label>
              <input type="text" id="editItemName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" value="${itemName}">
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">描述</label>
              <input type="text" id="editItemDesc" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" value="${itemDesc}">
            </div>
            
            <div class="mb-6">
              <label class="block text-sm font-medium text-gray-700 mb-2">选择图标</label>
              
              <!-- 分类选项栏 -->
              <div class="flex flex-wrap gap-2 mb-3" id="iconCategories">
                <button type="button" id="customEmojiBtn" data-category="all" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm border-2 border-dashed border-gray-300">
                  <span class="inline-block mr-1">✏️</span>自定义
                </button>
                <button type="button" data-category="shapes" class="category-btn px-3 py-1 rounded-full bg-primary text-white text-sm">形状图标</button>
                <button type="button" data-category="clothing" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">衣物服饰</button>
                <button type="button" data-category="accessories" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">配饰</button>
                <button type="button" data-category="shoes" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">鞋子</button>
                <button type="button" data-category="bags" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">箱包用品</button>
                <button type="button" data-category="electronics" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">电子设备</button>
                <button type="button" data-category="documents" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">证件财务</button>
                <button type="button" data-category="medical" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">护理医疗</button>
                <button type="button" data-category="leisure" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">休闲装备</button>
                <button type="button" data-category="other" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">其他用品</button>
              </div>
              
              <!-- 图标网格 -->
              <div class="grid grid-cols-5 gap-2 mb-2 max-h-[10rem] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="iconSelector">
                <!-- 形状图标类 -->
                <button type="button" data-icon="🔘" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="单选框">
                  🔘
                </button>
                <button type="button" data-icon="🔴" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="红色圆">
                  🔴
                </button>
                <button type="button" data-icon="🟠" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="橙色圆">
                  🟠
                </button>
                <button type="button" data-icon="🟡" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="黄色圆">
                  🟡
                </button>
                <button type="button" data-icon="🟢" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="绿色圆">
                  🟢
                </button>
                <button type="button" data-icon="🔵" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="蓝色圆">
                  🔵
                </button>
                <button type="button" data-icon="🟣" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="紫色圆">
                  🟣
                </button>
                <button type="button" data-icon="🟤" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="棕色圆">
                  🟤
                </button>
                <button type="button" data-icon="🟥" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="红色方块">
                  🟥
                </button>
                <button type="button" data-icon="🟧" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="橙色方块">
                  🟧
                </button>
                <button type="button" data-icon="🟨" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="黄色方块">
                  🟨
                </button>
                <button type="button" data-icon="🟩" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="绿色方块">
                  🟩
                </button>
                <button type="button" data-icon="🟦" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="蓝色方块">
                  🟦
                </button>
                <button type="button" data-icon="🟪" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="紫色方块">
                  🟪
                </button>
                <button type="button" data-icon="🟫" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="棕色方块">
                  🟫
                </button>
                
                <!-- 衣物服饰类 -->
                <button type="button" data-icon="🥼" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="风衣" style="display: none;">
                  🥼
                </button>
                <button type="button" data-icon="👔" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="男装" style="display: none;">
                  👔
                </button>
                <button type="button" data-icon="👕" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="T恤" style="display: none;">
                  👕
                </button>
                <button type="button" data-icon="👖" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="长裤" style="display: none;">
                  👖
                </button>
                <button type="button" data-icon="🩳" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="短裤" style="display: none;">
                  🩳
                </button>
                <button type="button" data-icon="🧣" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="围巾" style="display: none;">
                  🧣
                </button>
                <button type="button" data-icon="🧤" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手套" style="display: none;">
                  🧤
                </button>
                <button type="button" data-icon="🧥" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="外套" style="display: none;">
                  🧥
                </button>
                <button type="button" data-icon="👗" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="连衣裙" style="display: none;">
                  👗
                </button>
                <button type="button" data-icon="🩱" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="连体泳衣" style="display: none;">
                  🩱
                </button>
                <button type="button" data-icon="🩲" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="泳裤" style="display: none;">
                  🩲
                </button>
                <button type="button" data-icon="👙" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="比基尼" style="display: none;">
                  👙
                </button>
                <button type="button" data-icon="👚" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女装" style="display: none;">
                  👚
                </button>
                <button type="button" data-icon="🎽" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="运动背心" style="display: none;">
                  🎽
                </button>
                
                <!-- 饰品类 -->
                <button type="button" data-icon="👓️" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="眼镜" style="display: none;">
                  👓️
                </button>
                <button type="button" data-icon="🕶️" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="墨镜" style="display: none;">
                  🕶️
                </button>
                <button type="button" data-icon="🥽" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="护目镜" style="display: none;">
                  🥽
                </button>
                <button type="button" data-icon="💍" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="饰品" style="display: none;">
                  💍
                </button>
                <button type="button" data-icon="🧢" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="帽子" style="display: none;">
                  🧢
                </button>
                <button type="button" data-icon="👒" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="遮阳帽" style="display: none;">
                  👒
                </button>
                
                <!-- 鞋子类 -->
                <button type="button" data-icon="🧦" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="袜子" style="display: none;">
                  🧦
                </button>
                <button type="button" data-icon="👞" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="男鞋" style="display: none;">
                  👞
                </button>
                <button type="button" data-icon="👟" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="跑鞋" style="display: none;">
                  👟
                </button>
                <button type="button" data-icon="🥾" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="登山鞋" style="display: none;">
                  🥾
                </button>
                <button type="button" data-icon="🥿" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="平底鞋" style="display: none;">
                  🥿
                </button>
                <button type="button" data-icon="👠" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="高跟鞋" style="display: none;">
                  👠
                </button>
                <button type="button" data-icon="👡" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女式凉鞋" style="display: none;">
                  👡
                </button>
                <button type="button" data-icon="👢" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女靴" style="display: none;">
                  👢
                </button>
                
                <!-- 箱包用品类 -->
                <button type="button" data-icon="👛" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钱包" style="display: none;">
                  👛
                </button>
                <button type="button" data-icon="👜" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手提包" style="display: none;">
                  👜
                </button>
                <button type="button" data-icon="👝" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手袋" style="display: none;">
                  👝
                </button>
                <button type="button" data-icon="🎒" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="背包" style="display: none;">
                  🎒
                </button>
                <button type="button" data-icon="💼" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="公文包" style="display: none;">
                  💼
                </button>
                <button type="button" data-icon="🧳" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="行李箱" style="display: none;">
                  🧳
                </button>
                
                <!-- 电子设备类 -->
                <button type="button" data-icon="📱" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手机" style="display: none;">
                  📱
                </button>
                <button type="button" data-icon="🔋" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="充电宝" style="display: none;">
                  🔋
                </button>
                <button type="button" data-icon="🔌" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="充电器" style="display: none;">
                  🔌
                </button>
                <button type="button" data-icon="💻️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="笔记本电脑" style="display: none;">
                  💻️
                </button>
                <button type="button" data-icon="📷️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="相机" style="display: none;">
                  📷️
                </button>
                <button type="button" data-icon="⌚️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手表" style="display: none;">
                  ⌚️
                </button>
                
                <!-- 证件财务类 -->
                <button type="button" data-icon="🆔" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="票据" style="display: none;">
                  🆔
                </button>
                <button type="button" data-icon="🎫" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="票据" style="display: none;">
                  🎫
                </button>
                <button type="button" data-icon="🎟️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="入场卷" style="display: none;">
                  🎟️
                </button>
                <button type="button" data-icon="📕" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="证件" style="display: none;">
                  📕
                </button>
                <button type="button" data-icon="📄" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="文件" style="display: none;">
                  📄
                </button>
                <button type="button" data-icon="📑" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="证明" style="display: none;">
                  📑
                </button>
                <button type="button" data-icon="💳️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="银行卡" style="display: none;">
                  💳️
                </button>
                <button type="button" data-icon="💰️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="现金" style="display: none;">
                  💰️
                </button>
                <button type="button" data-icon="💵" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="美元" style="display: none;">
                  💵
                </button>
                <button type="button" data-icon="💶" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="欧元" style="display: none;">
                  💶
                </button>
                <button type="button" data-icon="💴" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="日元" style="display: none;">
                  💴
                </button>
                <button type="button" data-icon="💷" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="英镑" style="display: none;">
                  💷
                </button>
                <button type="button" data-icon="💱" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="外汇" style="display: none;">
                  💱
                </button>
                
                <!-- 护理医疗类 -->
                <button type="button" data-icon="💊" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="药丸" style="display: none;">
                  💊
                </button>
                <button type="button" data-icon="🩹" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="创可贴" style="display: none;">
                  🩹
                </button>
                <button type="button" data-icon="🧴" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="乳液" style="display: none;">
                  🧴
                </button>
                <button type="button" data-icon="🧻" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="纸巾" style="display: none;">
                  🧻
                </button>
                <button type="button" data-icon="🧼" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="肥皂" style="display: none;">
                  🧼
                </button>
                <button type="button" data-icon="🪒" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="剃须刀" style="display: none;">
                  🪒
                </button>
                
                <!-- 休闲装备类 -->
                <button type="button" data-icon="🎣" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钓鱼竿" style="display: none;">
                  🎣
                </button>
                <button type="button" data-icon="🎮️" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="游戏手柄" style="display: none;">
                  🎮️
                </button>
                <button type="button" data-icon="🪁" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="风筝" style="display: none;">
                  🪁
                </button>
                <button type="button" data-icon="🎲" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="骰子" style="display: none;">
                  🎲
                </button>
                <button type="button" data-icon="🧸" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="玩偶" style="display: none;">
                  🧸
                </button>
                <button type="button" data-icon="🃏" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="扑克" style="display: none;">
                  🃏
                </button>
                <button type="button" data-icon="🀄️" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="麻将" style="display: none;">
                  🀄️
                </button>
                
                <!-- 其他用品类 -->
                <button type="button" data-icon="🧵" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="针线" style="display: none;">
                  🧵
                </button>
                <button type="button" data-icon="🔒️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="锁" style="display: none;">
                  🔒️
                </button>
                <button type="button" data-icon="🔑" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钥匙" style="display: none;">
                  🔑
                </button>
                <button type="button" data-icon="🔦" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手电筒" style="display: none;">
                  🔦
                </button>
                <button type="button" data-icon="🚬" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="香烟" style="display: none;">
                  🚬
                </button>
                <button type="button" data-icon="🍫" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="零食" style="display: none;">
                  🍫
                </button>
                <button type="button" data-icon="🧃" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="饮料" style="display: none;">
                  🧃
                </button>
                <button type="button" data-icon="🍴" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="餐具" style="display: none;">
                  🍴
                </button>
                <button type="button" data-icon="🚼️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="儿童用品" style="display: none;">
                  🚼️
                </button>
                <button type="button" data-icon="🖊️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="笔" style="display: none;">
                  🖊️
                </button>
                <button type="button" data-icon="✉️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="信封" style="display: none;">
                  ✉️
                </button>
              </div>
            </div>
            
            <div class="flex justify-end gap-3">
              <button id="cancelEditBtn" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">取消</button>
              <button id="confirmEditBtn" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">确认</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
        // 模态框逻辑
        const cancelBtn = modal.querySelector('#cancelEditBtn');
        const confirmBtn = modal.querySelector('#confirmEditBtn');
        const iconOptions = modal.querySelectorAll('.icon-option');
        const categoryBtns = modal.querySelectorAll('.category-btn');
        
        // 分类筛选功能
        categoryBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            const category = this.getAttribute('data-category');
            
            // 更新按钮状态
            categoryBtns.forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            this.classList.add('bg-primary', 'text-white');
            
            // 筛选图标
            iconOptions.forEach(option => {
              if (category === 'all' || option.getAttribute('data-category') === category) {
                option.style.display = 'block';
              } else {
                option.style.display = 'none';
              }
            });
          });
        });
        
        // 默认选中形状图标分类和物品当前的图标
        let selectedIcon = itemEmoji || '🔘';
        iconOptions.forEach(option => {
          // 如果是当前物品的图标，则添加选中状态
          if (option.getAttribute('data-icon') === selectedIcon) {
            option.classList.add('border-blue-500', 'bg-blue-50');
          }
          
          option.addEventListener('click', function() {
            iconOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
            this.classList.add('border-blue-500', 'bg-blue-50');
            selectedIcon = this.getAttribute('data-icon');
          });
        });
        
        // 自定义emoji按钮点击事件
        const customEmojiBtn = modal.querySelector('#customEmojiBtn');
        customEmojiBtn.addEventListener('click', function() {
          // 创建自定义emoji输入模态框
          const customEmojiModal = document.createElement('div');
          customEmojiModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          customEmojiModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
              <h3 class="text-lg font-bold mb-4">自定义图标</h3>
              <div class="mb-4">
                <label for="customEmojiInput" class="block text-sm font-medium text-gray-700 mb-1">输入或粘贴Emoji</label>
                <input type="text" id="customEmojiInput" class="w-full px-4 py-3 text-2xl text-center border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="😊" maxlength="2">
                <p class="text-xs text-gray-500 mt-2 text-center">输入单个或两个字符的Emoji</p>
              </div>
              <div class="flex justify-end space-x-3">
                <button id="cancelCustomEmoji" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">取消</button>
                <button id="confirmCustomEmoji" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">确认</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(customEmojiModal);
          
          // 绑定自定义emoji模态框事件
          const cancelCustomBtn = customEmojiModal.querySelector('#cancelCustomEmoji');
          const confirmCustomBtn = customEmojiModal.querySelector('#confirmCustomEmoji');
          const customEmojiInput = customEmojiModal.querySelector('#customEmojiInput');
          
          // 自动聚焦输入框
          customEmojiInput.focus();
          
          cancelCustomBtn.addEventListener('click', function() {
            document.body.removeChild(customEmojiModal);
          });
          
          confirmCustomBtn.addEventListener('click', function() {
            const customEmoji = customEmojiInput.value.trim();
            // 如果输入为空，设置默认emoji为😊
            const emojiToUse = customEmoji || '😊';
            
            // 移除所有图标的选中状态
            iconOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
            // 添加自定义图标按钮的选中状态
            customEmojiBtn.classList.add('border-blue-500', 'bg-blue-50');
            // 设置选中的图标为自定义emoji
            selectedIcon = emojiToUse;
            // 临时更新自定义图标按钮的显示
            const originalContent = customEmojiBtn.innerHTML;
            customEmojiBtn.innerHTML = emojiToUse;
            
            // 保存原始内容，以便下次打开时恢复
            customEmojiBtn.dataset.originalContent = originalContent;
            
            document.body.removeChild(customEmojiModal);
          });
          
          // 输入时移除错误样式
          customEmojiInput.addEventListener('input', function() {
            if (this.value.trim()) {
              this.classList.remove('border-red-500');
            }
          });
          
          // 按ESC键关闭模态框
          customEmojiModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              document.body.removeChild(customEmojiModal);
            }
          });
          
          // 点击模态框外部关闭
          customEmojiModal.addEventListener('click', function(e) {
            if (e.target === customEmojiModal) {
              document.body.removeChild(customEmojiModal);
            }
          });
        });
        
        // 取消按钮
          cancelBtn.addEventListener('click', function() {
            // 恢复UI元素状态
            adjustUIForModal(false);
            document.body.removeChild(modal);
          });
        
        // 确认按钮
        confirmBtn.addEventListener('click', function() {
          const name = document.getElementById('editItemName').value.trim();
          const description = document.getElementById('editItemDesc').value.trim();
          
          if (!name) {
            alert('请输入物品名称');
            return;
          }
          
          // 更新DOM元素
          const editableElements = itemElement.querySelectorAll('.editable');
          editableElements[0].textContent = name;
          editableElements[1].textContent = description || name;
          itemElement.querySelector('.mt-1.mr-3 span').textContent = selectedIcon;
          
          // 确保编辑模式状态保持正确
          if (isEditMode) {
            // 如果当前是编辑模式，确保所有编辑按钮可见
            toggleButtonMode();
            toggleButtonMode();
          }
          
          // 恢复UI元素状态
          adjustUIForModal(false);
          document.body.removeChild(modal);
        });
        
        // 按ESC键关闭模态框
        modal.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            // 恢复UI元素状态
            adjustUIForModal(false);
            document.body.removeChild(modal);
          }
        });
        
        // 点击模态框外部关闭
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            // 恢复UI元素状态
            adjustUIForModal(false);
            document.body.removeChild(modal);
          }
        });
      }
      
      // 切换按钮状态（移除了内容编辑功能）
      function toggleButtonMode() {
        const removeButtons = document.querySelectorAll('.remove-essential');
        const editButtons = document.querySelectorAll('.edit-essential');
        
        if (isEditMode) {
          // 保存模式 -> 切换到编辑模式
          editBtn.innerHTML = '<span>✏️</span>编辑';
          editBtn.classList.remove('bg-green-600', 'hover:bg-green-700', 'bg-green-700');
          editBtn.classList.add('bg-primary', 'hover:bg-primary/90');
          // 隐藏所有删除按钮
          removeButtons.forEach(btn => {
            btn.style.display = 'none';
          });
          // 隐藏所有修改按钮
          editButtons.forEach(btn => {
            btn.style.display = 'none';
          });
          // 隐藏添加按钮
          addNewItemBtn.style.display = 'none';
          isEditMode = false;
        } else {
          // 编辑模式 -> 切换到保存模式
          editBtn.innerHTML = '<span>💾</span>点击保存';
          editBtn.classList.remove('bg-primary', 'hover:bg-primary/90');
          editBtn.classList.add('bg-green-600', 'hover:bg-green-700');
          // 显示所有删除按钮
          removeButtons.forEach(btn => {
            btn.style.display = 'flex';
          });
          // 显示所有修改按钮
          editButtons.forEach(btn => {
            btn.style.display = 'flex';
          });
          // 显示添加按钮
          addNewItemBtn.style.display = 'flex';
          isEditMode = true;
        }
      }
      
      // 添加新物品按钮事件
      addNewItemBtn.addEventListener('click', function() {
        // 创建自定义模态框
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        
        // 在模态框显示时调整UI元素
        adjustUIForModal(true);
        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h3 class="text-xl font-bold mb-4">添加新物品</h3>
                        
            <div class="mb-4">
              <label for="itemListType" class="block text-sm font-bold text-gray-700 mb-1">添加到</label>
              <select id="itemListType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                <option value="essential">随身携带</option>
                <option value="luggage">行李物品</option>
              </select>
            </div>
            
            <div class="mb-4">
              <label for="itemName" class="block text-sm font-bold text-gray-700 mb-1">物品名称 <span class="text-red-500">*</span></label>
              <input type="text" id="itemName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="请输入物品名称" required>
            </div>
            
            <div class="mb-4">
              <label for="itemDescription" class="block text-sm font-bold text-gray-700 mb-1">物品描述</label>
              <textarea id="itemDescription" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" rows="2" placeholder="请输入物品描述"></textarea>
            </div>
            
            <div class="mb-4">
              <label class="block text-sm font-bold text-gray-700 mb-1">选择图标</label>
              
              <!-- 分类选项栏 -->
              <div class="flex flex-wrap gap-2 mb-3" id="iconCategories">
                <button type="button" id="customEmojiBtn" data-category="all" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm border-2 border-dashed border-gray-300">
                  <span class="inline-block mr-1">✏️</span>自定义
                </button>
                <button type="button" data-category="shapes" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">形状图标</button>
                <button type="button" data-category="clothing" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">衣物服饰</button>
                <button type="button" data-category="accessories" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">配饰</button>
                <button type="button" data-category="shoes" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">鞋子</button>
                <button type="button" data-category="bags" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">箱包用品</button>
                <button type="button" data-category="electronics" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">电子设备</button>
                <button type="button" data-category="documents" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">证件财务</button>
                <button type="button" data-category="medical" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">护理医疗</button>
                <button type="button" data-category="leisure" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">休闲装备</button>
                <button type="button" data-category="other" class="category-btn px-3 py-1 rounded-full bg-gray-200 hover:bg-gray-300 text-sm">其他用品</button>
              </div>
              
              <!-- 图标网格 -->
              <div class="grid grid-cols-5 gap-2 mb-2 max-h-[10rem] overflow-y-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100" id="iconSelector">
                <!-- 形状图标类 -->
                <button type="button" data-icon="🔘" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="单选框">
                  🔘
                </button>
                <button type="button" data-icon="🔴" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="红色圆">
                  🔴
                </button>
                <button type="button" data-icon="🟠" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="橙色圆">
                  🟠
                </button>
                <button type="button" data-icon="🟡" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="黄色圆">
                  🟡
                </button>
                <button type="button" data-icon="🟢" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="绿色圆">
                  🟢
                </button>
                <button type="button" data-icon="🔵" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="蓝色圆">
                  🔵
                </button>
                <button type="button" data-icon="🟣" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="紫色圆">
                  🟣
                </button>
                <button type="button" data-icon="🟤" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="棕色圆">
                  🟤
                </button>
                <button type="button" data-icon="🟥" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="红色方块">
                  🟥
                </button>
                <button type="button" data-icon="🟧" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="橙色方块">
                  🟧
                </button>
                <button type="button" data-icon="🟨" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="黄色方块">
                  🟨
                </button>
                <button type="button" data-icon="🟩" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="绿色方块">
                  🟩
                </button>
                <button type="button" data-icon="🟦" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="蓝色方块">
                  🟦
                </button>
                <button type="button" data-icon="🟪" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="紫色方块">
                  🟪
                </button>
                <button type="button" data-icon="🟫" data-category="shapes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="棕色方块">
                  🟫
                </button>
                
                <!-- 衣物服饰类 -->
                <button type="button" data-icon="🥼" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="风衣">
                  🥼
                </button>
                <button type="button" data-icon="👔" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="男装">
                  👔
                </button>
                <button type="button" data-icon="👕" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="T恤">
                  👕
                </button>
                <button type="button" data-icon="👖" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="长裤">
                  👖
                </button>
                <button type="button" data-icon="🩳" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="短裤">
                  🩳
                </button>
                <button type="button" data-icon="🧣" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="围巾">
                  🧣
                </button>
                <button type="button" data-icon="🧤" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手套">
                  🧤
                </button>
                <button type="button" data-icon="🧥" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="外套">
                  🧥
                </button>
                <button type="button" data-icon="👗" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="连衣裙">
                  👗
                </button>
                <button type="button" data-icon="🩱" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="连体泳衣">
                  🩱
                </button>
                <button type="button" data-icon="🩲" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="泳裤">
                  🩲
                </button>
                <button type="button" data-icon="👙" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="比基尼">
                  👙
                </button>
                <button type="button" data-icon="👚" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女装">
                  👚
                </button>
                <button type="button" data-icon="🎽" data-category="clothing" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="运动背心">
                  🎽
                </button>
                
                <!-- 饰品类 -->
                <button type="button" data-icon="👓️" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="眼镜">
                  👓️
                </button>
                <button type="button" data-icon="🕶️" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="墨镜">
                  🕶️
                </button>
                <button type="button" data-icon="🥽" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="护目镜">
                  🥽
                </button>
                <button type="button" data-icon="💍" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="饰品">
                  💍
                </button>
                <button type="button" data-icon="🧢" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="帽子">
                  🧢
                </button>
                <button type="button" data-icon="👒" data-category="accessories" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="遮阳帽">
                  👒
                </button>
                
                <!-- 鞋子类 -->
                <button type="button" data-icon="🧦" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="袜子">
                  🧦
                </button>
                <button type="button" data-icon="👞" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="男鞋">
                  👞
                </button>
                <button type="button" data-icon="👟" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="跑鞋">
                  👟
                </button>
                <button type="button" data-icon="🥾" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="登山鞋">
                  🥾
                </button>
                <button type="button" data-icon="🥿" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="平底鞋">
                  🥿
                </button>
                <button type="button" data-icon="👠" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="高跟鞋">
                  👠
                </button>
                <button type="button" data-icon="👡" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女式凉鞋">
                  👡
                </button>
                <button type="button" data-icon="👢" data-category="shoes" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="女靴">
                  👢
                </button>
                
                <!-- 箱包用品类 -->
                <button type="button" data-icon="👛" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钱包">
                  👛
                </button>
                <button type="button" data-icon="👜" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手提包">
                  👜
                </button>
                <button type="button" data-icon="👝" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手袋">
                  👝
                </button>
                <button type="button" data-icon="🎒" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="背包">
                  🎒
                </button>
                <button type="button" data-icon="💼" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="公文包">
                  💼
                </button>
                <button type="button" data-icon="🧳" data-category="bags" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="行李箱">
                  🧳
                </button>
                
                <!-- 电子设备类 -->
                <button type="button" data-icon="📱" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手机">
                  📱
                </button>
                <button type="button" data-icon="🔋" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="充电宝">
                  🔋
                </button>
                <button type="button" data-icon="🔌" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="充电器">
                  🔌
                </button>
                <button type="button" data-icon="💻️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="笔记本电脑">
                  💻️
                </button>
                <button type="button" data-icon="📷️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="相机">
                  📷️
                </button>
                <button type="button" data-icon="⌚️" data-category="electronics" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手表">
                  ⌚️
                </button>
                
                <!-- 证件财务类 -->
                <button type="button" data-icon="🆔" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="票据">
                  🆔
                <button type="button" data-icon="🎫" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="票据">
                  🎫
                </button>
                <button type="button" data-icon="🎟️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="入场卷">
                  🎟️
                </button>
                <button type="button" data-icon="📕" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="证件">
                  📕
                </button>
                <button type="button" data-icon="📄" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="文件">
                  📄
                </button>
                <button type="button" data-icon="📑" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="证明">
                  📑
                </button>
                <button type="button" data-icon="💳️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="银行卡">
                  💳️
                </button>
                <button type="button" data-icon="💰️" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="现金">
                  💰️
                </button>
                <button type="button" data-icon="💵" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="美元">
                  💵
                </button>
                <button type="button" data-icon="💶" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="欧元">
                  💶
                </button>
                <button type="button" data-icon="💴" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="日元">
                  💴
                </button>
                <button type="button" data-icon="💷" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="英镑">
                  💷
                </button>
                <button type="button" data-icon="💱" data-category="documents" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="外汇">
                  💱
                </button>
                
                <!-- 护理医疗类 -->
                <button type="button" data-icon="💊" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="药丸">
                  💊
                </button>
                <button type="button" data-icon="🩹" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="创可贴">
                  🩹
                </button>
                <button type="button" data-icon="🧴" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="乳液">
                  🧴
                </button>
                <button type="button" data-icon="🧻" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="纸巾">
                  🧻
                </button>
                <button type="button" data-icon="🧼" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="肥皂">
                  🧼
                </button>
                <button type="button" data-icon="🪒" data-category="medical" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="剃须刀">
                  🪒
                </button>
                
                <!-- 休闲装备类 -->
                <button type="button" data-icon="🎣" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钓鱼竿">
                  🎣
                </button>
                <button type="button" data-icon="🎮️" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="游戏手柄">
                  🎮️
                </button>
                <button type="button" data-icon="🪁" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="风筝">
                  🪁
                </button>
                <button type="button" data-icon="🎲" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="骰子">
                  🎲
                </button>
                <button type="button" data-icon="🧸" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="玩偶">
                  🧸
                </button>
                <button type="button" data-icon="🃏" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="扑克">
                  🃏
                </button>
                <button type="button" data-icon="🀄️" data-category="leisure" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="麻将">
                  🀄️
                </button>
                
                <!-- 其他用品类 -->
                <button type="button" data-icon="🧵" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="针线">
                  🧵
                </button>
                <button type="button" data-icon="🔒️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="锁">
                  🔒️
                </button>
                <button type="button" data-icon="🔑" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="钥匙">
                  🔑
                </button>
                <button type="button" data-icon="🔦" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="手电筒">
                  🔦
                </button>
                <button type="button" data-icon="🚬" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="香烟">
                  🚬
                </button>
                <button type="button" data-icon="🍫" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="零食">
                  🍫
                </button>
                <button type="button" data-icon="🧃" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="饮料">
                  🧃
                </button>
                <button type="button" data-icon="🍴" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="餐具">
                  🍴
                </button>
                <button type="button" data-icon="🚼️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="儿童用品">
                  🚼️
                </button>
                <button type="button" data-icon="🖊️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="笔">
                  🖊️
                </button>
                <button type="button" data-icon="✉️" data-category="other" class="icon-option p-2 rounded-md hover:bg-gray-100 text-gray-500 border-2 border-transparent hover:border-blue-300" title="信封">
                  ✉️
                </button>
              </div>
            </div>
            
            <div class="flex justify-end space-x-3">
              <button id="cancelAdd" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">取消</button>
              <button id="confirmAdd" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">确认</button>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        // 绑定事件
        const cancelBtn = modal.querySelector('#cancelAdd');
        const confirmBtn = modal.querySelector('#confirmAdd');
        const itemNameInput = modal.querySelector('#itemName');
        const itemDescriptionInput = modal.querySelector('#itemDescription');
        const iconOptions = modal.querySelectorAll('.icon-option');
        const categoryBtns = modal.querySelectorAll('.category-btn');
        
        let selectedIcon = '🔘';
        
        // 默认选中形状图标分类和其下的第一个图标
        // 1. 选中形状图标分类按钮
        const shapesCategoryBtn = modal.querySelector('[data-category="shapes"]');
        if (shapesCategoryBtn) {
          // 移除所有分类按钮的选中状态
          categoryBtns.forEach(b => {
            b.classList.remove('bg-primary', 'text-white');
            b.classList.add('bg-gray-200', 'hover:bg-gray-300');
          });
          // 添加形状图标分类按钮的选中状态
          shapesCategoryBtn.classList.remove('bg-gray-200', 'hover:bg-gray-300');
          shapesCategoryBtn.classList.add('bg-primary', 'text-white');
        }
        
        // 2. 默认选中形状图标分类下的第一个图标
        const firstShapeIcon = modal.querySelector('[data-category="shapes"].icon-option');
        if (firstShapeIcon) {
          firstShapeIcon.classList.add('border-blue-500', 'bg-blue-50');
        }
        
        // 3. 根据形状图标分类筛选显示图标
        iconOptions.forEach(option => {
          if (option.dataset.category === 'shapes') {
            option.style.display = 'block';
          } else {
            option.style.display = 'none';
          }
        });
        
        // 图标选择事件
        iconOptions.forEach(option => {
          option.addEventListener('click', function() {
            // 移除所有图标的选中状态
            iconOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
            // 添加当前图标的选中状态
            this.classList.add('border-blue-500', 'bg-blue-50');
            selectedIcon = this.dataset.icon;
          });
        });
        
        // 自定义emoji按钮点击事件
        const customEmojiBtn = modal.querySelector('#customEmojiBtn');
        customEmojiBtn.addEventListener('click', function() {
          // 创建自定义emoji输入模态框
          const customEmojiModal = document.createElement('div');
          customEmojiModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
          customEmojiModal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
              <h3 class="text-lg font-bold mb-4">自定义图标</h3>
              <div class="mb-4">
                <label for="customEmojiInput" class="block text-sm font-medium text-gray-700 mb-1">输入或粘贴Emoji</label>
                <input type="text" id="customEmojiInput" class="w-full px-4 py-3 text-2xl text-center border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" placeholder="😊" maxlength="2">
                <p class="text-xs text-gray-500 mt-2 text-center">输入单个或两个字符的Emoji</p>
              </div>
              <div class="flex justify-end space-x-3">
                <button id="cancelCustomEmoji" class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-100 transition-colors">取消</button>
                <button id="confirmCustomEmoji" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90 transition-colors">确认</button>
              </div>
            </div>
          `;
          
          document.body.appendChild(customEmojiModal);
          
          // 绑定自定义emoji模态框事件
          const cancelCustomBtn = customEmojiModal.querySelector('#cancelCustomEmoji');
          const confirmCustomBtn = customEmojiModal.querySelector('#confirmCustomEmoji');
          const customEmojiInput = customEmojiModal.querySelector('#customEmojiInput');
          
          // 自动聚焦输入框
          customEmojiInput.focus();
          
          cancelCustomBtn.addEventListener('click', function() {
            document.body.removeChild(customEmojiModal);
          });
          
          confirmCustomBtn.addEventListener('click', function() {
            const customEmoji = customEmojiInput.value.trim();
            // 如果输入为空，设置默认emoji为😊
            const emojiToUse = customEmoji || '😊';
            
            // 移除所有图标的选中状态
            iconOptions.forEach(opt => opt.classList.remove('border-blue-500', 'bg-blue-50'));
            // 添加自定义图标按钮的选中状态
            customEmojiBtn.classList.add('border-blue-500', 'bg-blue-50');
            // 设置选中的图标为自定义emoji
            selectedIcon = emojiToUse;
            // 临时更新自定义图标按钮的显示
            const originalContent = customEmojiBtn.innerHTML;
            customEmojiBtn.innerHTML = emojiToUse;
            
            // 保存原始内容，以便下次打开时恢复
            customEmojiBtn.dataset.originalContent = originalContent;
            
            document.body.removeChild(customEmojiModal);
          });
          
          // 输入时移除错误样式
          customEmojiInput.addEventListener('input', function() {
            if (this.value.trim()) {
              this.classList.remove('border-red-500');
            }
          });
          
          // 按ESC键关闭模态框
          customEmojiModal.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
              document.body.removeChild(customEmojiModal);
            }
          });
          
          // 点击模态框外部关闭
          customEmojiModal.addEventListener('click', function(e) {
            if (e.target === customEmojiModal) {
              document.body.removeChild(customEmojiModal);
            }
          });
        });
        
        // 分类选择事件
        categoryBtns.forEach(btn => {
          btn.addEventListener('click', function() {
            // 跳过自定义emoji按钮的分类选择逻辑
            if (this.id === 'customEmojiBtn') {
              return;
            }
            
            // 移除所有分类按钮的选中状态
            categoryBtns.forEach(b => {
              b.classList.remove('bg-primary', 'text-white');
              b.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            // 添加当前分类按钮的选中状态
            this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            this.classList.add('bg-primary', 'text-white');
            
            const category = this.dataset.category;
            
            // 根据选择的分类筛选图标
            iconOptions.forEach(option => {
              if (option.dataset.category === category) {
                option.style.display = 'block';
              } else {
                option.style.display = 'none';
              }
            });
          });
        });
        
        cancelBtn.addEventListener('click', function() {
          // 恢复UI元素状态
          adjustUIForModal(false);
          document.body.removeChild(modal);
        });
        
        confirmBtn.addEventListener('click', function() {
          const name = itemNameInput.value.trim();
          let description = itemDescriptionInput.value.trim();
          const listType = modal.querySelector('#itemListType').value;
          
          // 必填项验证
          if (!name) {
            itemNameInput.classList.add('border-red-500');
            itemNameInput.focus();
            return;
          }
          
          // 如果描述为空，自动填充名称
          if (!description) {
            description = name;
          }
          
          // 根据选择的列表类型，选择对应的DOM元素
          const targetList = listType === 'essential' ? essentialsList : luggageList;
          // 构建完整的图标类
          const iconClass = `mt-1 mr-3`;
          // 调用添加函数但不自动保存
          addEssentialToList(name, description, iconClass, false, targetList, selectedIcon);
          
          // 确保编辑模式状态保持正确
          if (isEditMode) {
            // 如果当前是编辑模式，确保所有编辑按钮可见
            toggleButtonMode();
            toggleButtonMode();
          }
          
          // 恢复UI元素状态
          adjustUIForModal(false);
          document.body.removeChild(modal);
        });
        
        // 物品名称输入时移除错误样式
        itemNameInput.addEventListener('input', function() {
          if (this.value.trim()) {
            this.classList.remove('border-red-500');
          }
        });
        
        // 按ESC键关闭模态框
        modal.addEventListener('keydown', function(e) {
          if (e.key === 'Escape') {
            // 恢复UI元素状态
            adjustUIForModal(false);
            document.body.removeChild(modal);
          }
        });
        
        // 点击模态框外部关闭
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            // 恢复UI元素状态
            adjustUIForModal(false);
            document.body.removeChild(modal);
          }
        });
      });
      
      // 编辑/保存按钮事件
      editBtn.addEventListener('click', function() {
        if (isEditMode) {
          // 保存模式 - 执行保存操作
          saveEssentials();
        } else {
          // 点击编辑按钮，切换到保存模式并显示添加按钮
          toggleButtonMode();
        }
      });
      
      // 为静态HTML中的编辑按钮绑定事件监听器
      function bindStaticEditButtons() {
        // 为随身携带列表中的编辑按钮绑定事件
        document.querySelectorAll('#essentials .edit-essential').forEach(btn => {
          const li = btn.closest('li');
          btn.addEventListener('click', function() {
            editEssentialItem(li, 'essential');
          });
        });
        
        // 为行李物品列表中的编辑按钮绑定事件
        document.querySelectorAll('#luggage-items .edit-essential').forEach(btn => {
          const li = btn.closest('li');
          btn.addEventListener('click', function() {
            editEssentialItem(li, 'luggage');
          });
        });
      }
      
      // 加载保存的数据
      loadEssentials();
      
      // 为静态HTML中的编辑按钮绑定事件监听器
      bindStaticEditButtons();
    });

    // 页面加载完成后，处理路线方案的显示逻辑
    document.addEventListener('DOMContentLoaded', function() {
      // 获取所有包含路线方案的editable元素
      const editableElements = document.querySelectorAll('.editable');
      
      // 显示所有路线方案
      function displayAllPlans() {
        const allRoutePlans = document.querySelectorAll('.route-plan');
        allRoutePlans.forEach(plan => {
          plan.style.display = 'block';
        });
        console.log('已显示所有路线方案');
      }
      
      // 根据开关决定是否应用隐藏逻辑
      if (showAllRoutePlans) {
        // 显示所有路线方案
        displayAllPlans();
      } else {
        // 新逻辑：隐藏总耗时最长的方案
        editableElements.forEach(element => {
          // 查找当前editable元素中的所有路线方案
          const routePlans = element.querySelectorAll('.route-plan');
          
          // 只有当存在多个路线方案时才进行处理
          if (routePlans.length > 1) {
            // 先显示所有方案
            routePlans.forEach(plan => {
              plan.style.display = 'block';
            });
            
            const plansWithDuration = [];
            
            // 提取每个方案的耗时信息
            routePlans.forEach(plan => {
              const header = plan.querySelector('.route-header strong');
              if (header) {
                // 匹配"总耗时约XX分钟"格式
                const durationMatch = header.textContent.match(/⏱️总耗时约(\d+)分钟/);
                if (durationMatch && durationMatch[1]) {
                  const duration = parseInt(durationMatch[1]);
                  if (!isNaN(duration)) {
                    plansWithDuration.push({ plan, duration });
                  }
                }
              }
            });
            
            // 如果成功提取了至少两个方案的耗时，才进行排序和隐藏
            if (plansWithDuration.length >= 2) {
              // 按耗时从长到短排序
              plansWithDuration.sort((a, b) => b.duration - a.duration);
              
              // 隐藏耗时最长的方案
              plansWithDuration[0].plan.style.display = 'none';
              console.log(`隐藏了耗时最长的路线方案，耗时${plansWithDuration[0].duration}分钟`);
            }
          }
        });
      }
      
      // 计算下一地点的到达时间
      calculateNextLocationArrivalTimes();
    });
    
    // 计算下一地点到达时间的函数
    function calculateNextLocationArrivalTimes() {
      // 获取所有包含地点信息的has-controls元素
      const locationControls = document.querySelectorAll('.has-controls');
      
      // 遍历每个地点，计算下一地点的到达时间
      for (let i = 0; i < locationControls.length - 1; i++) {
        const currentLocation = locationControls[i];
        const nextLocation = locationControls[i + 1];
        
        // 获取当前地点的结束时间
        const currentEndTimeElement = currentLocation.querySelector('h4 .text-gray-600 span:last-child');
        if (!currentEndTimeElement) continue;
        
        const currentEndTime = currentEndTimeElement.textContent.trim();
        
        // 获取当前地点和下一地点之间的路线方案区域
        const routeContainer = currentLocation.nextElementSibling;
        if (!routeContainer || !routeContainer.querySelector('.editable')) continue;
        
        // 获取当前显示的路线方案中的最长耗时
        const visibleRoutePlans = routeContainer.querySelectorAll('.route-plan[style*="display: block"]');
        let maxDuration = 0;
        
        visibleRoutePlans.forEach(plan => {
          const header = plan.querySelector('.route-header strong');
          if (header) {
            const durationMatch = header.textContent.match(/⏱️总耗时约(\d+)分钟/);
            if (durationMatch && durationMatch[1]) {
              const duration = parseInt(durationMatch[1]);
              if (!isNaN(duration) && duration > maxDuration) {
                maxDuration = duration;
              }
            }
          }
        });
        
        // 如果找到了最长耗时，计算到达时间
        if (maxDuration > 0) {
          const arrivalTime = addMinutesToTime(currentEndTime, maxDuration);
          
          // 更新下一地点的开始时间（到达时间）
          const nextStartTimeElement = nextLocation.querySelector('h4 .text-gray-600 span:first-child');
          if (nextStartTimeElement) {
            // 保存原始时间用于恢复
            if (!nextStartTimeElement.dataset.originalTime) {
              nextStartTimeElement.dataset.originalTime = nextStartTimeElement.textContent.trim();
            }
            // 更新为计算的到达时间
            nextStartTimeElement.textContent = arrivalTime;
          }
        }
      }
    }
    
    // 将分钟数添加到时间字符串的辅助函数
    function addMinutesToTime(timeStr, minutesToAdd) {
      // 解析时间字符串
      const [hours, minutes] = timeStr.split(':').map(Number);
      
      // 计算总分钟数
      let totalMinutes = hours * 60 + minutes + minutesToAdd;
      
      // 转换回小时和分钟
      let newHours = Math.floor(totalMinutes / 60) % 24;
      let newMinutes = totalMinutes % 60;
      
      // 调整分钟数末位：1-5变为5，6-9变为10
      const lastDigit = newMinutes % 10;
      if (lastDigit > 0) {
        if (lastDigit <= 5) {
          newMinutes = newMinutes - lastDigit + 5;
        } else {
          newMinutes = newMinutes - lastDigit + 10;
          // 如果分钟数调整后达到60，需要进位
          if (newMinutes === 60) {
            newMinutes = 0;
            newHours = (newHours + 1) % 24;
          }
        }
      }
      
      // 格式化输出
      return `${String(newHours).padStart(2, '0')}:${String(newMinutes).padStart(2, '0')}`;
    }
</script>
</body>
</html>
